<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>datalad.utils &mdash; DataLad 0.15.3+529.gc81453444.dirty documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> DataLad
            <img src="../../_static/datalad_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.15
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgements.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../background.html">Background and motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../related.html">Delineation from related solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basics.html">Basic principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credentials.html">Credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../customization.html">Customization and extension of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/index.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cmdline.html">Command line reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modref.html">Python module reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DataLad</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>datalad.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for datalad.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># emacs: -*- mode: python; py-indent-offset: 4; tab-width: 4; indent-tabs-mode: nil -*-</span>
<span class="c1"># ex: set sts=4 ts=4 sw=4 et:</span>
<span class="c1"># ## ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##</span>
<span class="c1">#</span>
<span class="c1">#   See COPYING file distributed along with the datalad package for the</span>
<span class="c1">#   copyright and license terms.</span>
<span class="c1">#</span>
<span class="c1"># ## ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span> <span class="k">as</span> <span class="n">shallow_copy</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">lru_cache</span><span class="p">,</span>
    <span class="n">wraps</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">tee</span>
<span class="c1"># this import is required because other modules import opj from here.</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">abspath</span><span class="p">,</span>
    <span class="n">basename</span><span class="p">,</span>
    <span class="n">commonprefix</span><span class="p">,</span>
    <span class="n">curdir</span><span class="p">,</span>
    <span class="n">dirname</span><span class="p">,</span>
    <span class="n">exists</span><span class="p">,</span>
    <span class="n">expanduser</span><span class="p">,</span>
    <span class="n">expandvars</span><span class="p">,</span>
    <span class="n">isabs</span><span class="p">,</span>
    <span class="n">isdir</span><span class="p">,</span>
    <span class="n">islink</span><span class="p">,</span>
    <span class="n">lexists</span><span class="p">,</span>
    <span class="n">normpath</span><span class="p">,</span>
    <span class="n">pardir</span><span class="p">,</span>
    <span class="n">relpath</span><span class="p">,</span>
    <span class="n">sep</span><span class="p">,</span>
    <span class="n">split</span><span class="p">,</span>
    <span class="n">splitdrive</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">posixpath</span>

<span class="kn">from</span> <span class="nn">shlex</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">quote</span> <span class="k">as</span> <span class="n">shlex_quote</span><span class="p">,</span>
    <span class="n">split</span> <span class="k">as</span> <span class="n">shlex_split</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># from datalad.dochelpers import get_docstring_split</span>
<span class="kn">from</span> <span class="nn">datalad.consts</span> <span class="kn">import</span> <span class="n">TIMESTAMP_FMT</span>
<span class="kn">from</span> <span class="nn">datalad.support.exceptions</span> <span class="kn">import</span> <span class="n">CapturedException</span>


<span class="n">unicode_srctypes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span>


<span class="n">lgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;datalad.utils&quot;</span><span class="p">)</span>

<span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Importing datalad.utils&quot;</span><span class="p">)</span>
<span class="c1">#</span>
<span class="c1"># Some useful variables</span>
<span class="c1">#</span>
<span class="n">platform_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="n">on_windows</span> <span class="o">=</span> <span class="n">platform_system</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span>
<span class="n">on_osx</span> <span class="o">=</span> <span class="n">platform_system</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span>
<span class="n">on_linux</span> <span class="o">=</span> <span class="n">platform_system</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span>
<span class="n">on_msys_tainted_paths</span> <span class="o">=</span> <span class="n">on_windows</span> \
                        <span class="ow">and</span> <span class="s1">&#39;MSYS_NO_PATHCONV&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> \
                        <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MSYSTEM&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MSYS&#39;</span><span class="p">,</span> <span class="s1">&#39;MING&#39;</span><span class="p">)</span>


<span class="c1"># Takes ~200msec, so should not be called at import time</span>
<div class="viewcode-block" id="get_linux_distribution"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_linux_distribution">[docs]</a><span class="nd">@lru_cache</span><span class="p">()</span>  <span class="c1"># output should not change through life time of datalad process</span>
<span class="k">def</span> <span class="nf">get_linux_distribution</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Compatibility wrapper for {platform,distro}.linux_distribution().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="s2">&quot;linux_distribution&quot;</span><span class="p">):</span>
        <span class="c1"># Use deprecated (but faster) method if it&#39;s available.</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">distro</span>  <span class="c1"># We require this for Python 3.8 and above.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">distro</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">(</span><span class="n">full_distribution_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># Those weren&#39;t used for any critical decision making, thus we just set them to None</span>
<span class="c1"># Use get_linux_distribution() directly where needed</span>
<span class="n">linux_distribution_name</span> <span class="o">=</span> <span class="n">linux_distribution_release</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Maximal length of cmdline string</span>
<span class="c1"># Query the system and use hardcoded &quot;knowledge&quot; if None</span>
<span class="c1"># probably   getconf ARG_MAX   might not be available</span>
<span class="c1"># The last one would be the most conservative/Windows</span>
<span class="n">CMD_MAX_ARG_HARDCODED</span> <span class="o">=</span> <span class="mi">2097152</span> <span class="k">if</span> <span class="n">on_linux</span> <span class="k">else</span> <span class="mi">262144</span> <span class="k">if</span> <span class="n">on_osx</span> <span class="k">else</span> <span class="mi">32767</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">CMD_MAX_ARG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s1">&#39;SC_ARG_MAX&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">CMD_MAX_ARG</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">CMD_MAX_ARG</span> <span class="o">&gt;</span> <span class="n">CMD_MAX_ARG_HARDCODED</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">:</span>
        <span class="c1"># workaround for some kind of a bug which comes up with python 3.4</span>
        <span class="c1"># see https://github.com/datalad/datalad/issues/3150</span>
        <span class="c1"># or on older CentOS with conda and python as new as 3.9</span>
        <span class="c1"># see https://github.com/datalad/datalad/issues/5943</span>
        <span class="c1"># TODO: let Yarik know that the world is a paradise now whenever 1e6</span>
        <span class="c1"># is not large enough</span>
        <span class="n">CMD_MAX_ARG</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CMD_MAX_ARG</span><span class="p">,</span> <span class="n">CMD_MAX_ARG_HARDCODED</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="c1"># ATM (20181005) SC_ARG_MAX available only on POSIX systems</span>
    <span class="c1"># so exception would be thrown e.g. on Windows, or</span>
    <span class="c1"># somehow during Debian build for nd14.04 it is coming up with -1:</span>
    <span class="c1"># https://github.com/datalad/datalad/issues/3015</span>
    <span class="n">CMD_MAX_ARG</span> <span class="o">=</span> <span class="n">CMD_MAX_ARG_HARDCODED</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Failed to query or got useless SC_ARG_MAX sysconf, &quot;</span>
        <span class="s2">&quot;will use hardcoded value: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
<span class="c1"># Even with all careful computations we do, due to necessity to account for</span>
<span class="c1"># environment and what not, we still could not figure out &quot;exact&quot; way to</span>
<span class="c1"># estimate it, but it was shown that 300k safety margin on linux was sufficient.</span>
<span class="c1"># https://github.com/datalad/datalad/pull/2977#issuecomment-436264710</span>
<span class="c1"># 300k is ~15%, so to be safe, and for paranoid us we will just use up to 50%</span>
<span class="c1"># of the length for &quot;safety margin&quot;.  We might probably still blow due to</span>
<span class="c1"># env vars, unicode, etc...  so any hard limit imho is not a proper solution</span>
<span class="n">CMD_MAX_ARG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">CMD_MAX_ARG</span><span class="p">)</span>
<span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
    <span class="s2">&quot;Maximal length of cmdline string (adjusted for safety margin): </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">CMD_MAX_ARG</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Little helpers</span>
<span class="c1">#</span>

<span class="c1"># `getargspec` has been deprecated in Python 3.</span>
<span class="n">ArgSpecFake</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;ArgSpecFake&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;varargs&quot;</span><span class="p">,</span> <span class="s2">&quot;keywords&quot;</span><span class="p">,</span> <span class="s2">&quot;defaults&quot;</span><span class="p">])</span>


<span class="c1"># adding cache here somehow does break it -- even &#39;datalad wtf&#39; does not run</span>
<span class="c1"># @lru_cache()  # signatures stay the same, why to &quot;redo&quot;? brings it into ns from mks</span>
<div class="viewcode-block" id="getargspec"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.getargspec">[docs]</a><span class="k">def</span> <span class="nf">getargspec</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_kwonlyargs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compat shim for getargspec deprecated in python 3.</span>

<span class="sd">    The main difference from inspect.getargspec (and inspect.getfullargspec</span>
<span class="sd">    for that matter) is that by using inspect.signature we are providing</span>
<span class="sd">    correct args/defaults for functools.wraps&#39;ed functions.</span>

<span class="sd">    `include_kwonlyargs` option was added to centralize getting all args,</span>
<span class="sd">    even the ones which are kwonly (follow the ``*,``).</span>

<span class="sd">    For internal use and not advised for use in 3rd party code.</span>
<span class="sd">    Please use inspect.signature directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We use signature, and not getfullargspec, because only signature properly</span>
    <span class="c1"># &quot;passes&quot; args from a functools.wraps decorated function.</span>
    <span class="c1"># Note: getfullargspec works Ok on wrapt-decorated functions</span>
    <span class="n">f_sign</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="c1"># Loop through parameters and compose argspec</span>
    <span class="n">args4</span> <span class="o">=</span> <span class="p">[[],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{}]</span>
    <span class="c1"># Collect all kwonlyargs into a dedicated dict - name: default</span>
    <span class="n">kwonlyargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># shortcuts</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">defaults</span> <span class="o">=</span> <span class="n">args4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span>

    <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f_sign</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">):</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwonlyargs</span>  <span class="c1"># yoh: must not come after kwonlyarg</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">P</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span>
        <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">P</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
            <span class="n">args4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_name</span>
        <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">P</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
            <span class="n">args4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_name</span>
        <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">P</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">P</span><span class="o">.</span><span class="n">empty</span>
            <span class="n">kwonlyargs</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span>

    <span class="k">if</span> <span class="n">kwonlyargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_kwonlyargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Function has keyword-only parameters or annotations, either use &#39;</span>
                <span class="s1">&#39;inspect.signature() API which can support them, or provide include_kwonlyargs=True &#39;</span>
                <span class="s1">&#39;to this function&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kwonlyargs</span><span class="p">))</span>
            <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwonlyargs</span><span class="p">)</span>

    <span class="c1"># harmonize defaults to how original getargspec returned them -- just a tuple</span>
    <span class="n">args4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">defaults</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ArgSpecFake</span><span class="p">(</span><span class="o">*</span><span class="n">args4</span><span class="p">)</span></div>


<span class="c1"># Definitions to be (re)used in the next function</span>
<span class="n">_SIG_P</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span>
<span class="n">_SIG_KIND_SELECTORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;pos_only&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_SIG_P</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span><span class="p">,},</span>
    <span class="s1">&#39;pos_any&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_SIG_P</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span><span class="p">,</span> <span class="n">_SIG_P</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">},</span>
    <span class="s1">&#39;kw_any&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_SIG_P</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">,</span> <span class="n">_SIG_P</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">},</span>
    <span class="s1">&#39;kw_only&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_SIG_P</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">,},</span>
<span class="p">}</span>
<span class="n">_SIG_KIND_SELECTORS</span><span class="p">[</span><span class="s1">&#39;any&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">_SIG_KIND_SELECTORS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>


<div class="viewcode-block" id="get_sig_param_names"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_sig_param_names">[docs]</a><span class="nd">@lru_cache</span><span class="p">()</span>  <span class="c1"># signatures stay the same, why to &quot;redo&quot;? brings it into ns from mks</span>
<span class="k">def</span> <span class="nf">get_sig_param_names</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">kinds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A helper to selectively return parameters from inspect.signature.</span>

<span class="sd">    inspect.signature is the ultimate way for introspecting callables.  But</span>
<span class="sd">    its interface is not so convenient for a quick selection of parameters</span>
<span class="sd">    (AKA arguments) of desired type or combinations of such.  This helper</span>
<span class="sd">    should make it easier to retrieve desired collections of parameters.</span>

<span class="sd">    Since often it is desired to get information about multiple specific types</span>
<span class="sd">    of parameters, `kinds` is a list, so in a single invocation of `signature`</span>
<span class="sd">    and looping through the results we can obtain all information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f: callable</span>
<span class="sd">    kinds: tuple with values from {&#39;pos_any&#39;, &#39;pos_only&#39;, &#39;kw_any&#39;, &#39;kw_only&#39;, &#39;any&#39;}</span>
<span class="sd">      Is a list of what kinds of args to return in result (tuple). Each element</span>
<span class="sd">      should be one of: &#39;any_pos&#39; - positional or keyword which could be used</span>
<span class="sd">      positionally. &#39;kw_only&#39; - keyword only (cannot be used positionally) arguments,</span>
<span class="sd">      &#39;any_kw` - any keyword (could be a positional which could be used as a keyword),</span>
<span class="sd">      `any` -- any type from the above.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple:</span>
<span class="sd">      Each element is a list of parameters (names only) of that &quot;kind&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">selectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_SIG_KIND_SELECTORS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown &#39;kind&#39; </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">. Known are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_SIG_KIND_SELECTORS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">selectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_SIG_KIND_SELECTORS</span><span class="p">[</span><span class="n">kind</span><span class="p">])</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">selector</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selectors</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="any_re_search"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.any_re_search">[docs]</a><span class="k">def</span> <span class="nf">any_re_search</span><span class="p">(</span><span class="n">regexes</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return if any of regexes (list or str) searches successfully for value&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">regex</span> <span class="ow">in</span> <span class="n">ensure_tuple_or_list</span><span class="p">(</span><span class="n">regexes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="not_supported_on_windows"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.not_supported_on_windows">[docs]</a><span class="k">def</span> <span class="nf">not_supported_on_windows</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A little helper to be invoked to consistently fail whenever functionality is</span>
<span class="sd">    not supported (yet) on Windows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This functionality is not yet implemented for Windows OS&quot;</span>
                                  <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_home_envvars"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_home_envvars">[docs]</a><span class="k">def</span> <span class="nf">get_home_envvars</span><span class="p">(</span><span class="n">new_home</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return dict with env variables to be adjusted for a new HOME</span>

<span class="sd">    Only variables found in current os.environ are adjusted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    new_home: str or Path</span>
<span class="sd">      New home path, in native to OS &quot;schema&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_home</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_home</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HOME&#39;</span><span class="p">:</span> <span class="n">new_home</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
        <span class="c1"># requires special handling, since it has a number of relevant variables</span>
        <span class="c1"># and also Python changed its behavior and started to respect USERPROFILE only</span>
        <span class="c1"># since python 3.8: https://bugs.python.org/issue36264</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;USERPROFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_home</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;HOMEDRIVE&#39;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;HOMEPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">splitdrive</span><span class="p">(</span><span class="n">new_home</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">}</span></div>


<div class="viewcode-block" id="shortened_repr"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.shortened_repr">[docs]</a><span class="k">def</span> <span class="nf">shortened_repr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__repr__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="fm">__repr__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">):</span>
            <span class="n">value_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value_repr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_repr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">value_repr</span> <span class="o">=</span> <span class="s2">&quot;&lt;&lt;</span><span class="si">%s</span><span class="s2">++</span><span class="si">%d</span><span class="s2"> chars++</span><span class="si">%s</span><span class="s2">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">value_repr</span><span class="p">[:</span><span class="n">l</span> <span class="o">-</span> <span class="mi">16</span><span class="p">],</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">value_repr</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">value_repr</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">value_repr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_repr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39; object at 0x&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;I hate those useless long reprs&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;gimme class&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">value_repr</span> <span class="o">=</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value_repr</span></div>


<span class="k">def</span> <span class="nf">__auto_repr__</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">attr_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">):</span>
        <span class="n">attr_names</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__slots__&#39;</span><span class="p">):</span>
        <span class="n">attr_names</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attr_names</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="c1"># TODO:  should we add this feature to minimize some talktative reprs</span>
        <span class="c1"># such as of URL?</span>
        <span class="c1">#if value is None:</span>
        <span class="c1">#    continue</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">shortened_repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>


<div class="viewcode-block" id="auto_repr"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.auto_repr">[docs]</a><span class="k">def</span> <span class="nf">auto_repr</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for a class to assign it an automagic quick and dirty __repr__</span>

<span class="sd">    It uses public class attributes to prepare repr of a class</span>

<span class="sd">    Original idea: http://stackoverflow.com/a/27799004/1265472</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">cls</span><span class="o">.</span><span class="fm">__repr__</span> <span class="o">=</span> <span class="n">__auto_repr__</span>
    <span class="k">return</span> <span class="bp">cls</span></div>


<span class="k">def</span> <span class="nf">_is_stream_tty</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># TODO: check on windows if hasattr check would work correctly and</span>
        <span class="c1"># add value:</span>
        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="c1"># Who knows why it is a ValueError, but let&#39;s try to be specific</span>
        <span class="c1"># If there is a problem with I/O - non-interactive, otherwise reraise</span>
        <span class="k">if</span> <span class="s2">&quot;I/O&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">raise</span>


<div class="viewcode-block" id="is_interactive"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.is_interactive">[docs]</a><span class="k">def</span> <span class="nf">is_interactive</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return True if all in/outs are open and tty.</span>

<span class="sd">    Note that in a somewhat abnormal case where e.g. stdin is explicitly</span>
<span class="sd">    closed, and any operation on it would raise a</span>
<span class="sd">    `ValueError(&quot;I/O operation on closed file&quot;)` exception, this function</span>
<span class="sd">    would just return False, since the session cannot be used interactively.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">_is_stream_tty</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_ipython_shell"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_ipython_shell">[docs]</a><span class="k">def</span> <span class="nf">get_ipython_shell</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Detect if running within IPython and returns its `ip` (shell) object</span>

<span class="sd">    Returns None if not under ipython (no `get_ipython` function)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_ipython</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="md5sum"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.md5sum">[docs]</a><span class="k">def</span> <span class="nf">md5sum</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute an MD5 sum for the given file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datalad.support.digests</span> <span class="kn">import</span> <span class="n">Digester</span>
    <span class="k">return</span> <span class="n">Digester</span><span class="p">(</span><span class="n">digests</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;md5&#39;</span><span class="p">])(</span><span class="n">filename</span><span class="p">)[</span><span class="s1">&#39;md5&#39;</span><span class="p">]</span></div>


<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="sorted_files"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.sorted_files">[docs]</a><span class="k">def</span> <span class="nf">sorted_files</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a (sorted) list of files under path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">sum</span><span class="p">([[</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;.git&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">],</span> <span class="p">[]))</span></div>

<span class="n">_encoded_dirsep</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span>  <span class="k">if</span> <span class="n">on_windows</span> <span class="k">else</span> <span class="sa">r</span><span class="s1">&#39;/&#39;</span>
<span class="n">_VCS_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">\.(?:git|gitattributes|svn|bzr|hg)(?:</span><span class="si">%s</span><span class="s1">|$)&#39;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">_encoded_dirsep</span><span class="p">,</span> <span class="n">_encoded_dirsep</span><span class="p">)</span>
<span class="n">_DATALAD_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">\.(?:datalad)(?:</span><span class="si">%s</span><span class="s1">|$)&#39;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">_encoded_dirsep</span><span class="p">,</span> <span class="n">_encoded_dirsep</span><span class="p">)</span>


<div class="viewcode-block" id="find_files"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.find_files">[docs]</a><span class="k">def</span> <span class="nf">find_files</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">topdir</span><span class="o">=</span><span class="n">curdir</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_vcs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_datalad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator to find files matching regex</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regex: basestring</span>
<span class="sd">    exclude: basestring, optional</span>
<span class="sd">      Matches to exclude</span>
<span class="sd">    exclude_vcs:</span>
<span class="sd">      If True, excludes commonly known VCS subdirectories.  If string, used</span>
<span class="sd">      as regex to exclude those files (regex: `%r`)</span>
<span class="sd">    exclude_datalad:</span>
<span class="sd">      If True, excludes files known to be datalad meta-data files (e.g. under</span>
<span class="sd">      .datalad/ subdirectory) (regex: `%r`)</span>
<span class="sd">    topdir: basestring, optional</span>
<span class="sd">      Directory where to search</span>
<span class="sd">    dirs: bool, optional</span>
<span class="sd">      Whether to match directories as well as files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">topdir</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">dirnames</span> <span class="o">+</span> <span class="n">filenames</span><span class="p">)</span> <span class="k">if</span> <span class="n">dirs</span> <span class="k">else</span> <span class="n">filenames</span>
        <span class="c1"># TODO: might want to uniformize on windows to use &#39;/&#39;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude_vcs</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">_VCS_REGEX</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude_datalad</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">_DATALAD_REGEX</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">path</span></div>
<span class="n">find_files</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">%=</span> <span class="p">(</span><span class="n">_VCS_REGEX</span><span class="p">,</span> <span class="n">_DATALAD_REGEX</span><span class="p">)</span>


<div class="viewcode-block" id="expandpath"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.expandpath">[docs]</a><span class="k">def</span> <span class="nf">expandpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">force_absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expand all variables and user handles in a path.</span>

<span class="sd">    By default return an absolute path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">force_absolute</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="posix_relpath"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.posix_relpath">[docs]</a><span class="k">def</span> <span class="nf">posix_relpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Behave like os.path.relpath, but always return POSIX paths...</span>

<span class="sd">    on any platform.&quot;&quot;&quot;</span>
    <span class="c1"># join POSIX style</span>
    <span class="k">return</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="c1"># split and relpath native style</span>
        <span class="c1"># python2.7 ntpath implementation of relpath cannot handle start=None</span>
        <span class="o">*</span><span class="n">split</span><span class="p">(</span>
            <span class="n">relpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="is_explicit_path"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.is_explicit_path">[docs]</a><span class="k">def</span> <span class="nf">is_explicit_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return whether a path explicitly points to a location</span>

<span class="sd">    Any absolute path, or relative path starting with either &#39;../&#39; or</span>
<span class="sd">    &#39;./&#39; is assumed to indicate a location on the filesystem. Any other</span>
<span class="sd">    path format is not considered explicit.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">expandpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">force_absolute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> \
        <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> \
        <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span></div>


<span class="c1"># handle this dance once, and import pathlib from here</span>
<span class="c1"># in all other places</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Path</span><span class="p">,</span>
    <span class="n">PurePath</span><span class="p">,</span>
    <span class="n">PurePosixPath</span><span class="p">,</span>
<span class="p">)</span>

<div class="viewcode-block" id="rotree"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.rotree">[docs]</a><span class="k">def</span> <span class="nf">rotree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chmod_files</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;To make tree read-only or writable</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : string</span>
<span class="sd">      Path to the tree/directory to chmod</span>
<span class="sd">    ro : bool, optional</span>
<span class="sd">      Whether to make it R/O (default) or RW</span>
<span class="sd">    chmod_files : bool, optional</span>
<span class="sd">      Whether to operate also on files (not just directories)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ro</span><span class="p">:</span>
        <span class="n">chmod</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chmod</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IREAD</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chmod_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">fullf</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="c1"># might be the &quot;broken&quot; symlink which would fail to stat etc</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fullf</span><span class="p">):</span>
                    <span class="n">chmod</span><span class="p">(</span><span class="n">fullf</span><span class="p">)</span>
        <span class="n">chmod</span><span class="p">(</span><span class="n">root</span><span class="p">)</span></div>


<div class="viewcode-block" id="rmtree"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.rmtree">[docs]</a><span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chmod_files</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">children_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;To remove git-annex .git it is needed to make all files and directories writable again first</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: Path or str</span>
<span class="sd">       Path to remove</span>
<span class="sd">    chmod_files : string or bool, optional</span>
<span class="sd">       Whether to make files writable also before removal.  Usually it is just</span>
<span class="sd">       a matter of directories to have write permissions.</span>
<span class="sd">       If &#39;auto&#39; it would chmod files on windows by default</span>
<span class="sd">    children_only : bool, optional</span>
<span class="sd">       If set, all files and subdirectories would be removed while the path</span>
<span class="sd">       itself (must be a directory) would be preserved</span>
<span class="sd">    `*args` :</span>
<span class="sd">    `**kwargs` :</span>
<span class="sd">       Passed into shutil.rmtree call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Give W permissions back only to directories, no need to bother with files</span>
    <span class="k">if</span> <span class="n">chmod_files</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">chmod_files</span> <span class="o">=</span> <span class="n">on_windows</span>
    <span class="c1"># TODO:  yoh thinks that if we could quickly check our Flyweight for</span>
    <span class="c1">#        repos if any of them is under the path, and could call .precommit</span>
    <span class="c1">#        on those to possibly stop batched processes etc, we did not have</span>
    <span class="c1">#        to do it on case by case</span>
    <span class="c1"># Check for open files</span>
    <span class="n">assert_no_open_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># TODO the whole thing should be reimplemented with pathlib, but for now</span>
    <span class="c1"># at least accept Path</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">children_only</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can remove children only of directories&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="n">rotree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chmod_files</span><span class="o">=</span><span class="n">chmod_files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
            <span class="c1"># shutil fails to remove paths that exceed 260 characters on Windows machines</span>
            <span class="c1"># that did not enable long path support. A workaround to remove long paths</span>
            <span class="c1"># anyway is to preprend \\?\ to the path.</span>
            <span class="c1"># https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file?redirectedfrom=MSDN#win32-file-namespaces</span>
            <span class="n">path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">?\ &#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="n">path</span>
        <span class="n">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># just remove the symlink</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="rmdir"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.rmdir">[docs]</a><span class="k">def</span> <span class="nf">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;os.rmdir with our optional checking for open files&quot;&quot;&quot;</span>
    <span class="n">assert_no_open_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_open_files"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_open_files">[docs]</a><span class="k">def</span> <span class="nf">get_open_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">log_open</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get open files under a path</span>

<span class="sd">    Note: This function is very slow on Windows.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">      File or directory to check for open files under</span>
<span class="sd">    log_open : bool or int</span>
<span class="sd">      If set - logger level to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">      path : pid</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Original idea: https://stackoverflow.com/a/11115521/1265472</span>
    <span class="kn">import</span> <span class="nn">psutil</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># since the ones returned by psutil would not be aware of symlinks in the</span>
    <span class="c1"># path we should also get realpath for path</span>
    <span class="c1"># do absolute() in addition to always get an absolute path</span>
    <span class="c1"># even with non-existing paths on windows</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">open_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">open_files</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">proc</span><span class="o">.</span><span class="n">cwd</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">open_paths</span><span class="p">:</span>
                <span class="c1"># note: could be done more efficiently so we do not</span>
                <span class="c1"># renormalize path over and over again etc</span>
                <span class="k">if</span> <span class="n">path_startswith</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
                    <span class="n">files</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc</span>
        <span class="c1"># Catch a race condition where a process ends</span>
        <span class="c1"># before we can examine its files</span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">log_open</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_open</span><span class="p">,</span> <span class="s2">&quot;Open files under </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">files</span></div>


<span class="n">_assert_no_open_files_cfg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATALAD_ASSERT_NO_OPEN_FILES&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">_assert_no_open_files_cfg</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">assert_no_open_files</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">get_open_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">log_open</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_assert_no_open_files_cfg</span> <span class="o">==</span> <span class="s1">&#39;assert&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">files</span><span class="p">,</span> <span class="s2">&quot;Got following files still open: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_assert_no_open_files_cfg</span> <span class="o">==</span> <span class="s1">&#39;pdb&#39;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pdb</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">_assert_no_open_files_cfg</span> <span class="o">==</span> <span class="s1">&#39;epdb&#39;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">epdb</span>
                <span class="n">epdb</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>
            <span class="k">pass</span>
        <span class="c1"># otherwise we would just issue that error message in the log</span>
<span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="assert_no_open_files"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.assert_no_open_files">[docs]</a>    <span class="k">def</span> <span class="nf">assert_no_open_files</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="rmtemp"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.rmtemp">[docs]</a><span class="k">def</span> <span class="nf">rmtemp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper to centralize removing of temp files so we could keep them around</span>

<span class="sd">    It will not remove the temporary file/directory if DATALAD_TESTS_TEMP_KEEP</span>
<span class="sd">    environment variable is defined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATALAD_TESTS_TEMP_KEEP&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">%s</span><span class="s2"> does not exist, so can&#39;t be removed&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Removing temp file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="c1"># Can also be a directory</span>
        <span class="k">if</span> <span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keeping temp file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="file_basename"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.file_basename">[docs]</a><span class="k">def</span> <span class="nf">file_basename</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">return_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Strips up to 2 extensions of length up to 4 characters and starting with alpha</span>
<span class="sd">    not a digit, so we could get rid of .tar.gz etc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">fbname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\.[a-zA-Z_]\S{1,4}){0,2}$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">bname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_ext</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fbname</span><span class="p">,</span> <span class="n">bname</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">fbname</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fbname</span></div>


<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="escape_filename"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.escape_filename">[docs]</a><span class="k">def</span> <span class="nf">escape_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Surround filename in &quot;&quot; and escape &quot; in the filename</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;`&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\`&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">filename</span>
    <span class="k">return</span> <span class="n">filename</span></div>


<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="encode_filename"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.encode_filename">[docs]</a><span class="k">def</span> <span class="nf">encode_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encode unicode filename</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filename</span></div>


<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="decode_input"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.decode_input">[docs]</a><span class="k">def</span> <span class="nf">decode_input</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given input string/bytes, decode according to stdin codepage (or UTF-8)</span>
<span class="sd">    if not defined</span>

<span class="sd">    If fails -- issue warning and decode allowing for errors</span>
<span class="sd">    being replaced</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s1">&#39;UTF-8&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Failed to decode input string using </span><span class="si">%s</span><span class="s2"> encoding. &quot;</span>
                <span class="s2">&quot;Decoding allowing for errors&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span></div>


<span class="c1"># unused in -core</span>
<span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">lmtime</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set mtime for files.  On Windows a merely adapter to os.utime</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">mtime</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="lmtime"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.lmtime">[docs]</a>    <span class="k">def</span> <span class="nf">lmtime</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set mtime for files, while not de-referencing symlinks.</span>

<span class="sd">        To overcome absence of os.lutime</span>

<span class="sd">        Works only on linux and OSX ATM</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.cmd</span> <span class="kn">import</span> <span class="n">WitlessRunner</span>
        <span class="c1"># convert mtime to format touch understands [[CC]YY]MMDDhhmm[.SS]</span>
        <span class="n">smtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M.%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Setting mtime for </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> == </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">smtime</span><span class="p">)</span>
        <span class="n">WitlessRunner</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;touch&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">smtime</span><span class="p">,</span> <span class="n">filepath</span><span class="p">])</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">rfilepath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rfilepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># trust no one - adjust also of the target file</span>
            <span class="c1"># since it seemed like downloading under OSX (was it using curl?)</span>
            <span class="c1"># didn&#39;t bother with timestamps</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;File is a symlink to </span><span class="si">%s</span><span class="s2"> Setting mtime for it to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">rfilepath</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rfilepath</span><span class="p">),</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">mtime</span><span class="p">))</span></div>
        <span class="c1"># doesn&#39;t work on OSX</span>
        <span class="c1"># Runner().run([&#39;touch&#39;, &#39;-h&#39;, &#39;-d&#39;, &#39;@%s&#39; % mtime, filepath])</span>


<div class="viewcode-block" id="ensure_tuple_or_list"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_tuple_or_list">[docs]</a><span class="k">def</span> <span class="nf">ensure_tuple_or_list</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an object, wrap into a tuple if not list or tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,)</span></div>


<div class="viewcode-block" id="ensure_iter"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_iter">[docs]</a><span class="k">def</span> <span class="nf">ensure_iter</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given not a list, would place it into a list. If None - empty list is returned</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s: list or anything</span>
<span class="sd">    cls: class</span>
<span class="sd">      Which iterable class to ensure</span>
<span class="sd">    copy: bool, optional</span>
<span class="sd">      If correct iterable is passed, it would generate its shallow copy</span>
<span class="sd">    iterate: bool, optional</span>
<span class="sd">      If it is not a list, but something iterable (but not a str)</span>
<span class="sd">      iterate over it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">shallow_copy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">((</span><span class="n">s</span><span class="p">,))</span>
    <span class="k">elif</span> <span class="n">iterate</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">((</span><span class="n">s</span><span class="p">,))</span></div>


<div class="viewcode-block" id="ensure_list"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_list">[docs]</a><span class="k">def</span> <span class="nf">ensure_list</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given not a list, would place it into a list. If None - empty list is returned</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s: list or anything</span>
<span class="sd">    copy: bool, optional</span>
<span class="sd">      If list is passed, it would generate a shallow copy of the list</span>
<span class="sd">    iterate: bool, optional</span>
<span class="sd">      If it is not a list, but something iterable (but not a str)</span>
<span class="sd">      iterate over it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ensure_iter</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="n">iterate</span><span class="p">)</span></div>


<div class="viewcode-block" id="ensure_list_from_str"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_list_from_str">[docs]</a><span class="k">def</span> <span class="nf">ensure_list_from_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a multiline string convert it to a list of return None if empty</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s: str or list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span></div>


<div class="viewcode-block" id="ensure_dict_from_str"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_dict_from_str">[docs]</a><span class="k">def</span> <span class="nf">ensure_dict_from_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a multiline string with key=value items convert it to a dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s: str or dict</span>

<span class="sd">    Returns None if input s is empty</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">value_str</span> <span class="ow">in</span> <span class="n">ensure_list_from_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value_str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not in key=value format&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value_str</span><span class="p">)))</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">value_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;key </span><span class="si">{}</span><span class="s2"> was already defined in </span><span class="si">{}</span><span class="s2">, but new value </span><span class="si">{}</span><span class="s2"> was provided&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="ensure_bytes"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_bytes">[docs]</a><span class="k">def</span> <span class="nf">ensure_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert/encode unicode string to bytes.</span>

<span class="sd">    If `s` isn&#39;t a string, return it as is.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    encoding: str, optional</span>
<span class="sd">      Encoding to use.  &quot;utf-8&quot; is the default</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span></div>


<div class="viewcode-block" id="ensure_unicode"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_unicode">[docs]</a><span class="k">def</span> <span class="nf">ensure_unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert/decode bytestring to unicode.</span>

<span class="sd">    If `s` isn&#39;t a bytestring, return it as is.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    encoding: str, optional</span>
<span class="sd">      Encoding to use.  If None, &quot;utf-8&quot; is tried, and then if not a valid</span>
<span class="sd">      UTF-8, encoding will be guessed</span>
<span class="sd">    confidence: float, optional</span>
<span class="sd">      A value between 0 and 1, so if guessing of encoding is of lower than</span>
<span class="sd">      specified confidence, ValueError is raised</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Figure out encoding, defaulting to &#39;utf-8&#39; which is our common</span>
        <span class="c1"># target in contemporary digital society</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to decode a string as utf-8: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="n">CapturedException</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
        <span class="c1"># And now we could try to guess</span>
        <span class="kn">from</span> <span class="nn">chardet</span> <span class="kn">import</span> <span class="n">detect</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">detect</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">denc</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">denc</span><span class="p">:</span>
            <span class="n">denc_confidence</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>  <span class="n">denc_confidence</span> <span class="o">&lt;</span> <span class="n">confidence</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to auto-detect encoding with high enough &quot;</span>
                    <span class="s2">&quot;confidence. Highest confidence was </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">denc_confidence</span><span class="p">,</span> <span class="n">denc</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Auto-detected encoding to be </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">denc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">denc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Could not decode value as utf-8, or to guess its encoding: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span></div>


<div class="viewcode-block" id="ensure_bool"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_bool">[docs]</a><span class="k">def</span> <span class="nf">ensure_bool</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert value into boolean following convention for strings</span>

<span class="sd">    to recognize on,True,yes as True, off,False,no as False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sl</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">sl</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Do not know how to treat </span><span class="si">%r</span><span class="s2"> as a boolean&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="as_unicode"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.as_unicode">[docs]</a><span class="k">def</span> <span class="nf">as_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cast_types</span><span class="o">=</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an arbitrary value, would try to obtain unicode value of it</span>
<span class="sd">    </span>
<span class="sd">    For unicode it would return original value, for python2 str or python3</span>
<span class="sd">    bytes it would use ensure_unicode, for None - an empty (unicode) string,</span>
<span class="sd">    and for any other type (see `cast_types`) - would apply the unicode </span>
<span class="sd">    constructor.  If value is not an instance of `cast_types`, TypeError</span>
<span class="sd">    is thrown</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cast_types: type</span>
<span class="sd">      Which types to cast to unicode by providing to constructor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unicode_srctypes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cast_types</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Value </span><span class="si">%r</span><span class="s2"> is not of any of known or provided </span><span class="si">%s</span><span class="s2"> types&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cast_types</span><span class="p">))</span></div>


<div class="viewcode-block" id="unique"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.unique">[docs]</a><span class="k">def</span> <span class="nf">unique</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a sequence return a list only with unique elements while maintaining order</span>

<span class="sd">    This is the fastest solution.  See</span>
<span class="sd">    https://www.peterbe.com/plog/uniqifiers-benchmark</span>
<span class="sd">    and</span>
<span class="sd">    http://stackoverflow.com/a/480227/1265472</span>
<span class="sd">    for more information.</span>
<span class="sd">    Enhancement -- added ability to compare for uniqueness using a key function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seq:</span>
<span class="sd">      Sequence to analyze</span>
<span class="sd">    key: callable, optional</span>
<span class="sd">      Function to call on each element so we could decide not on a full</span>
<span class="sd">      element, but on its member etc</span>
<span class="sd">    reverse: bool, optional</span>
<span class="sd">      If True, uniqueness checked in the reverse order, so that the later ones</span>
<span class="sd">      will take the order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>

    <span class="n">trans</span> <span class="o">=</span> <span class="nb">reversed</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># OPT: could be optimized, since key is called twice, but for our cases</span>
        <span class="c1"># should be just as fine</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">key</span><span class="p">(</span><span class="n">x</span><span class="p">)))]</span>

    <span class="k">return</span> <span class="n">out</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="n">out</span></div>


<div class="viewcode-block" id="all_same"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.all_same">[docs]</a><span class="k">def</span> <span class="nf">all_same</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick check if all items are the same.</span>

<span class="sd">    Identical to a check like len(set(items)) == 1 but</span>
<span class="sd">    should be more efficient while working on generators, since would</span>
<span class="sd">    return False as soon as any difference detected thus possibly avoiding</span>
<span class="sd">    unnecessary evaluations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">first_item</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">first_item</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">first_item</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># So we return False if was empty</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">first</span></div>


<div class="viewcode-block" id="map_items"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.map_items">[docs]</a><span class="k">def</span> <span class="nf">map_items</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A helper to apply `func` to all elements (keys and values) within dict</span>

<span class="sd">    No type checking of values passed to func is done, so `func`</span>
<span class="sd">    should be resilient to values which it should not handle</span>

<span class="sd">    Initial usecase - apply_recursive(url_fragment, ensure_unicode)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># map all elements within item</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
        <span class="n">item</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="partition"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.partition">[docs]</a><span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Partition `items` by `predicate`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    items : iterable</span>
<span class="sd">    predicate : callable</span>
<span class="sd">        A function that will be mapped over each element in `items`. The</span>
<span class="sd">        elements will partitioned based on whether the return value is false or</span>
<span class="sd">        true.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A tuple with two generators, the first for &#39;false&#39; items and the second for</span>
<span class="sd">    &#39;true&#39; ones.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Taken from Peter Otten&#39;s snippet posted at</span>
<span class="sd">    https://nedbatchelder.com/blog/201306/filter_a_list_into_two_parts.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">tee</span><span class="p">((</span><span class="n">predicate</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">item</span> <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pred</span><span class="p">),</span>
            <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">b</span> <span class="k">if</span> <span class="n">pred</span><span class="p">))</span></div>


<div class="viewcode-block" id="generate_chunks"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.generate_chunks">[docs]</a><span class="k">def</span> <span class="nf">generate_chunks</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a container, generate chunks from it with size up to `size`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># There could be a &quot;smarter&quot; solution but I think this would suffice</span>
    <span class="k">assert</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>  <span class="s2">&quot;Size should be non-0 positive&quot;</span>
    <span class="k">while</span> <span class="n">container</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">container</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">container</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span></div>


<div class="viewcode-block" id="generate_file_chunks"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.generate_file_chunks">[docs]</a><span class="k">def</span> <span class="nf">generate_file_chunks</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a list of files, generate chunks of them to avoid exceeding cmdline length</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files: list of str</span>
<span class="sd">    cmd: str or list of str, optional</span>
<span class="sd">      Command to account for as well</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">maxl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span> <span class="k">if</span> <span class="n">files</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span>  <span class="c1"># should at least be 1. If blows then - not our fault</span>
        <span class="p">(</span><span class="n">CMD_MAX_ARG</span>
         <span class="o">-</span> <span class="nb">sum</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">)</span>
         <span class="o">-</span> <span class="mi">4</span>  <span class="c1"># for &#39;--&#39; below</span>
         <span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">maxl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># +3 for possible quotes and a space</span>
    <span class="p">)</span>
    <span class="c1"># TODO: additional treatment for &quot;too many arguments&quot;? although</span>
    <span class="c1"># as https://github.com/datalad/datalad/issues/1883#issuecomment</span>
    <span class="c1"># -436272758</span>
    <span class="c1"># shows there seems to be no hardcoded limit on # of arguments,</span>
    <span class="c1"># but may be we decide to go for smth like follow to be on safe side</span>
    <span class="c1"># chunk_size = min(10240 - len(cmd), chunk_size)</span>
    <span class="n">file_chunks</span> <span class="o">=</span> <span class="n">generate_chunks</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_chunks</span></div>


<span class="c1">#</span>
<span class="c1"># Generators helpers</span>
<span class="c1">#</span>

<div class="viewcode-block" id="saved_generator"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.saved_generator">[docs]</a><span class="k">def</span> <span class="nf">saved_generator</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a generator returns two generators, where 2nd one just replays</span>

<span class="sd">    So the first one would be going through the generated items and 2nd one</span>
<span class="sd">    would be yielding saved items</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saved</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">gen1</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>  <span class="c1"># iterating over original generator</span>
            <span class="n">saved</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">gen2</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saved</span><span class="p">:</span>  <span class="c1"># yielding saved entries</span>
            <span class="k">yield</span> <span class="n">x</span>

    <span class="k">return</span> <span class="n">gen1</span><span class="p">(),</span> <span class="n">gen2</span><span class="p">()</span></div>


<span class="c1">#</span>
<span class="c1"># Decorators</span>
<span class="c1">#</span>

<span class="c1"># Originally better_wraps was created to provide `wrapt`-based, instead of</span>
<span class="c1"># `functools.wraps` implementation to preserve the correct signature of the</span>
<span class="c1"># decorated function. By using inspect.signature in our getargspec, which</span>
<span class="c1"># works fine on `functools.wraps`ed functions, we mediated this necessity.</span>
<span class="n">better_wraps</span> <span class="o">=</span> <span class="n">wraps</span>


<span class="c1"># Borrowed from pandas</span>
<span class="c1"># Copyright: 2011-2014, Lambda Foundry, Inc. and PyData Development Team</span>
<span class="c1"># License: BSD-3</span>
<div class="viewcode-block" id="optional_args"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.optional_args">[docs]</a><span class="k">def</span> <span class="nf">optional_args</span><span class="p">(</span><span class="n">decorator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;allows a decorator to take optional positional and keyword arguments.</span>
<span class="sd">        Assumes that taking a single, callable, positional argument means that</span>
<span class="sd">        it is decorating a function, i.e. something like this::</span>

<span class="sd">            @my_decorator</span>
<span class="sd">            def function(): pass</span>

<span class="sd">        Calls decorator with decorator(f, `*args`, `**kwargs`)&quot;&quot;&quot;</span>

    <span class="nd">@better_wraps</span><span class="p">(</span><span class="n">decorator</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">is_decorating</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Callable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_decorating</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="n">dec</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dec</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<span class="c1"># TODO: just provide decorators for tempfile.mk* functions. This is ugly!</span>
<div class="viewcode-block" id="get_tempfile_kwargs"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_tempfile_kwargs">[docs]</a><span class="k">def</span> <span class="nf">get_tempfile_kwargs</span><span class="p">(</span><span class="n">tkwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates kwargs to be passed to tempfile. calls depending on env vars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tkwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tkwargs_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># operate on a copy of tkwargs to avoid any side-effects</span>
        <span class="n">tkwargs_</span> <span class="o">=</span> <span class="n">tkwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># TODO: don&#39;t remember why I had this one originally</span>
    <span class="c1"># if len(targs)&lt;2 and \</span>
    <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tkwargs_</span><span class="p">:</span>
        <span class="n">tkwargs_</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;datalad_temp&#39;</span><span class="p">]</span> <span class="o">+</span>
            <span class="p">([</span><span class="n">prefix</span><span class="p">]</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span>
            <span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">on_windows</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">wrapped</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]))</span>

    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TMPDIR&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">directory</span> <span class="ow">and</span> <span class="s1">&#39;dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tkwargs_</span><span class="p">:</span>
        <span class="n">tkwargs_</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">directory</span>

    <span class="k">return</span> <span class="n">tkwargs_</span></div>


<div class="viewcode-block" id="line_profile"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.line_profile">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">line_profile</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Q&amp;D helper to line profile the function and spit out stats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">line_profiler</span>
    <span class="n">prof</span> <span class="o">=</span> <span class="n">line_profiler</span><span class="o">.</span><span class="n">LineProfiler</span><span class="p">()</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_line_profile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pfunc</span> <span class="o">=</span> <span class="n">prof</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">prof</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
    <span class="k">return</span>  <span class="n">_wrap_line_profile</span></div>


<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="collect_method_callstats"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.collect_method_callstats">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">collect_method_callstats</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Figure out methods which call the method repeatedly on the same instance</span>

<span class="sd">    Use case(s):</span>
<span class="sd">      - .repo is expensive since does all kinds of checks.</span>
<span class="sd">      - .config is expensive transitively since it calls .repo each time</span>

<span class="sd">    TODO:</span>
<span class="sd">      - fancy one could look through the stack for the same id(self) to see if</span>
<span class="sd">        that location is already in memo.  That would hint to the cases where object</span>
<span class="sd">        is not passed into underlying functions, causing them to redo the same work</span>
<span class="sd">        over and over again</span>
<span class="sd">      - ATM might flood with all &quot;1 lines&quot; calls which are not that informative.</span>
<span class="sd">        The underlying possibly suboptimal use might be coming from their callers.</span>
<span class="sd">        It might or not relate to the previous TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
    <span class="n">memo</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>  <span class="c1"># it will be a dict of lineno: count</span>
    <span class="c1"># gross timing</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">toppath</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_collect_method_callstats</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">()</span>
            <span class="n">caller</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">stack_sig</span> <span class="o">=</span> \
                <span class="s2">&quot;</span><span class="si">{relpath}</span><span class="s2">:</span><span class="si">{s.name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span> <span class="n">relpath</span><span class="o">=</span><span class="n">relpath</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">toppath</span><span class="p">))</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">stack_sig</span><span class="p">)</span>
            <span class="c1"># we will count based on id(self) + wherefrom</span>
            <span class="n">memo</span><span class="p">[</span><span class="n">sig</span><span class="p">][</span><span class="n">caller</span><span class="o">.</span><span class="n">lineno</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">print_stats</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The cost of property </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">memo</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;None since no calls&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># total count</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">memo</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">self_id</span> <span class="k">for</span> <span class="p">(</span><span class="n">self_id</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">memo</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Total: </span><span class="si">{}</span><span class="s2"> calls from </span><span class="si">{}</span><span class="s2"> objects with </span><span class="si">{}</span><span class="s2"> contexts taking </span><span class="si">{:.2f}</span><span class="s2"> sec&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">memo</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>
        <span class="c1"># now we need to sort by value</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">self_id</span><span class="p">,</span> <span class="n">caller</span><span class="p">),</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2"> lines&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">self_id</span><span class="p">,</span> <span class="n">caller</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">memo</span><span class="p">[(</span><span class="n">self_id</span><span class="p">,</span> <span class="n">caller</span><span class="p">)])))</span>

    <span class="c1"># Upon total exit we print the stats</span>
    <span class="kn">import</span> <span class="nn">atexit</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">print_stats</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">_wrap_collect_method_callstats</span></div>


<span class="c1"># Borrowed from duecredit to wrap duecredit-handling to guarantee failsafe</span>
<div class="viewcode-block" id="never_fail"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.never_fail">[docs]</a><span class="k">def</span> <span class="nf">never_fail</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assure that function never fails -- all exceptions are caught</span>

<span class="sd">    Returns `None` if function fails internally.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;DataLad internal failure while running </span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Please report at https://github.com/datalad/datalad/issues&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATALAD_ALLOW_FAIL&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wrapped_func</span></div>


<span class="c1">#</span>
<span class="c1"># Context Managers</span>
<span class="c1">#</span>


<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="nothing_cm"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.nothing_cm">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">nothing_cm</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Just a dummy cm to programmically switch context managers&quot;&quot;&quot;</span>
    <span class="k">yield</span></div>


<div class="viewcode-block" id="swallow_outputs"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.swallow_outputs">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">swallow_outputs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Context manager to help consuming both stdout and stderr, and print()</span>

<span class="sd">    stdout is available as cm.out and stderr as cm.err whenever cm is the</span>
<span class="sd">    yielded context manager.</span>
<span class="sd">    Internally uses temporary files to guarantee absent side-effects of swallowing</span>
<span class="sd">    into StringIO which lacks .fileno.</span>

<span class="sd">    print mocking is necessary for some uses where sys.stdout was already bound</span>
<span class="sd">    to original sys.stdout, thus mocking it later had no effect. Overriding</span>
<span class="sd">    print function had desired effect</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">StringIOAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Little adapter to help getting out/err values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="n">get_tempfile_kwargs</span><span class="p">({},</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;outputs&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">handles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span>

        <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">name</span>
            <span class="n">err_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="o">.</span><span class="n">name</span>
            <span class="kn">from</span> <span class="nn">datalad</span> <span class="kn">import</span> <span class="n">cfg</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;datalad.log&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">lgr</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sname</span> <span class="ow">in</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">),</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">pref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="s2">&quot;| &quot;</span>
                        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Swallowed </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sname</span><span class="p">,</span> <span class="n">pref</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">,</span> <span class="n">pref</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Nothing was swallowed for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sname</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="n">rmtemp</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>
            <span class="n">rmtemp</span><span class="p">(</span><span class="n">err_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fake_print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sep&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">(</span><span class="n">oldout</span><span class="p">,</span> <span class="n">olderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
            <span class="c1"># we mock</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to write to mocked stdout, got </span><span class="si">%s</span><span class="s2">, continue as it &quot;</span>
                    <span class="s2">&quot;didn&#39;t happen&quot;</span><span class="p">,</span>  <span class="n">exc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># must be some other file one -- leave it alone</span>
            <span class="n">oldprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">.ui</span> <span class="kn">import</span> <span class="n">ui</span>
    <span class="c1"># preserve -- they could have been mocked already</span>
    <span class="n">oldprint</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">)</span>
    <span class="n">oldout</span><span class="p">,</span> <span class="n">olderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">olduiout</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">out</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">StringIOAdapter</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">handles</span>
        <span class="n">ui</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">fake_print</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">adapter</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">ui</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">oldout</span><span class="p">,</span> <span class="n">olderr</span><span class="p">,</span> <span class="n">olduiout</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">,</span>  <span class="n">oldprint</span><span class="p">)</span>
        <span class="n">adapter</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>


<div class="viewcode-block" id="swallow_logs"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.swallow_logs">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">swallow_logs</span><span class="p">(</span><span class="n">new_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;datalad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager to consume all logs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Keep old settings</span>
    <span class="n">old_level</span> <span class="o">=</span> <span class="n">lgr</span><span class="o">.</span><span class="n">level</span>
    <span class="n">old_handlers</span> <span class="o">=</span> <span class="n">lgr</span><span class="o">.</span><span class="n">handlers</span>

    <span class="c1"># Let&#39;s log everything into a string</span>
    <span class="c1"># TODO: generalize with the one for swallow_outputs</span>
    <span class="k">class</span> <span class="nc">StringIOAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Little adapter to help getting out values</span>

<span class="sd">        And to stay consistent with how swallow_outputs behaves</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="n">get_tempfile_kwargs</span><span class="p">({},</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">file_</span>
                <span class="c1"># PY3 requires clearly one or another.  race condition possible</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_final_out</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># we closed and cleaned up already</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span>

        <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># store for access while object exists</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_final_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">name</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_</span><span class="p">:</span>
                <span class="n">rmtemp</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">assert_logged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Provide assertion on whether a msg was logged at a given level</span>

<span class="sd">            If neither `msg` nor `level` provided, checks if anything was logged</span>
<span class="sd">            at all.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            msg: str, optional</span>
<span class="sd">              Message (as a regular expression, if `regex`) to be searched.</span>
<span class="sd">              If no msg provided, checks if anything was logged at a given level.</span>
<span class="sd">            level: str, optional</span>
<span class="sd">              String representing the level to be logged</span>
<span class="sd">            regex: bool, optional</span>
<span class="sd">              If False, regular `assert_in` is used</span>
<span class="sd">            **kwargs: str, optional</span>
<span class="sd">              Passed to `assert_re_in` or `assert_in`</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="kn">from</span> <span class="nn">datalad.tests.utils</span> <span class="kn">import</span> <span class="n">assert_re_in</span>
            <span class="kn">from</span> <span class="nn">datalad.tests.utils</span> <span class="kn">import</span> <span class="n">assert_in</span>

            <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\[</span><span class="si">%s</span><span class="s1">\] &#39;</span> <span class="o">%</span> <span class="n">level</span> <span class="k">if</span> <span class="n">level</span> <span class="k">else</span> <span class="sa">r</span><span class="s2">&quot;\[\S+\] &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="n">level</span> <span class="k">if</span> <span class="n">level</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">match</span> <span class="o">+=</span> <span class="n">msg</span>

            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="p">(</span><span class="n">assert_re_in</span> <span class="k">if</span> <span class="n">regex</span> <span class="k">else</span> <span class="n">assert_in</span><span class="p">)(</span><span class="n">match</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;no kwargs to be passed anywhere&quot;</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;Nothing was logged!?&quot;</span>

    <span class="n">adapter</span> <span class="o">=</span> <span class="n">StringIOAdapter</span><span class="p">()</span>
    <span class="c1"># TODO: it does store messages but without any formatting, i.e. even without</span>
    <span class="c1"># date/time prefix etc.  IMHO it should preserve formatting in case if file_ is</span>
    <span class="c1"># set</span>
    <span class="n">swallow_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">adapter</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span>
    <span class="c1"># we want to log levelname so we could test against it</span>
    <span class="n">swallow_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">swallow_handler</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">filters</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">old_handlers</span><span class="p">],</span>
                                  <span class="p">[])</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">swallow_handler</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">old_level</span> <span class="o">&lt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>  <span class="c1"># so if HEAVYDEBUG etc -- show them!</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">handlers</span> <span class="o">+=</span> <span class="n">old_handlers</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_level</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">new_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">new_level</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">new_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">new_level</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">adapter</span>
        <span class="c1"># TODO: if file_ and there was an exception -- most probably worth logging it?</span>
        <span class="c1"># although ideally it should be the next log outside added to that file_ ... oh well</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">old_handlers</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">old_level</span><span class="p">)</span>
        <span class="n">adapter</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>


<span class="c1"># TODO: May be melt in with swallow_logs at some point:</span>
<div class="viewcode-block" id="disable_logger"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.disable_logger">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">disable_logger</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;context manager to temporarily disable logging</span>

<span class="sd">    This is to provide one of swallow_logs&#39; purposes without unnecessarily</span>
<span class="sd">    creating temp files (see gh-1865)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    logger: Logger</span>
<span class="sd">        Logger whose handlers will be ordered to not log anything.</span>
<span class="sd">        Default: datalad&#39;s topmost Logger (&#39;datalad&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">NullFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter class to reject all records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># default: all of datalad&#39;s logging:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;datalad&#39;</span><span class="p">)</span>

    <span class="n">filter_</span> <span class="o">=</span> <span class="n">NullFilter</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">filter_</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">logger</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">removeFilter</span><span class="p">(</span><span class="n">filter_</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">]</span></div>


<div class="viewcode-block" id="lock_if_required"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.lock_if_required">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">lock_if_required</span><span class="p">(</span><span class="n">lock_required</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Acquired and released the provided lock if indicated by a flag&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lock_required</span><span class="p">:</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">lock</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lock_required</span><span class="p">:</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>


<span class="c1">#</span>
<span class="c1"># Additional handlers</span>
<span class="c1">#</span>
<span class="n">_sys_excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>  <span class="c1"># Just in case we ever need original one</span>


<div class="viewcode-block" id="setup_exceptionhook"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.setup_exceptionhook">[docs]</a><span class="k">def</span> <span class="nf">setup_exceptionhook</span><span class="p">(</span><span class="n">ipython</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Overloads default sys.excepthook with our exceptionhook handler.</span>

<span class="sd">       If interactive, our exceptionhook handler will invoke</span>
<span class="sd">       pdb.post_mortem; if not interactive, then invokes default handler.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_datalad_pdb_excepthook</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_interactive</span><span class="p">():</span>
            <span class="kn">import</span> <span class="nn">pdb</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ipython</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">IPython.core</span> <span class="kn">import</span> <span class="n">ultratb</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">ultratb</span><span class="o">.</span><span class="n">FormattedTB</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;Verbose&#39;</span><span class="p">,</span>
                                             <span class="c1"># color_scheme=&#39;Linux&#39;,</span>
                                             <span class="n">call_pdb</span><span class="o">=</span><span class="n">is_interactive</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">_datalad_pdb_excepthook</span></div>


<div class="viewcode-block" id="ensure_dir"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.ensure_dir">[docs]</a><span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure directory exists.</span>

<span class="sd">    Joins the list of arguments to an os-specific path to the desired</span>
<span class="sd">    directory and creates it, if it not exists yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dirname</span></div>


<div class="viewcode-block" id="updated"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.updated">[docs]</a><span class="k">def</span> <span class="nf">updated</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a copy of the input with the &#39;update&#39;</span>

<span class="sd">    Primarily for updating dictionaries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span></div>


<span class="n">_pwd_mode</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_switch_to_getcwd</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_pwd_mode</span>
    <span class="n">_pwd_mode</span> <span class="o">=</span> <span class="s1">&#39;cwd&#39;</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;. From now on will be returning os.getcwd(). Directory&quot;</span>
               <span class="s2">&quot; symlinks in the paths will be resolved&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span>
    <span class="p">)</span>
    <span class="c1"># TODO:  we might want to mitigate by going through all flywheighted</span>
    <span class="c1"># repos and tuning up their .paths to be resolved?</span>


<div class="viewcode-block" id="getpwd"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.getpwd">[docs]</a><span class="k">def</span> <span class="nf">getpwd</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Try to return a CWD without dereferencing possible symlinks</span>

<span class="sd">    This function will try to use PWD environment variable to provide a current</span>
<span class="sd">    working directory, possibly with some directories along the path being</span>
<span class="sd">    symlinks to other directories.  Unfortunately, PWD is used/set only by the</span>
<span class="sd">    shell and such functions as `os.chdir` and `os.getcwd` nohow use or modify</span>
<span class="sd">    it, thus `os.getcwd()` returns path with links dereferenced.</span>

<span class="sd">    While returning current working directory based on PWD env variable we</span>
<span class="sd">    verify that the directory is the same as `os.getcwd()` after resolving all</span>
<span class="sd">    symlinks.  If that verification fails, we fall back to always use</span>
<span class="sd">    `os.getcwd()`.</span>

<span class="sd">    Initial decision to either use PWD env variable or os.getcwd() is done upon</span>
<span class="sd">    the first call of this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_pwd_mode</span>
    <span class="k">if</span> <span class="n">_pwd_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># we need to decide!</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PWD&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">on_windows</span> <span class="ow">and</span> <span class="n">pwd</span> <span class="ow">and</span> <span class="n">pwd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="c1"># It should be a path from MSYS.</span>
                <span class="c1"># - it might start with a drive letter or not</span>
                <span class="c1"># - it seems to be &quot;illegal&quot; to have a single letter directories</span>
                <span class="c1">#   under / path, i.e. if created - they aren&#39;t found</span>
                <span class="c1"># - &#39;ln -s&#39; does not fail to create a &quot;symlink&quot; but it just</span>
                <span class="c1"># copies!</span>
                <span class="c1">#   so we are not likely to need original PWD purpose on</span>
                <span class="c1"># those systems</span>
                <span class="c1"># Verdict:</span>
                <span class="n">_pwd_mode</span> <span class="o">=</span> <span class="s1">&#39;cwd&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_pwd_mode</span> <span class="o">=</span> <span class="s1">&#39;PWD&#39;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">_pwd_mode</span> <span class="o">=</span> <span class="s1">&#39;cwd&#39;</span>

    <span class="k">if</span> <span class="n">_pwd_mode</span> <span class="o">==</span> <span class="s1">&#39;cwd&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">_pwd_mode</span> <span class="o">==</span> <span class="s1">&#39;PWD&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;o such file&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                <span class="c1"># directory was removed but we promised to be robust and</span>
                <span class="c1"># still report the path we might know since we are still in PWD</span>
                <span class="c1"># mode</span>
                <span class="n">cwd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PWD&#39;</span><span class="p">]</span>
            <span class="c1"># do absolute() in addition to always get an absolute path</span>
            <span class="c1"># even with non-existing paths on windows</span>
            <span class="n">pwd_real</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
            <span class="c1"># This logic would fail to catch the case where chdir did happen</span>
            <span class="c1"># to the directory where current PWD is pointing to, e.g.</span>
            <span class="c1"># $&gt; ls -ld $PWD</span>
            <span class="c1"># lrwxrwxrwx 1 yoh yoh 5 Oct 11 13:27 /home/yoh/.tmp/tmp -&gt; /tmp//</span>
            <span class="c1"># hopa:~/.tmp/tmp</span>
            <span class="c1"># $&gt; python -c &#39;import os; os.chdir(&quot;/tmp&quot;); from datalad.utils import getpwd; print(getpwd(), os.getcwd())&#39;</span>
            <span class="c1"># (&#39;/home/yoh/.tmp/tmp&#39;, &#39;/tmp&#39;)</span>
            <span class="c1"># but I guess that should not be too harmful</span>
            <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pwd_real</span> <span class="o">!=</span> <span class="n">cwd</span><span class="p">:</span>
                <span class="n">_switch_to_getcwd</span><span class="p">(</span>
                    <span class="s2">&quot;realpath of PWD=</span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2"> whenever os.getcwd()=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">pwd</span><span class="p">,</span> <span class="n">pwd_real</span><span class="p">,</span> <span class="n">cwd</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">cwd</span>
            <span class="k">return</span> <span class="n">pwd</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">_switch_to_getcwd</span><span class="p">(</span><span class="s2">&quot;PWD env variable is no longer available&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cwd</span>  <span class="c1"># Must not happen, but may be someone</span>
                        <span class="c1"># evil purges PWD from environ?</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Must have not got here. &quot;</span>
            <span class="s2">&quot;pwd_mode must be either cwd or PWD. And it is now </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_pwd_mode</span><span class="p">,)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="chpwd"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.chpwd">[docs]</a><span class="k">class</span> <span class="nc">chpwd</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around os.chdir which also adjusts environ[&#39;PWD&#39;]</span>

<span class="sd">    The reason is that otherwise PWD is simply inherited from the shell</span>
<span class="sd">    and we have no ability to assess directory path without dereferencing</span>
<span class="sd">    symlinks.</span>

<span class="sd">    If used as a context manager it allows to temporarily change directory</span>
<span class="sd">    to the given path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logsuffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">pwd</span> <span class="o">=</span> <span class="n">getpwd</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prev_pwd</span> <span class="o">=</span> <span class="n">pwd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prev_pwd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">normpath</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mkdir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mkdir</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mkdir</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;chdir </span><span class="si">%r</span><span class="s2"> -&gt; </span><span class="si">%r</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prev_pwd</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">logsuffix</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># for grep people -- ok, to chdir here!</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PWD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># nothing more to do really, chdir was in the constructor</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prev_pwd</span><span class="p">:</span>
            <span class="c1"># Need to use self.__class__ so this instance, if the entire</span>
            <span class="c1"># thing mocked during the test, still would use correct chpwd</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prev_pwd</span><span class="p">,</span> <span class="n">logsuffix</span><span class="o">=</span><span class="s2">&quot;(coming back)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="dlabspath"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.dlabspath">[docs]</a><span class="k">def</span> <span class="nf">dlabspath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Symlinks-in-the-cwd aware abspath</span>

<span class="sd">    os.path.abspath relies on os.getcwd() which would not know about symlinks</span>
<span class="sd">    in the path</span>

<span class="sd">    TODO: we might want to norm=True by default to match behavior of</span>
<span class="sd">    os .path.abspath?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># if not absolute -- relative to pwd</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">getpwd</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">norm</span> <span class="k">else</span> <span class="n">path</span></div>


<div class="viewcode-block" id="with_pathsep"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.with_pathsep">[docs]</a><span class="k">def</span> <span class="nf">with_pathsep</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Little helper to guarantee that path ends with /&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">path</span> <span class="o">+</span> <span class="n">sep</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="k">else</span> <span class="n">path</span></div>


<div class="viewcode-block" id="get_path_prefix"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_path_prefix">[docs]</a><span class="k">def</span> <span class="nf">get_path_prefix</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get path prefix (for current directory)</span>

<span class="sd">    Returns relative path to the topdir, if we are under topdir, and if not</span>
<span class="sd">    absolute path to topdir.  If `pwd` is not specified - current directory</span>
<span class="sd">    assumed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pwd</span> <span class="o">=</span> <span class="n">pwd</span> <span class="ow">or</span> <span class="n">getpwd</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">dlabspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path_</span> <span class="o">=</span> <span class="n">with_pathsep</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">pwd_</span> <span class="o">=</span> <span class="n">with_pathsep</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
    <span class="n">common</span> <span class="o">=</span> <span class="n">commonprefix</span><span class="p">((</span><span class="n">path_</span><span class="p">,</span> <span class="n">pwd_</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="n">common</span> <span class="ow">in</span> <span class="p">{</span><span class="n">path_</span><span class="p">,</span> <span class="n">pwd_</span><span class="p">}:</span>
        <span class="c1"># we are in subdir or above the path = use relative path</span>
        <span class="n">location_prefix</span> <span class="o">=</span> <span class="n">relpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pwd</span><span class="p">)</span>
        <span class="c1"># if benign &quot;here&quot; - cut off</span>
        <span class="k">if</span> <span class="n">location_prefix</span> <span class="ow">in</span> <span class="p">(</span><span class="n">curdir</span><span class="p">,</span> <span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span><span class="p">):</span>
            <span class="n">location_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">location_prefix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># just return absolute path</span>
        <span class="k">return</span> <span class="n">path</span></div>


<span class="k">def</span> <span class="nf">_get_normalized_paths</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="n">isabs</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Both paths must either be absolute or relative. &quot;</span>
                         <span class="s2">&quot;Got </span><span class="si">%r</span><span class="s2"> and </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">with_pathsep</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">with_pathsep</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span>


<div class="viewcode-block" id="path_startswith"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.path_startswith">[docs]</a><span class="k">def</span> <span class="nf">path_startswith</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if path starts with prefix path</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str</span>
<span class="sd">    prefix: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">_get_normalized_paths</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span></div>


<div class="viewcode-block" id="path_is_subpath"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.path_is_subpath">[docs]</a><span class="k">def</span> <span class="nf">path_is_subpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if path is a subpath of prefix</span>

<span class="sd">    It will return False if path == prefix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str</span>
<span class="sd">    prefix: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">_get_normalized_paths</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span></div>


<div class="viewcode-block" id="knows_annex"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.knows_annex">[docs]</a><span class="k">def</span> <span class="nf">knows_annex</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns whether at a given path there is information about an annex</span>

<span class="sd">    It is just a thin wrapper around GitRepo.is_with_annex() classmethod</span>
<span class="sd">    which also checks for `path` to exist first.</span>

<span class="sd">    This includes actually present annexes, but also uninitialized ones, or</span>
<span class="sd">    even the presence of a remote annex branch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No annex: test path </span><span class="si">{0}</span><span class="s2"> doesn&#39;t exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="kn">from</span> <span class="nn">datalad.support.gitrepo</span> <span class="kn">import</span> <span class="n">GitRepo</span>
    <span class="k">return</span> <span class="n">GitRepo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">is_with_annex</span><span class="p">()</span></div>


<div class="viewcode-block" id="make_tempfile"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.make_tempfile">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">make_tempfile</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to provide a temporary file name and remove it at the end (context manager)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mkdir : bool, optional (default: False)</span>
<span class="sd">        If True, temporary directory created using tempfile.mkdtemp()</span>
<span class="sd">    content : str or bytes, optional</span>
<span class="sd">        Content to be stored in the file created</span>
<span class="sd">    wrapped : function, optional</span>
<span class="sd">        If set, function name used to prefix temporary file name</span>
<span class="sd">    `**tkwargs`:</span>
<span class="sd">        All other arguments are passed into the call to tempfile.mk{,d}temp(),</span>
<span class="sd">        and resultant temporary filename is passed as the first argument into</span>
<span class="sd">        the function t.  If no &#39;prefix&#39; argument is provided, it will be</span>
<span class="sd">        constructed using module and function names (&#39;.&#39; replaced with</span>
<span class="sd">        &#39;_&#39;).</span>

<span class="sd">    To change the used directory without providing keyword argument &#39;dir&#39; set</span>
<span class="sd">    DATALAD_TESTS_TEMP_DIR.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">        &gt;&gt;&gt; from os.path import exists</span>
<span class="sd">        &gt;&gt;&gt; from datalad.utils import make_tempfile</span>
<span class="sd">        &gt;&gt;&gt; with make_tempfile() as fname:</span>
<span class="sd">        ...    k = open(fname, &#39;w&#39;).write(&#39;silly test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert not exists(fname)  # was removed</span>

<span class="sd">        &gt;&gt;&gt; with make_tempfile(content=&quot;blah&quot;) as fname:</span>
<span class="sd">        ...    assert open(fname).read() == &quot;blah&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">tkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mkdir=True while providing content makes no sense&quot;</span><span class="p">)</span>

    <span class="n">tkwargs_</span> <span class="o">=</span> <span class="n">get_tempfile_kwargs</span><span class="p">(</span><span class="n">tkwargs</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="n">wrapped</span><span class="p">)</span>

    <span class="c1"># if DATALAD_TESTS_TEMP_DIR is set, use that as directory,</span>
    <span class="c1"># let mktemp handle it otherwise. However, an explicitly provided</span>
    <span class="c1"># dir=... will override this.</span>
    <span class="n">mkdir</span> <span class="o">=</span> <span class="n">tkwargs_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">:</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">}[</span><span class="n">mkdir</span><span class="p">](</span><span class="o">**</span><span class="n">tkwargs_</span><span class="p">)</span>
    <span class="c1"># MIH: not clear to me why we need to perform this (possibly expensive)</span>
    <span class="c1"># resolve. It was already part of the original implementation</span>
    <span class="c1"># 008d9ab8cc3e0170c0a9b8479e80dee9ffe6eb7f</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
        <span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">write_bytes</span>
         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
         <span class="k">else</span> <span class="n">filename</span><span class="o">.</span><span class="n">write_text</span><span class="p">)(</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># TODO globbing below can also be done with pathlib</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Created temporary </span><span class="si">%s</span><span class="s1"> named </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directory&#39;</span> <span class="k">if</span> <span class="n">mkdir</span> <span class="k">else</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">filename</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># glob here for all files with the same name (-suffix)</span>
        <span class="c1"># would be useful whenever we requested .img filename,</span>
        <span class="c1"># and function creates .hdr as well</span>
        <span class="c1"># MIH: this is undocumented behavior, and undesired in the general</span>
        <span class="c1"># case. it should be made conditional and explicit</span>
        <span class="n">lsuffix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tkwargs_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">lsuffix</span> <span class="ow">and</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="n">lsuffix</span><span class="p">]</span> <span class="ow">or</span> <span class="n">filename</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filename_</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># For paranoid yoh who stepped into this already ones ;-)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;It is unlikely that it was intended to remove all&quot;</span>
                        <span class="s2">&quot; files matching </span><span class="si">%r</span><span class="s2">. Skipping&quot;</span> <span class="o">%</span> <span class="n">filename_</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rmtemp</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">_path_</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a path in POSIX&quot; notation, regenerate one in native to the env one&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)),</span> <span class="n">p</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume that all others as POSIX compliant so nothing to be done</span>
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>


<div class="viewcode-block" id="get_timestamp_suffix"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_timestamp_suffix">[docs]</a><span class="k">def</span> <span class="nf">get_timestamp_suffix</span><span class="p">(</span><span class="n">time_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a time stamp (full date and time up to second)</span>

<span class="sd">    primarily to be used for generation of log files names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">time_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time_</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">time_</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">TIMESTAMP_FMT</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>


<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="get_logfilename"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_logfilename">[docs]</a><span class="k">def</span> <span class="nf">get_logfilename</span><span class="p">(</span><span class="n">dspath</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="s1">&#39;datalad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a filename to use for logging under a dataset/repository</span>

<span class="sd">    directory would be created if doesn&#39;t exist, but dspath must exist</span>
<span class="sd">    and be a directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">exists</span><span class="p">(</span><span class="n">dspath</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">isdir</span><span class="p">(</span><span class="n">dspath</span><span class="p">))</span>
    <span class="n">ds_logdir</span> <span class="o">=</span> <span class="n">ensure_dir</span><span class="p">(</span><span class="n">dspath</span><span class="p">,</span> <span class="s1">&#39;.git&#39;</span><span class="p">,</span> <span class="s1">&#39;datalad&#39;</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>  <span class="c1"># TODO: use WEB_META_LOG whenever #789 merged</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds_logdir</span><span class="p">,</span> <span class="s1">&#39;crawl-</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="n">get_timestamp_suffix</span><span class="p">())</span></div>


<div class="viewcode-block" id="get_trace"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_trace">[docs]</a><span class="k">def</span> <span class="nf">get_trace</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the trace/path to reach a node in a tree.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    edges : sequence(2-tuple)</span>
<span class="sd">      The tree given by a sequence of edges (parent, child) tuples. The</span>
<span class="sd">      nodes can be identified by any value and data type that supports</span>
<span class="sd">      the &#39;==&#39; operation.</span>
<span class="sd">    start :</span>
<span class="sd">      Identifier of the start node. Must be present as a value in the parent</span>
<span class="sd">      location of an edge tuple in order to be found.</span>
<span class="sd">    end :</span>
<span class="sd">      Identifier of the target/end node. Must be present as a value in the child</span>
<span class="sd">      location of an edge tuple in order to be found.</span>
<span class="sd">    trace : list</span>
<span class="sd">      Mostly useful for recursive calls, and used internally.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None or list</span>
<span class="sd">      Returns a list with the trace to the target (the starts and the target</span>
<span class="sd">      are not included in the trace, hence if start and end are directly connected</span>
<span class="sd">      an empty list is returned), or None when no trace to the target can be found,</span>
<span class="sd">      or start and end are identical.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the term trace is used to avoid confusion with a path in the sense</span>
    <span class="c1"># of a filesystem path, but the analogy fits and nodes can be paths</span>
    <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">edges</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no edges given&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">cand_super</span><span class="p">,</span> <span class="n">cand_sub</span> <span class="o">=</span> <span class="n">cand</span>
        <span class="k">if</span> <span class="n">cand_sub</span> <span class="ow">in</span> <span class="n">trace</span><span class="p">:</span>
            <span class="c1"># only DAGs, skip any cyclic traces</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">cand_super</span> <span class="o">!=</span> <span class="n">trace</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># only consider edges that lead off the end of the trace</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">cand_super</span> <span class="o">!=</span> <span class="n">start</span><span class="p">:</span>
            <span class="c1"># we got nothing yet, and this edges is not matching the start</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">cand_sub</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trace</span>
        <span class="c1"># dive into potential subnodes</span>
        <span class="n">cand_trace</span> <span class="o">=</span> <span class="n">get_trace</span><span class="p">(</span>
            <span class="n">edges</span><span class="p">,</span>
            <span class="n">start</span><span class="p">,</span>
            <span class="n">end</span><span class="p">,</span>
            <span class="n">trace</span> <span class="o">+</span> <span class="p">[</span><span class="n">cand_sub</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cand_trace</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cand_trace</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_dataset_root"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_dataset_root">[docs]</a><span class="k">def</span> <span class="nf">get_dataset_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the root of an existent dataset containing a given path</span>

<span class="sd">    The root path is returned in the same absolute or relative form</span>
<span class="sd">    as the input argument. If no associated dataset exists, or the</span>
<span class="sd">    input path doesn&#39;t exist, None is returned.</span>

<span class="sd">    If `path` is a symlink or something other than a directory, its</span>
<span class="sd">    the root dataset containing its parent directory will be reported.</span>
<span class="sd">    If none can be found, at a symlink at `path` is pointing to a</span>
<span class="sd">    dataset, `path` itself will be reported as the root.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : Path-like</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.git&#39;</span>
    <span class="n">altered</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">altered</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">apath</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># while we can still go up</span>
    <span class="k">while</span> <span class="n">split</span><span class="p">(</span><span class="n">apath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="c1"># new test path in the format we got it</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">normpath</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
        <span class="c1"># no luck, next round</span>
        <span class="n">apath</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># if we applied dirname() at the top, we give it another go with</span>
    <span class="c1"># the actual path, if it was itself a symlink, it could be the</span>
    <span class="c1"># top-level dataset itself</span>
    <span class="k">if</span> <span class="n">altered</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">altered</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">altered</span>

    <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1"># ATM used in datalad_crawler extension, so do not remove yet</span>
<div class="viewcode-block" id="try_multiple"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.try_multiple">[docs]</a><span class="k">def</span> <span class="nf">try_multiple</span><span class="p">(</span><span class="n">ntrials</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call f multiple times making exponentially growing delay between the calls&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntrials</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trial</span> <span class="o">==</span> <span class="n">ntrials</span><span class="p">:</span>
                <span class="k">raise</span>  <span class="c1"># just reraise on the last trial</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">base</span> <span class="o">**</span> <span class="n">trial</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> on trial #</span><span class="si">%d</span><span class="s2">. Sleeping </span><span class="si">%f</span><span class="s2"> and retrying&quot;</span><span class="p">,</span>
                        <span class="n">CapturedException</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">trial</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="try_multiple_dec"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.try_multiple_dec">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">try_multiple_dec</span><span class="p">(</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ntrials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">increment_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">exceptions_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to try function multiple times.</span>

<span class="sd">    Main purpose is to decorate functions dealing with removal of files/directories</span>
<span class="sd">    and which might need a few seconds to work correctly on Windows which takes</span>
<span class="sd">    its time to release files/directories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ntrials: int, optional</span>
<span class="sd">    duration: float, optional</span>
<span class="sd">      Seconds to sleep before retrying.</span>
<span class="sd">    increment_type: {None, &#39;exponential&#39;}</span>
<span class="sd">      Note that if it is exponential, duration should typically be &gt; 1.0</span>
<span class="sd">      so it grows with higher power</span>
<span class="sd">    exceptions: Exception or tuple of Exceptions, optional</span>
<span class="sd">      Exception or a tuple of multiple exceptions, on which to retry</span>
<span class="sd">    exceptions_filter: callable, optional</span>
<span class="sd">      If provided, this function will be called with a caught exception</span>
<span class="sd">      instance.  If function returns True - we will re-try, if False - exception</span>
<span class="sd">      will be re-raised without retrying.</span>
<span class="sd">    logger: callable, optional</span>
<span class="sd">      Logger to log upon failure.  If not provided, will use stock logger</span>
<span class="sd">      at the level of 5 (heavy debug).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exceptions</span><span class="p">:</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">WindowsError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">on_windows</span> <span class="k">else</span> <span class="ne">OSError</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ntrials</span><span class="p">:</span>
        <span class="c1"># Life goes fast on proper systems, no need to delay it much</span>
        <span class="n">ntrials</span> <span class="o">=</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">on_windows</span> <span class="k">else</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">increment_type</span> <span class="ow">in</span> <span class="p">{</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;exponential&#39;</span><span class="p">}</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_wrap_try_multiple_dec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntrials</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exceptions_filter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exceptions_filter</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="n">trial</span> <span class="o">&lt;</span> <span class="n">ntrials</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">increment_type</span> <span class="o">==</span> <span class="s1">&#39;exponential&#39;</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">**</span> <span class="p">(</span><span class="n">trial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="p">(</span>
                        <span class="s2">&quot;Caught </span><span class="si">%s</span><span class="s2"> on trial #</span><span class="si">%d</span><span class="s2">. Sleeping </span><span class="si">%f</span><span class="s2"> and retrying&quot;</span><span class="p">,</span>
                        <span class="n">CapturedException</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">trial</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

    <span class="k">return</span> <span class="n">_wrap_try_multiple_dec</span></div>


<div class="viewcode-block" id="unlink"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.unlink">[docs]</a><span class="nd">@try_multiple_dec</span>
<span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&#39;Robust&#39; unlink.  Would try multiple times</span>

<span class="sd">    On windows boxes there is evidence for a latency of more than a second</span>
<span class="sd">    until a file is considered no longer &quot;in-use&quot;.</span>
<span class="sd">    WindowsError is not known on Linux, and if IOError or any other</span>
<span class="sd">    exception</span>
<span class="sd">    is thrown then if except statement has WindowsError in it -- NameError</span>
<span class="sd">    also see gh-2533</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for open files</span>
    <span class="n">assert_no_open_files</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<span class="nd">@try_multiple_dec</span>
<span class="k">def</span> <span class="nf">_rmtree</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Just a helper to decorate shutil.rmtree.</span>

<span class="sd">    rmtree defined above does more and ideally should not itself be decorated</span>
<span class="sd">    since a recursive definition and does checks for open files inside etc -</span>
<span class="sd">    might be too runtime expensive</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="slash_join"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.slash_join">[docs]</a><span class="k">def</span> <span class="nf">slash_join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Join two strings with a &#39;/&#39;, avoiding duplicate slashes</span>

<span class="sd">    If any of the strings is None the other is returned as is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base</span>
    <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">extension</span>
    <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
         <span class="n">extension</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)))</span></div>


<span class="c1">#</span>
<span class="c1"># IO Helpers</span>
<span class="c1">#</span>

<span class="c1"># unused in -core</span>
<div class="viewcode-block" id="open_r_encdetect"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.open_r_encdetect">[docs]</a><span class="k">def</span> <span class="nf">open_r_encdetect</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">readahead</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a file object in read mode with auto-detected encoding</span>

<span class="sd">    This is helpful when dealing with files of unknown encoding.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    readahead: int, optional</span>
<span class="sd">      How many bytes to read for guessing the encoding type.  If</span>
<span class="sd">      negative - full file will be read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">chardet</span> <span class="kn">import</span> <span class="n">detect</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="c1"># read some bytes from the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">readahead</span><span class="p">)</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="n">detect</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="n">denc</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Auto-detected encoding </span><span class="si">%s</span><span class="s2"> for file </span><span class="si">%s</span><span class="s2"> (confidence: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
              <span class="n">denc</span><span class="p">,</span>
              <span class="n">fname</span><span class="p">,</span>
              <span class="n">enc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">denc</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_file"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.read_file">[docs]</a><span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A helper to read file passing content via ensure_unicode</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    decode: bool, optional</span>
<span class="sd">      if False, no ensure_unicode and file content returned as bytes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">decode</span> <span class="k">else</span> <span class="n">content</span></div>


<div class="viewcode-block" id="read_csv_lines"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.read_csv_lines">[docs]</a><span class="k">def</span> <span class="nf">read_csv_lines</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">readahead</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A generator of dict records from a CSV/TSV</span>

<span class="sd">    Automatically guesses the encoding for each record to convert to UTF-8</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname: str</span>
<span class="sd">      Filename</span>
<span class="sd">    dialect: str, optional</span>
<span class="sd">      Dialect to specify to csv.reader. If not specified -- guessed from</span>
<span class="sd">      the file, if fails to guess, &quot;excel-tab&quot; is assumed</span>
<span class="sd">    readahead: int, optional</span>
<span class="sd">      How many bytes to read from the file to guess the type</span>
<span class="sd">    **kwargs</span>
<span class="sd">      Passed to `csv.reader`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">csv</span>
    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">tsvfile</span><span class="p">:</span>
            <span class="c1"># add robustness, use a sniffer</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dialect</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">Sniffer</span><span class="p">()</span><span class="o">.</span><span class="n">sniff</span><span class="p">(</span><span class="n">tsvfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">readahead</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Could not determine file-format, assuming TSV: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">CapturedException</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">dialect</span> <span class="o">=</span> <span class="s1">&#39;excel-tab&#39;</span>

    <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">as</span> <span class="n">tsvfile</span><span class="p">:</span>
        <span class="c1"># csv.py doesn&#39;t do Unicode; encode temporarily as UTF-8:</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span>
            <span class="n">tsvfile</span><span class="p">,</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
            <span class="c1"># decode UTF-8 back to Unicode, cell by cell:</span>
            <span class="n">row_unicode</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">ensure_unicode</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row_unicode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">row_unicode</span><span class="p">))</span></div>


<div class="viewcode-block" id="import_modules"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.import_modules">[docs]</a><span class="k">def</span> <span class="nf">import_modules</span><span class="p">(</span><span class="n">modnames</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Failed to import </span><span class="si">{module}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to import a list of modules without failing if N/A</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    modnames: list of str</span>
<span class="sd">      List of module names to import</span>
<span class="sd">    pkg: str</span>
<span class="sd">      Package under which to import</span>
<span class="sd">    msg: str, optional</span>
<span class="sd">      Message template for .format() to log at DEBUG level if import fails.</span>
<span class="sd">      Keys {module} and {package} will be provided and &#39;: {exception}&#39; appended</span>
<span class="sd">    log: callable, optional</span>
<span class="sd">      Logger call to use for logging messages</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
    <span class="n">_globals</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="n">mods_loaded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">pkg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="c1"># with python 3.5.1 (ok with 3.5.5) somehow kept running into</span>
        <span class="c1">#  Failed to import dlsub1: Parent module &#39;dltestm1&#39; not loaded</span>
        <span class="c1"># while running the test. Preloading pkg resolved the issue</span>
        <span class="n">import_module</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">modnames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_globals</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span>
                <span class="s1">&#39;.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modname</span><span class="p">),</span>
                <span class="n">pkg</span><span class="p">)</span>
            <span class="n">mods_loaded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">datalad.support.exceptions</span> <span class="kn">import</span> <span class="n">CapturedException</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="n">CapturedException</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">log</span><span class="p">((</span><span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;: </span><span class="si">{exception}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">module</span><span class="o">=</span><span class="n">modname</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">pkg</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">ce</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mods_loaded</span></div>


<div class="viewcode-block" id="import_module_from_file"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.import_module_from_file">[docs]</a><span class="k">def</span> <span class="nf">import_module_from_file</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import provided module given a path</span>

<span class="sd">    TODO:</span>
<span class="sd">    - RF/make use of it in pipeline.py which has similar logic</span>
<span class="sd">    - join with import_modules above?</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pkg: module, optional</span>
<span class="sd">       If provided, and modpath is under pkg.__path__, relative import will be</span>
<span class="sd">       used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">modpath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>  <span class="c1"># for now just for .py files</span>

    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Importing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">modpath</span><span class="p">)</span>

    <span class="n">modname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">modpath</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">relmodpath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pkg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pkgpath</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">__path__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path_is_subpath</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="n">pkgpath</span><span class="p">):</span>
                <span class="c1"># for now relying on having .py extension -- assertion above</span>
                <span class="n">relmodpath</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">relpath</span><span class="p">(</span><span class="n">modpath</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">pkgpath</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">relmodpath</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">relmodpath</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirname_</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">modpath</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dirname_</span><span class="p">)</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dirname_</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dirname_</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Expected path </span><span class="si">%s</span><span class="s2"> to be within sys.path, but it was gone!&quot;</span> <span class="o">%</span> <span class="n">dirname_</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Failed to import module from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">modpath</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">return</span> <span class="n">mod</span></div>


<div class="viewcode-block" id="get_encoding_info"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_encoding_info">[docs]</a><span class="k">def</span> <span class="nf">get_encoding_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a dictionary with various encoding/locale information&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">locale</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;filesystem&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;locale.prefered&#39;</span><span class="p">,</span> <span class="n">locale</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">()),</span>
    <span class="p">])</span></div>


<div class="viewcode-block" id="get_envvars_info"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_envvars_info">[docs]</a><span class="k">def</span> <span class="nf">get_envvars_info</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PYTHON&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;LC_&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GIT_&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">var</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LANG&#39;</span><span class="p">,</span> <span class="s1">&#39;LANGUAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;PATH&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">envs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">envs</span><span class="p">)</span></div>


<span class="c1"># This class is modified from Snakemake (v5.1.4)</span>
<div class="viewcode-block" id="SequenceFormatter"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.SequenceFormatter">[docs]</a><span class="k">class</span> <span class="nc">SequenceFormatter</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;string.Formatter subclass with special behavior for sequences.</span>

<span class="sd">    This class delegates formatting of individual elements to another</span>
<span class="sd">    formatter object. Non-list objects are formatted by calling the</span>
<span class="sd">    delegate formatter&#39;s &quot;format_field&quot; method. List-like objects</span>
<span class="sd">    (list, tuple, set, frozenset) are formatted by formatting each</span>
<span class="sd">    element of the list according to the specified format spec using</span>
<span class="sd">    the delegate formatter and then joining the resulting strings with</span>
<span class="sd">    a separator (space by default).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">element_formatter</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(),</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="n">separator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element_formatter</span> <span class="o">=</span> <span class="n">element_formatter</span>

<div class="viewcode-block" id="SequenceFormatter.format_element"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.SequenceFormatter.format_element">[docs]</a>    <span class="k">def</span> <span class="nf">format_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">format_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Format a single element</span>

<span class="sd">        For sequences, this is called once for each element in a</span>
<span class="sd">        sequence. For anything else, it is called on the entire</span>
<span class="sd">        object. It is intended to be overridden in subclases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_formatter</span><span class="o">.</span><span class="n">format_field</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">format_spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="SequenceFormatter.format_field"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.SequenceFormatter.format_field">[docs]</a>    <span class="k">def</span> <span class="nf">format_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">format_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_element</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">format_spec</span><span class="p">)</span>
                                       <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_element</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">format_spec</span><span class="p">)</span></div></div>


<span class="c1"># TODO: eventually we might want to make use of attr module</span>
<div class="viewcode-block" id="File"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.File">[docs]</a><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper for a file entry in the create_tree/@with_tree</span>

<span class="sd">    It allows to define additional settings for entries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">          Name of the file</span>
<span class="sd">        executable: bool, optional</span>
<span class="sd">          Make it executable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">executable</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>


<div class="viewcode-block" id="create_tree_archive"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.create_tree_archive">[docs]</a><span class="k">def</span> <span class="nf">create_tree_archive</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">archives_leading_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an archive `name`, create under `path` with specified `load` tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datalad.support.archives</span> <span class="kn">import</span> <span class="n">compress_files</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">file_basename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">full_dirname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">full_dirname</span><span class="p">)</span>
    <span class="n">create_tree</span><span class="p">(</span><span class="n">full_dirname</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">archives_leading_dir</span><span class="o">=</span><span class="n">archives_leading_dir</span><span class="p">)</span>
    <span class="c1"># create archive</span>
    <span class="k">if</span> <span class="n">archives_leading_dir</span><span class="p">:</span>
        <span class="n">compress_files</span><span class="p">([</span><span class="n">dirname</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compress_files</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_dirname</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)))),</span>
                       <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pardir</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                       <span class="n">path</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dirname</span><span class="p">),</span>
                       <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
    <span class="c1"># remove original tree</span>
    <span class="n">rmtree</span><span class="p">(</span><span class="n">full_dirname</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_tree"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.create_tree">[docs]</a><span class="k">def</span> <span class="nf">create_tree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">archives_leading_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a list of tuples (name, load) create such a tree</span>

<span class="sd">    if load is a tuple itself -- that would create either a subtree or an archive</span>
<span class="sd">    with that content and place it into the tree if name ends with .tar.gz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Creating a tree under </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">file_</span><span class="p">,</span> <span class="n">load</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">File</span><span class="p">):</span>
            <span class="n">executable</span> <span class="o">=</span> <span class="n">file_</span><span class="o">.</span><span class="n">executable</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">file_</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">executable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">file_</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_existing</span> <span class="ow">and</span> <span class="n">lexists</span><span class="p">(</span><span class="n">full_name</span><span class="p">):</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">chmod_files</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar.gz&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
                <span class="n">create_tree_archive</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span>
                    <span class="n">archives_leading_dir</span><span class="o">=</span><span class="n">archives_leading_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">create_tree</span><span class="p">(</span>
                    <span class="n">full_name</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span>
                    <span class="n">archives_leading_dir</span><span class="o">=</span><span class="n">archives_leading_dir</span><span class="p">,</span>
                    <span class="n">remove_existing</span><span class="o">=</span><span class="n">remove_existing</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">open_func</span> <span class="o">=</span> <span class="nb">open</span>
            <span class="k">if</span> <span class="n">full_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
                <span class="n">open_func</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span>
            <span class="k">elif</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;xz&#39;</span><span class="p">,</span> <span class="s1">&#39;lzma&#39;</span><span class="p">):</span>
                <span class="kn">import</span> <span class="nn">lzma</span>
                <span class="n">open_func</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span>
            <span class="k">with</span> <span class="n">open_func</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ensure_bytes</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">executable</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IEXEC</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_suggestions_msg"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_suggestions_msg">[docs]</a><span class="k">def</span> <span class="nf">get_suggestions_msg</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">known</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        &quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a formatted string with suggestions for values given the known ones</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">difflib</span>
    <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>  <span class="c1"># might not want to do it if we change presentation below</span>
        <span class="n">suggestions</span> <span class="o">+=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">known</span><span class="p">)</span>
    <span class="n">suggestions</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Did you mean any of these?&quot;</span>
    <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">sep</span><span class="p">:</span>
            <span class="c1"># if separator includes new line - we add entire separator right away</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">sep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="bytes2human"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.bytes2human">[docs]</a><span class="k">def</span> <span class="nf">bytes2human</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(value).1f</span><span class="s1"> </span><span class="si">%(symbol)s</span><span class="s1">B&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert n bytes into a human readable string based on format.</span>
<span class="sd">    symbols can be either &quot;customary&quot;, &quot;customary_ext&quot;, &quot;iec&quot; or &quot;iec_ext&quot;,</span>
<span class="sd">    see: http://goo.gl/kTQMs</span>

<span class="sd">      &gt;&gt;&gt; from datalad.utils import bytes2human</span>
<span class="sd">      &gt;&gt;&gt; bytes2human(1)</span>
<span class="sd">      &#39;1.0 B&#39;</span>
<span class="sd">      &gt;&gt;&gt; bytes2human(1024)</span>
<span class="sd">      &#39;1.0 KB&#39;</span>
<span class="sd">      &gt;&gt;&gt; bytes2human(1048576)</span>
<span class="sd">      &#39;1.0 MB&#39;</span>
<span class="sd">      &gt;&gt;&gt; bytes2human(1099511627776127398123789121)</span>
<span class="sd">      &#39;909.5 YB&#39;</span>

<span class="sd">      &gt;&gt;&gt; bytes2human(10000, &quot;%(value).1f %(symbol)s/sec&quot;)</span>
<span class="sd">      &#39;9.8 K/sec&#39;</span>

<span class="sd">      &gt;&gt;&gt; # precision can be adjusted by playing with %f operator</span>
<span class="sd">      &gt;&gt;&gt; bytes2human(10000, format=&quot;%(value).5f %(symbol)s&quot;)</span>
<span class="sd">      &#39;9.76562 K&#39;</span>

<span class="sd">    Taken from: http://goo.gl/kTQMs and subsequently simplified</span>
<span class="sd">    Original Author: Giampaolo Rodola&#39; &lt;g.rodola [AT] gmail [DOT] com&gt;</span>
<span class="sd">    License: MIT</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n &lt; 0&quot;</span><span class="p">)</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">prefix</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">symbols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">prefix</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">prefix</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">format</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">format</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">n</span><span class="p">)</span></div>


<div class="viewcode-block" id="quote_cmdlinearg"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.quote_cmdlinearg">[docs]</a><span class="k">def</span> <span class="nf">quote_cmdlinearg</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform platform-appropriate argument quoting&quot;&quot;&quot;</span>
    <span class="c1"># https://stackoverflow.com/a/15262019</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">if</span> <span class="n">on_windows</span> <span class="k">else</span> <span class="n">shlex_quote</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span></div>


<div class="viewcode-block" id="guard_for_format"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.guard_for_format">[docs]</a><span class="k">def</span> <span class="nf">guard_for_format</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace { and } with {{ and }}</span>

<span class="sd">    To be used in cases if arg is not expected to have provided</span>
<span class="sd">    by user .format() placeholders, but &#39;arg&#39; might become a part</span>
<span class="sd">    of a composite passed to .format(), e.g. via &#39;Run&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;{{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;}}&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="join_cmdline"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.join_cmdline">[docs]</a><span class="k">def</span> <span class="nf">join_cmdline</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Join command line args into a string using quote_cmdlinearg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">quote_cmdlinearg</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span></div>


<div class="viewcode-block" id="split_cmdline"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.split_cmdline">[docs]</a><span class="k">def</span> <span class="nf">split_cmdline</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform platform-appropriate command line splitting.</span>

<span class="sd">    Identical to `shlex.split()` on non-windows platforms.</span>

<span class="sd">    Modified from https://stackoverflow.com/a/35900070</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">on_windows</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shlex_split</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1"># the rest is for windows</span>
    <span class="n">RE_CMD_LEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;&quot;((?:&quot;&quot;|\\[&quot;\\]|[^&quot;])*)&quot;?()|(\\\\(?=\\*&quot;)|\\&quot;)|(&amp;&amp;?|\|\|?|\d?&gt;|[&lt;])|([^\s&quot;&amp;|&lt;&gt;]+)|(\s+)|(.)&#39;&#39;&#39;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accu</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># collects pieces of one arg</span>
    <span class="k">for</span> <span class="n">qs</span><span class="p">,</span> <span class="n">qss</span><span class="p">,</span> <span class="n">esc</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">white</span><span class="p">,</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">RE_CMD_LEX</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">word</span><span class="p">:</span>
            <span class="k">pass</span>   <span class="c1"># most frequent</span>
        <span class="k">elif</span> <span class="n">esc</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">esc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">white</span> <span class="ow">or</span> <span class="n">pipe</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">accu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pipe</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
            <span class="n">accu</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">fail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid or incomplete shell string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">qs</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">qss</span>   <span class="c1"># may be even empty; must be last</span>

        <span class="n">accu</span> <span class="o">=</span> <span class="p">(</span><span class="n">accu</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">word</span>

    <span class="k">if</span> <span class="n">accu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accu</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">args</span></div>


<div class="viewcode-block" id="get_wrapped_class"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.get_wrapped_class">[docs]</a><span class="k">def</span> <span class="nf">get_wrapped_class</span><span class="p">(</span><span class="n">wrapped</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine the command class a wrapped __call__ belongs to&quot;&quot;&quot;</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span>
    <span class="n">command_class_name</span> <span class="o">=</span> <span class="n">wrapped</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">_func_class</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">command_class_name</span><span class="p">]</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Determined class of decorated function: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_func_class</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_func_class</span></div>


<span class="k">def</span> <span class="nf">_make_assure_kludge</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">old_name</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;ensure&quot;</span><span class="p">,</span> <span class="s2">&quot;assure&quot;</span><span class="p">)</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compat_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is deprecated and will be removed in a future release. &quot;</span>
            <span class="s2">&quot;Use </span><span class="si">{}</span><span class="s2"> instead.&quot;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
            <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">compat_fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Note: This function is deprecated. Use </span><span class="si">{}</span><span class="s2"> instead.&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">compat_fn</span>


<span class="n">assure_tuple_or_list</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_tuple_or_list</span><span class="p">)</span>
<span class="n">assure_iter</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_iter</span><span class="p">)</span>
<span class="n">assure_list</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_list</span><span class="p">)</span>
<span class="n">assure_list_from_str</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_list_from_str</span><span class="p">)</span>
<span class="n">assure_dict_from_str</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_dict_from_str</span><span class="p">)</span>
<span class="n">assure_bytes</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_bytes</span><span class="p">)</span>
<span class="n">assure_unicode</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_unicode</span><span class="p">)</span>
<span class="n">assure_bool</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_bool</span><span class="p">)</span>
<span class="n">assure_dir</span> <span class="o">=</span> <span class="n">_make_assure_kludge</span><span class="p">(</span><span class="n">ensure_dir</span><span class="p">)</span>


<span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Done importing datalad.utils&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="check_symlink_capability"><a class="viewcode-back" href="../../generated/datalad.utils.html#datalad.utils.check_symlink_capability">[docs]</a><span class="k">def</span> <span class="nf">check_symlink_capability</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper similar to datalad.tests.utils.has_symlink_capability</span>

<span class="sd">    However, for use in a datalad command context, we shouldn&#39;t</span>
<span class="sd">    assume to be able to write to tmpfile and also not import a whole lot from</span>
<span class="sd">    datalad&#39;s test machinery. Finally, we want to know, whether we can create a</span>
<span class="sd">    symlink at a specific location, not just somewhere. Therefore use</span>
<span class="sd">    arbitrary path to test-build a symlink and delete afterwards. Suitable</span>
<span class="sd">    location can therefore be determined by high lever code.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: Path</span>
<span class="sd">    target: Path</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">target</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
        <span class="n">path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">target</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, DataLad team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>