<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>datalad.tests.utils &mdash; DataLad 0.15.3+529.gc81453444.dirty documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> DataLad
            <img src="../../../_static/datalad_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.15
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgements.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../background.html">Background and motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../related.html">Delineation from related solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html">Basic principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credentials.html">Credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customization.html">Customization and extension of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/index.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cmdline.html">Command line reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modref.html">Python module reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html">Configuration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DataLad</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>datalad.tests.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for datalad.tests.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># emacs: -*- mode: python; py-indent-offset: 4; tab-width: 4; indent-tabs-mode: nil; coding: utf-8 -*-</span>
<span class="c1"># ex: set sts=4 ts=4 sw=4 et:</span>
<span class="c1"># ## ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##</span>
<span class="c1">#</span>
<span class="c1">#   See COPYING file distributed along with the datalad package for the</span>
<span class="c1">#   copyright and license terms.</span>
<span class="c1">#</span>
<span class="c1"># ## ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##</span>
<span class="sd">&quot;&quot;&quot;Miscellaneous utilities to assist with testing&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">lzma</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">multiprocessing.queues</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">unified_diff</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">import</span> <span class="nn">ssl</span>

<span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HTTPServer</span><span class="p">,</span>
    <span class="n">SimpleHTTPRequestHandler</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">curdir</span><span class="p">,</span>
    <span class="n">exists</span><span class="p">,</span>
    <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span><span class="p">,</span>
    <span class="n">relpath</span><span class="p">,</span>
    <span class="n">split</span> <span class="k">as</span> <span class="n">pathsplit</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">nose.plugins.attrib</span> <span class="kn">import</span> <span class="n">attr</span>
<span class="kn">from</span> <span class="nn">nose.tools</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">assert_equal</span><span class="p">,</span>
    <span class="n">assert_false</span><span class="p">,</span>
    <span class="n">assert_greater</span><span class="p">,</span>
    <span class="n">assert_greater_equal</span><span class="p">,</span>
    <span class="n">assert_in</span> <span class="k">as</span> <span class="n">in_</span><span class="p">,</span>
    <span class="n">assert_in</span><span class="p">,</span>
    <span class="n">assert_is</span><span class="p">,</span>
    <span class="n">assert_is_none</span><span class="p">,</span>
    <span class="n">assert_is_not</span><span class="p">,</span>
    <span class="n">assert_is_not_none</span><span class="p">,</span>
    <span class="n">assert_not_equal</span><span class="p">,</span>
    <span class="n">assert_not_in</span><span class="p">,</span>
    <span class="n">assert_not_is_instance</span><span class="p">,</span>
    <span class="n">assert_raises</span><span class="p">,</span>
    <span class="n">assert_true</span><span class="p">,</span>
    <span class="n">eq_</span><span class="p">,</span>
    <span class="n">make_decorator</span><span class="p">,</span>
    <span class="n">ok_</span><span class="p">,</span>
    <span class="n">raises</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">nose.tools</span> <span class="kn">import</span> <span class="n">assert_set_equal</span>
<span class="kn">from</span> <span class="nn">nose.tools</span> <span class="kn">import</span> <span class="n">assert_is_instance</span>
<span class="kn">from</span> <span class="nn">nose</span> <span class="kn">import</span> <span class="n">SkipTest</span>

<span class="kn">from</span> <span class="nn">datalad</span> <span class="kn">import</span> <span class="n">cfg</span> <span class="k">as</span> <span class="n">dl_cfg</span>
<span class="kn">import</span> <span class="nn">datalad.utils</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="c1"># TODO this must go</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datalad.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Path</span><span class="p">,</span>
    <span class="n">ensure_unicode</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">..support.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CommandError</span><span class="p">,</span>
    <span class="n">CommandNotAvailableError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..support.external_versions</span> <span class="kn">import</span> <span class="n">external_versions</span>
<span class="kn">from</span> <span class="nn">..support.vcr_</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..support.keyring_</span> <span class="kn">import</span> <span class="n">MemoryKeyring</span>
<span class="kn">from</span> <span class="nn">..support.network</span> <span class="kn">import</span> <span class="n">RI</span>
<span class="kn">from</span> <span class="nn">..dochelpers</span> <span class="kn">import</span> <span class="n">borrowkwargs</span>
<span class="kn">from</span> <span class="nn">..cmdline.helpers</span> <span class="kn">import</span> <span class="n">get_repo_instance</span>
<span class="kn">from</span> <span class="nn">..consts</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ARCHIVES_TEMP_DIR</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_TEMP_PATHS_GENERATED</span>
<span class="kn">from</span> <span class="nn">datalad.cmd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GitWitlessRunner</span><span class="p">,</span>
    <span class="n">KillOutput</span><span class="p">,</span>
    <span class="n">StdOutErrCapture</span><span class="p">,</span>
    <span class="n">WitlessRunner</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">datalad.core.local.repo</span> <span class="kn">import</span> <span class="n">repo_from_path</span>


<span class="c1"># temp paths used by clones</span>
<span class="n">_TEMP_PATHS_CLONES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


<span class="c1"># Additional indicators</span>
<span class="n">on_travis</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TRAVIS&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

<span class="k">if</span> <span class="n">external_versions</span><span class="p">[</span><span class="s2">&quot;cmd:git&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;2.28&quot;</span><span class="p">:</span>
    <span class="c1"># The specific value here doesn&#39;t matter, but it should not be the default</span>
    <span class="c1"># from any Git version to test that we work with custom values.</span>
    <span class="n">DEFAULT_BRANCH</span> <span class="o">=</span> <span class="s2">&quot;dl-test-branch&quot;</span>  <span class="c1"># Set by setup_package().</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">DEFAULT_BRANCH</span> <span class="o">=</span> <span class="s2">&quot;master&quot;</span>

<span class="k">if</span> <span class="n">external_versions</span><span class="p">[</span><span class="s2">&quot;cmd:git&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;2.30.0&quot;</span><span class="p">:</span>
    <span class="c1"># The specific value here doesn&#39;t matter, but it should not be the default</span>
    <span class="c1"># from any Git version to test that we work with custom values.</span>
    <span class="n">DEFAULT_REMOTE</span> <span class="o">=</span> <span class="s2">&quot;dl-test-remote&quot;</span>  <span class="c1"># Set by setup_package().</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">DEFAULT_REMOTE</span> <span class="o">=</span> <span class="s2">&quot;origin&quot;</span>

<span class="c1"># additional shortcuts</span>
<span class="n">neq_</span> <span class="o">=</span> <span class="n">assert_not_equal</span>
<span class="n">nok_</span> <span class="o">=</span> <span class="n">assert_false</span>

<span class="n">lgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;datalad.tests.utils&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="skip_if_no_module"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if_no_module">[docs]</a><span class="k">def</span> <span class="nf">skip_if_no_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">imp</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Module </span><span class="si">%s</span><span class="s2"> fails to load&quot;</span> <span class="o">%</span> <span class="n">module</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span></div>


<div class="viewcode-block" id="skip_if_scrapy_without_selector"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if_scrapy_without_selector">[docs]</a><span class="k">def</span> <span class="nf">skip_if_scrapy_without_selector</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A little helper to skip some tests which require recent scrapy&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scrapy</span>
        <span class="kn">from</span> <span class="nn">scrapy.selector</span> <span class="kn">import</span> <span class="n">Selector</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">nose</span> <span class="kn">import</span> <span class="n">SkipTest</span>
        <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span>
            <span class="s2">&quot;scrapy misses Selector (too old? version: </span><span class="si">%s</span><span class="s2">)&quot;</span>
            <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scrapy</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="skip_if_url_is_not_available"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if_url_is_not_available">[docs]</a><span class="k">def</span> <span class="nf">skip_if_url_is_not_available</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># verify that dataset is available</span>
    <span class="kn">from</span> <span class="nn">datalad.downloaders.providers</span> <span class="kn">import</span> <span class="n">Providers</span>
    <span class="kn">from</span> <span class="nn">datalad.downloaders.base</span> <span class="kn">import</span> <span class="n">DownloadError</span>
    <span class="n">providers</span> <span class="o">=</span> <span class="n">Providers</span><span class="o">.</span><span class="n">from_config_files</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regex</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> matched </span><span class="si">%r</span><span class="s2"> -- skipping the test&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">regex</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">DownloadError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> failed to download&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_not_generatorfunction"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.check_not_generatorfunction">[docs]</a><span class="k">def</span> <span class="nf">check_not_generatorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to verify that we are not decorating generator tests&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: must not be decorated, is a generator test&quot;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span></div>


<div class="viewcode-block" id="skip_if_no_network"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if_no_network">[docs]</a><span class="k">def</span> <span class="nf">skip_if_no_network</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip test completely in NONETWORK settings</span>

<span class="sd">    If not used as a decorator, and just a function, could be used at the module level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_not_generatorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_and_raise</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datalad.tests.nonetwork&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Skipping since no network settings&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;network&#39;</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_if_no_network&#39;</span><span class="p">)</span>
        <span class="k">def</span>  <span class="nf">_wrap_skip_if_no_network</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">check_and_raise</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span>  <span class="n">_wrap_skip_if_no_network</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_and_raise</span><span class="p">()</span></div>


<div class="viewcode-block" id="skip_if_on_windows"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if_on_windows">[docs]</a><span class="k">def</span> <span class="nf">skip_if_on_windows</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip test completely under Windows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_not_generatorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_and_raise</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Skipping on Windows&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_if_on_windows&#39;</span><span class="p">)</span>
        <span class="k">def</span>  <span class="nf">_wrap_skip_if_on_windows</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">check_and_raise</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span>  <span class="n">_wrap_skip_if_on_windows</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_and_raise</span><span class="p">()</span></div>


<div class="viewcode-block" id="skip_if_root"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if_root">[docs]</a><span class="k">def</span> <span class="nf">skip_if_root</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip test if uid == 0.</span>

<span class="sd">    Note that on Windows (or anywhere else `os.geteuid` is not available) the</span>
<span class="sd">    test is _not_ skipped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_not_generatorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_and_raise</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;geteuid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Skipping: test assumptions fail under root&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_if_root&#39;</span><span class="p">)</span>
        <span class="k">def</span>  <span class="nf">_wrap_skip_if_root</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">check_and_raise</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span>  <span class="n">_wrap_skip_if_root</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_and_raise</span><span class="p">()</span></div>


<div class="viewcode-block" id="skip_if"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">skip_if</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">cond</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip test for specific condition</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cond: bool</span>
<span class="sd">      condition on which to skip</span>
<span class="sd">    msg: str</span>
<span class="sd">      message to print if skipping</span>
<span class="sd">    method: str</span>
<span class="sd">      either &#39;raise&#39; or &#39;pass&#39;. Whether to skip by raising `SkipTest` or by</span>
<span class="sd">      just proceeding and simply not calling the decorated function.</span>
<span class="sd">      This is particularly meant to be used, when decorating single assertions</span>
<span class="sd">      in a test with method=&#39;pass&#39; in order to not skip the entire test, but</span>
<span class="sd">      just that assertion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">check_not_generatorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_skip_if</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;raise&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="n">msg</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="s2">&quot;condition was True&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;pass&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="s2">&quot;condition was True&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_skip_if</span></div>


<div class="viewcode-block" id="skip_ssh"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_ssh">[docs]</a><span class="k">def</span> <span class="nf">skip_ssh</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skips SSH tests if on windows or if environment variable</span>
<span class="sd">    DATALAD_TESTS_SSH was not set</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">check_not_generatorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_ssh&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_skip_ssh</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">test_ssh</span> <span class="o">=</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datalad.tests.ssh&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_ssh</span> <span class="ow">or</span> <span class="n">test_ssh</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Run this test by setting DATALAD_TESTS_SSH&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_skip_ssh</span></div>


<div class="viewcode-block" id="skip_nomultiplex_ssh"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_nomultiplex_ssh">[docs]</a><span class="k">def</span> <span class="nf">skip_nomultiplex_ssh</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skips SSH tests if default connection/manager does not support multiplexing</span>

<span class="sd">    e.g. currently on windows or if set via datalad.ssh.multiplex-connections config variable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">check_not_generatorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">..support.sshconnector</span> <span class="kn">import</span> <span class="n">MultiplexSSHManager</span><span class="p">,</span> <span class="n">SSHManager</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_nomultiplex_ssh&#39;</span><span class="p">)</span>
    <span class="nd">@skip_ssh</span>
    <span class="k">def</span>  <span class="nf">_wrap_skip_nomultiplex_ssh</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">SSHManager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MultiplexSSHManager</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;SSH without multiplexing is used&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_skip_nomultiplex_ssh</span></div>

<span class="c1">#</span>
<span class="c1"># Addition &quot;checkers&quot;</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datalad.support.gitrepo</span> <span class="kn">import</span> <span class="n">GitRepo</span>
<span class="kn">from</span> <span class="nn">datalad.support.annexrepo</span> <span class="kn">import</span> <span class="n">AnnexRepo</span><span class="p">,</span> <span class="n">FileNotInAnnexError</span>
<span class="kn">from</span> <span class="nn">datalad.distribution.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">chpwd</span><span class="p">,</span> <span class="n">getpwd</span>


<div class="viewcode-block" id="ok_clean_git"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_clean_git">[docs]</a><span class="k">def</span> <span class="nf">ok_clean_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">annex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_modified</span><span class="o">=</span><span class="p">[],</span> <span class="n">untracked</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Obsolete test helper. Use assert_repo_status() instead.</span>

<span class="sd">    Still maps a few common cases to the new helper, to ease transition</span>
<span class="sd">    in extensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">index_modified</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;modified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_modified</span>
    <span class="k">if</span> <span class="n">untracked</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;untracked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">untracked</span>
    <span class="n">assert_repo_status</span><span class="p">(</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">annex</span><span class="o">=</span><span class="n">annex</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="ok_file_under_git"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_file_under_git">[docs]</a><span class="k">def</span> <span class="nf">ok_file_under_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annexed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test if file is present and under git/annex control</span>

<span class="sd">    If relative path provided, then test from current directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annex</span><span class="p">,</span> <span class="n">file_repo_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">repo</span> <span class="o">=</span> <span class="n">_prep_file_under_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">assert_in</span><span class="p">(</span><span class="n">file_repo_path</span><span class="p">,</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_indexed_files</span><span class="p">())</span>  <span class="c1"># file is known to Git</span>

    <span class="k">if</span> <span class="n">annex</span><span class="p">:</span>
        <span class="n">in_annex</span> <span class="o">=</span> <span class="s1">&#39;key&#39;</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_file_annexinfo</span><span class="p">(</span><span class="n">file_repo_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">in_annex</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">annexed</span> <span class="o">==</span> <span class="n">in_annex</span><span class="p">)</span></div>


<div class="viewcode-block" id="put_file_under_git"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.put_file_under_git">[docs]</a><span class="k">def</span> <span class="nf">put_file_under_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annexed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Place file under git/annex and return used Repo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annex</span><span class="p">,</span> <span class="n">file_repo_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">repo</span> <span class="o">=</span> <span class="n">_prep_file_under_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">file_repo_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_</span><span class="p">:</span>
        <span class="n">f_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annexed</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">AnnexRepo</span><span class="p">):</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">AnnexRepo</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_repo_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_repo_path</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_datalad_msg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ok_file_under_git</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">file_repo_path</span><span class="p">,</span> <span class="n">annexed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">repo</span></div>


<span class="k">def</span> <span class="nf">_prep_file_under_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get instance of the repository for the given filename</span>

<span class="sd">    Helper to be used by few functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># path provides the path and the name</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_dataset_root</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">AnnexRepo</span><span class="p">),</span> \
        <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span> \
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">()</span> \
        <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span><span class="p">)),</span> \
        <span class="n">filename</span><span class="p">,</span> \
        <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> \
        <span class="n">ds</span><span class="o">.</span><span class="n">repo</span>


<span class="c1">#</span>
<span class="c1"># Helpers to test symlinks</span>
<span class="c1">#</span>

<div class="viewcode-block" id="ok_symlink"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_symlink">[docs]</a><span class="k">def</span> <span class="nf">ok_symlink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks whether path is either a working or broken symlink&quot;&quot;&quot;</span>
    <span class="n">link_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">link_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">{}</span><span class="s2"> seems not to be a symlink&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span></div>


<div class="viewcode-block" id="ok_good_symlink"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_good_symlink">[docs]</a><span class="k">def</span> <span class="nf">ok_good_symlink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">ok_symlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">rpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">ok_</span><span class="p">(</span><span class="n">rpath</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Path </span><span class="si">{}</span><span class="s2"> seems to be missing.  Symlink </span><span class="si">{}</span><span class="s2"> is broken&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rpath</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span></div>


<div class="viewcode-block" id="ok_broken_symlink"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_broken_symlink">[docs]</a><span class="k">def</span> <span class="nf">ok_broken_symlink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">ok_symlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">rpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">assert_false</span><span class="p">(</span><span class="n">rpath</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span>
            <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Path </span><span class="si">{}</span><span class="s2"> seems to be present.  Symlink </span><span class="si">{}</span><span class="s2"> is not broken&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">rpath</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span></div>


<div class="viewcode-block" id="ok_startswith"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_startswith">[docs]</a><span class="k">def</span> <span class="nf">ok_startswith</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">ok_</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;String </span><span class="si">%r</span><span class="s2"> doesn&#39;t start with </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span></div>


<div class="viewcode-block" id="ok_endswith"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_endswith">[docs]</a><span class="k">def</span> <span class="nf">ok_endswith</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
    <span class="n">ok_</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">),</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;String </span><span class="si">%r</span><span class="s2"> doesn&#39;t end with </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span></div>


<div class="viewcode-block" id="nok_startswith"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.nok_startswith">[docs]</a><span class="k">def</span> <span class="nf">nok_startswith</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">assert_false</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;String </span><span class="si">%r</span><span class="s2"> starts with </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span></div>


<div class="viewcode-block" id="ok_git_config_not_empty"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_git_config_not_empty">[docs]</a><span class="k">def</span> <span class="nf">ok_git_config_not_empty</span><span class="p">(</span><span class="n">ar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to verify that nothing rewritten the config file&quot;&quot;&quot;</span>
    <span class="c1"># TODO: we don&#39;t support bare -- do we?</span>
    <span class="n">assert_true</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;.git&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="ok_annex_get"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_annex_get">[docs]</a><span class="k">def</span> <span class="nf">ok_annex_get</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to run .get decorated checking for correct operation</span>

<span class="sd">    get passes through stderr from the ar to the user, which pollutes</span>
<span class="sd">    screen while running tests</span>

<span class="sd">    Note: Currently not true anymore, since usage of --json disables</span>
<span class="sd">    progressbars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ok_git_config_not_empty</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span> <span class="c1"># we should be working in already inited repo etc</span>
    <span class="k">with</span> <span class="n">swallow_outputs</span><span class="p">()</span> <span class="k">as</span> <span class="n">cmo</span><span class="p">:</span>
        <span class="n">ar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="c1"># verify that load was fetched</span>
    <span class="n">ok_git_config_not_empty</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span> <span class="c1"># whatever we do shouldn&#39;t destroy the config file</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">file_has_content</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">has_content</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">ok_</span><span class="p">(</span><span class="n">has_content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ok_</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">has_content</span><span class="p">))</span></div>


<div class="viewcode-block" id="ok_generator"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_generator">[docs]</a><span class="k">def</span> <span class="nf">ok_generator</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="n">assert_true</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isgenerator</span><span class="p">(</span><span class="n">gen</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a generator&quot;</span> <span class="o">%</span> <span class="n">gen</span><span class="p">)</span></div>


<span class="n">assert_is_generator</span> <span class="o">=</span> <span class="n">ok_generator</span>  <span class="c1"># just an alias</span>


<div class="viewcode-block" id="ok_archives_caches"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_archives_caches">[docs]</a><span class="k">def</span> <span class="nf">ok_archives_caches</span><span class="p">(</span><span class="n">repopath</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a path to repository verify number of archives</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    repopath : str</span>
<span class="sd">      Path to the repository</span>
<span class="sd">    n : int, optional</span>
<span class="sd">      Number of archives directories to expect</span>
<span class="sd">    persistent: bool or None, optional</span>
<span class="sd">      If None -- both persistent and not count.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># looking into subdirectories</span>
    <span class="n">glob_ptn</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">repopath</span><span class="p">,</span>
                   <span class="n">ARCHIVES_TEMP_DIR</span> <span class="o">+</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;-*&#39;</span><span class="p">}[</span><span class="n">persistent</span><span class="p">],</span>
                   <span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_ptn</span><span class="p">)</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># per each directory we should have a .stamp file</span>
    <span class="n">assert_equal</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirs</span><span class="p">),</span> <span class="n">n2</span><span class="p">,</span>
                 <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Found following dirs when needed </span><span class="si">%d</span><span class="s2"> of them: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">dirs</span><span class="p">))</span></div>


<div class="viewcode-block" id="ok_exists"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_exists">[docs]</a><span class="k">def</span> <span class="nf">ok_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="s1">&#39;path </span><span class="si">%s</span><span class="s1"> does not exist (or dangling symlink)&#39;</span> <span class="o">%</span> <span class="n">path</span></div>


<div class="viewcode-block" id="ok_file_has_content"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ok_file_has_content">[docs]</a><span class="k">def</span> <span class="nf">ok_file_has_content</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">re_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">decompress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that file exists and has expected content&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">ok_exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">decompress</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="n">open_func</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.xz&#39;</span><span class="p">,</span> <span class="s1">&#39;.lzma&#39;</span><span class="p">):</span>
            <span class="n">open_func</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to decompress </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">open_func</span> <span class="o">=</span> <span class="nb">open</span>

    <span class="k">with</span> <span class="n">open_func</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="c1"># for consistent comparisons etc. Apparently when reading in `b` mode</span>
        <span class="c1"># on Windows we would also get \r</span>
        <span class="c1"># https://github.com/datalad/datalad/pull/3049#issuecomment-444128715</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">file_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">file_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">re_</span><span class="p">:</span>
        <span class="n">assert_re_in</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">file_content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">assert_equal</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">file_content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1"># Decorators</span>
<span class="c1">#</span>


<div class="viewcode-block" id="with_tree"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_tree">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_tree</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">archives_leading_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">):</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_tree</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tkwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># if not specified otherwise, respect datalad.tests.temp.dir config</span>
            <span class="c1"># as this is a test helper</span>
            <span class="n">tkwargs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datalad.tests.temp.dir&quot;</span><span class="p">)</span>
        <span class="n">tkwargs_</span> <span class="o">=</span> <span class="n">get_tempfile_kwargs</span><span class="p">(</span><span class="n">tkwargs</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="o">**</span><span class="n">tkwargs_</span><span class="p">)</span>
        <span class="n">create_tree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">archives_leading_dir</span><span class="o">=</span><span class="n">archives_leading_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="p">,)),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
                <span class="n">rmtemp</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_with_tree</span></div>


<span class="n">lgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;datalad.tests&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="SilentHTTPHandler"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.SilentHTTPHandler">[docs]</a><span class="k">class</span> <span class="nc">SilentHTTPHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A little adapter to silence the handler</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span> <span class="o">=</span> <span class="n">lgr</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
        <span class="n">SimpleHTTPRequestHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SilentHTTPHandler.log_message"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.SilentHTTPHandler.log_message">[docs]</a>    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;HTTP: &quot;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_multiproc_serve_path_via_http</span><span class="p">(</span>
        <span class="n">hostname</span><span class="p">,</span> <span class="n">path_to_serve_from</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">SilentHTTPHandler</span>
    <span class="k">if</span> <span class="n">auth</span><span class="p">:</span>
        <span class="c1"># to-be-expected key for basic auth</span>
        <span class="n">auth_test</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Basic &#39;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span>
            <span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">auth</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c1"># ad-hoc basic-auth handler</span>
        <span class="k">class</span> <span class="nc">BasicAuthHandler</span><span class="p">(</span><span class="n">SilentHTTPHandler</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">do_HEAD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticated</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">authenticated</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span>
                        <span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="s1">&#39;Basic realm=</span><span class="se">\&quot;</span><span class="s1">Protected</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">auth_test</span><span class="p">:</span>
                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">do_GET</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_HEAD</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;Auth failed&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">BasicAuthHandler</span>

    <span class="n">chpwd</span><span class="p">(</span><span class="n">path_to_serve_from</span><span class="p">)</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">handler</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_ssl</span><span class="p">:</span>
        <span class="n">ca_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;ca&#39;</span>
        <span class="n">ssl_key</span> <span class="o">=</span> <span class="n">ca_dir</span> <span class="o">/</span> <span class="s1">&#39;certificate-key.pem&#39;</span>
        <span class="n">ssl_cert</span> <span class="o">=</span> <span class="n">ca_dir</span> <span class="o">/</span> <span class="s1">&#39;certificate-pub.pem&#39;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ssl_key</span><span class="p">,</span> <span class="n">ssl_cert</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;SSL requested, but no key/cert file combination can be &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;located under </span><span class="si">{</span><span class="n">ca_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># turn on SSL</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS_SERVER</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ssl_cert</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ssl_key</span><span class="p">))</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span> <span class="p">(</span>
            <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span>
            <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">httpd</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>


<div class="viewcode-block" id="HTTPPath"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.HTTPPath">[docs]</a><span class="k">class</span> <span class="nc">HTTPPath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Serve the content of a path via an HTTP URL.</span>

<span class="sd">    This class can be used as a context manager, in which case it returns the</span>
<span class="sd">    URL.</span>

<span class="sd">    Alternatively, the `start` and `stop` methods can be called directly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Directory with content to serve.</span>
<span class="sd">    use_ssl : bool</span>
<span class="sd">    auth : tuple</span>
<span class="sd">        Username, password</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_patch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mproc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="n">use_ssl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<div class="viewcode-block" id="HTTPPath.start"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.HTTPPath.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start serving `path` via HTTP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># There is a problem with Haskell on wheezy trying to</span>
        <span class="c1"># fetch via IPv6 whenever there is a ::1 localhost entry in</span>
        <span class="c1"># /etc/hosts.  Apparently fixing that docker image reliably</span>
        <span class="c1"># is not that straightforward, although see</span>
        <span class="c1"># http://jasonincode.com/customizing-hosts-file-in-docker/</span>
        <span class="c1"># so we just force to use 127.0.0.1 while on wheezy</span>
        <span class="c1">#hostname = &#39;127.0.0.1&#39; if on_debian_wheezy else &#39;localhost&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span><span class="p">:</span>
            <span class="c1"># we cannot use IPs with SSL certificates</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>

        <span class="n">queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mproc</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">_multiproc_serve_path_via_http</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">queue</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">use_ssl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mproc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">Empty</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;No working SSL support&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http</span><span class="si">{}</span><span class="s1">://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;HTTP: serving </span><span class="si">%s</span><span class="s2"> under </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># Such tests don&#39;t require real network so if http_proxy settings were</span>
        <span class="c1"># provided, we remove them from the env for the duration of this run</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;REQUESTS_CA_BUNDLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;ca&#39;</span> <span class="o">/</span> <span class="s1">&#39;ca_bundle.pem&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s1">&#39;os.environ&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_patch</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span><span class="p">:</span>
            <span class="c1"># verify that the SSL/cert setup is functional, if not skip the</span>
            <span class="c1"># test</span>
            <span class="c1"># python-requests does its own thing re root CA trust</span>
            <span class="c1"># if this fails, check datalad/tests/ca/prov.sh for ca_bundle</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">requests</span>
                <span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="c1"># be robust and skip if anything goes wrong, rather than just a</span>
            <span class="c1"># particular SSL issue</span>
            <span class="c1">#except requests.exceptions.SSLError as e:</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;No working HTTPS setup&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="c1"># now verify that the stdlib tooling also works</span>
            <span class="c1"># if this fails, check datalad/tests/ca/prov.sh</span>
            <span class="c1"># for info on deploying a datalad-root.crt</span>
            <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">urlopen</span><span class="p">,</span>
                <span class="n">Request</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">:</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
                        <span class="s2">&quot;Authorization&quot;</span><span class="p">,</span>
                        <span class="sa">b</span><span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">standard_b64encode</span><span class="p">(</span>
                            <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
                <span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="c1"># be robust and skip if anything goes wrong, rather than just a</span>
            <span class="c1"># particular SSL issue</span>
            <span class="c1">#except URLError as e:</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;No working HTTPS setup&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>

<div class="viewcode-block" id="HTTPPath.stop"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.HTTPPath.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop serving `path`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;HTTP: stopping server under </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_patch</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mproc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="serve_path_via_http"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.serve_path_via_http">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">serve_path_via_http</span><span class="p">(</span><span class="n">tfunc</span><span class="p">,</span> <span class="o">*</span><span class="n">targs</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator which serves content of a directory via http url</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Directory with content to serve.</span>
<span class="sd">    use_ssl : bool</span>
<span class="sd">        Flag whether to set up SSL encryption and return a HTTPS</span>
<span class="sd">        URL. This require a valid certificate setup (which is tested</span>
<span class="sd">        for proper function) or it will cause a SkipTest to be raised.</span>
<span class="sd">    auth : tuple or None</span>
<span class="sd">        If a (username, password) tuple is given, the server access will</span>
<span class="sd">        be protected via HTTP basic auth.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">tfunc</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;serve_path_via_http&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_serve_path_via_http</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">targs</span><span class="p">:</span>
            <span class="c1"># if a path is passed into serve_path_via_http, then it&#39;s in targs</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">targs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">targs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">HTTPPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="n">use_ssl</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tfunc</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">url</span><span class="p">)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_serve_path_via_http</span></div>


<div class="viewcode-block" id="with_memory_keyring"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_memory_keyring">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_memory_keyring</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to use non-persistant MemoryKeyring instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;with_memory_keyring&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_memory_keyring</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">keyring</span> <span class="o">=</span> <span class="n">MemoryKeyring</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;datalad.downloaders.credentials.keyring_&quot;</span><span class="p">,</span> <span class="n">keyring</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="n">keyring</span><span class="p">,)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">_wrap_with_memory_keyring</span></div>


<div class="viewcode-block" id="without_http_proxy"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.without_http_proxy">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">without_http_proxy</span><span class="p">(</span><span class="n">tfunc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to remove http*_proxy env variables for the duration of the test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">tfunc</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;without_http_proxy&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_without_http_proxy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;Unclear why this is not working on windows&#39;</span><span class="p">)</span>
        <span class="c1"># Such tests don&#39;t require real network so if http_proxy settings were</span>
        <span class="c1"># provided, we remove them from the env for the duration of this run</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s1">&#39;os.environ&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">_wrap_without_http_proxy</span></div>


<div class="viewcode-block" id="with_tempfile"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_tempfile">[docs]</a><span class="nd">@borrowkwargs</span><span class="p">(</span><span class="n">methodname</span><span class="o">=</span><span class="n">make_tempfile</span><span class="p">)</span>
<span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_tempfile</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator function to provide a temporary file name and remove it at the end</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    To change the used directory without providing keyword argument &#39;dir&#39; set</span>
<span class="sd">    DATALAD_TESTS_TEMP_DIR.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    ::</span>

<span class="sd">        @with_tempfile</span>
<span class="sd">        def test_write(tfile):</span>
<span class="sd">            open(tfile, &#39;w&#39;).write(&#39;silly test&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_tempfile</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tkwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># if not specified otherwise, respect datalad.tests.temp.dir config</span>
            <span class="c1"># as this is a test helper</span>
            <span class="n">tkwargs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datalad.tests.temp.dir&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">make_tempfile</span><span class="p">(</span><span class="n">wrapped</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="p">(</span><span class="n">filename</span><span class="p">,)),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">_wrap_with_tempfile</span></div>


<span class="c1"># ### ###</span>
<span class="c1"># START known failure decorators</span>
<span class="c1"># ### ###</span>

<div class="viewcode-block" id="probe_known_failure"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.probe_known_failure">[docs]</a><span class="k">def</span> <span class="nf">probe_known_failure</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test decorator allowing the test to pass when it fails and vice versa</span>

<span class="sd">    Setting config datalad.tests.knownfailures.probe to True tests, whether or</span>
<span class="sd">    not the test is still failing. If it&#39;s not, an AssertionError is raised in</span>
<span class="sd">    order to indicate that the reason for failure seems to be gone.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;probe_known_failure&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_probe_known_failure</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">obtain</span><span class="p">(</span><span class="s2">&quot;datalad.tests.knownfailures.probe&quot;</span><span class="p">):</span>
            <span class="n">assert_raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># marked as known failure</span>
            <span class="c1"># Note: Since assert_raises lacks a `msg` argument, a comment</span>
            <span class="c1"># in the same line is helpful to determine what&#39;s going on whenever</span>
            <span class="c1"># this assertion fails and we see a trace back. Otherwise that line</span>
            <span class="c1"># wouldn&#39;t be very telling.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_probe_known_failure</span></div>


<div class="viewcode-block" id="skip_known_failure"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_known_failure">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">skip_known_failure</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test decorator allowing to skip a test that is known to fail</span>

<span class="sd">    Setting config datalad.tests.knownfailures.skip to a bool enables/disables</span>
<span class="sd">    skipping.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@skip_if</span><span class="p">(</span><span class="n">cond</span><span class="o">=</span><span class="n">dl_cfg</span><span class="o">.</span><span class="n">obtain</span><span class="p">(</span><span class="s2">&quot;datalad.tests.knownfailures.skip&quot;</span><span class="p">),</span>
             <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Skip test known to fail&quot;</span><span class="p">,</span>
             <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_known_failure&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_skip_known_failure</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_skip_known_failure</span></div>


<div class="viewcode-block" id="known_failure"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.known_failure">[docs]</a><span class="k">def</span> <span class="nf">known_failure</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test decorator marking a test as known to fail</span>

<span class="sd">    This combines `probe_known_failure` and `skip_known_failure` giving the</span>
<span class="sd">    skipping precedence over the probing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@skip_known_failure</span>
    <span class="nd">@probe_known_failure</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;known_failure&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_known_failure</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_known_failure</span></div>


<div class="viewcode-block" id="known_failure_direct_mode"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.known_failure_direct_mode">[docs]</a><span class="k">def</span> <span class="nf">known_failure_direct_mode</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DEPRECATED.  Stop using.  Does nothing</span>

<span class="sd">    Test decorator marking a test as known to fail in a direct mode test run</span>

<span class="sd">    If datalad.repo.direct is set to True behaves like `known_failure`.</span>
<span class="sd">    Otherwise the original (undecorated) function is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: consider adopting   nibabel/deprecated.py  nibabel/deprecator.py</span>
    <span class="c1"># mechanism to consistently deprecate functionality and ensure they are</span>
    <span class="c1"># displayed.</span>
    <span class="c1"># Since 2.7 Deprecation warnings aren&#39;t displayed by default</span>
    <span class="c1"># and thus kinda pointless to issue a warning here, so we will just log</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Direct mode support is deprecated, so no point in using &quot;</span> \
          <span class="s2">&quot;@known_failure_direct_mode for </span><span class="si">%r</span><span class="s2"> since glorious future &quot;</span> \
          <span class="s2">&quot;DataLad 0.12&quot;</span> <span class="o">%</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="known_failure_windows"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.known_failure_windows">[docs]</a><span class="k">def</span> <span class="nf">known_failure_windows</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test decorator marking a test as known to fail on windows</span>

<span class="sd">    On Windows behaves like `known_failure`.</span>
<span class="sd">    Otherwise the original (undecorated) function is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>

        <span class="nd">@known_failure</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;known_failure_windows&#39;</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;windows&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">dm_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dm_func</span>
    <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="known_failure_githubci_win"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.known_failure_githubci_win">[docs]</a><span class="k">def</span> <span class="nf">known_failure_githubci_win</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test decorator for a known test failure on Github&#39;s Windows CI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;GITHUB_WORKFLOW&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="n">on_windows</span><span class="p">:</span>
        <span class="nd">@known_failure</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;known_failure_githubci_win&#39;</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;githubci_win&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">dm_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dm_func</span>
    <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="known_failure_githubci_osx"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.known_failure_githubci_osx">[docs]</a><span class="k">def</span> <span class="nf">known_failure_githubci_osx</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test decorator for a known test failure on Github&#39;s macOS CI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;GITHUB_WORKFLOW&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="n">on_osx</span><span class="p">:</span>
        <span class="nd">@known_failure</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;known_failure_githubci_osx&#39;</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;githubci_osx&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">dm_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dm_func</span>
    <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="known_failure_osx"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.known_failure_osx">[docs]</a><span class="k">def</span> <span class="nf">known_failure_osx</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test decorator for a known test failure on macOS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">on_osx</span><span class="p">:</span>
        <span class="nd">@known_failure</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;known_failure_osx&#39;</span><span class="p">)</span>
        <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;osx&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">dm_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dm_func</span>
    <span class="k">return</span> <span class="n">func</span></div>

<span class="c1"># ### ###</span>
<span class="c1"># END known failure decorators</span>
<span class="c1"># ### ###</span>


<span class="k">def</span> <span class="nf">_get_resolved_flavors</span><span class="p">(</span><span class="n">flavors</span><span class="p">):</span>
    <span class="c1">#flavors_ = ([&#39;local&#39;, &#39;clone&#39;] + ([&#39;local-url&#39;] if not on_windows else [])) \</span>
    <span class="c1">#           if flavors == &#39;auto&#39; else flavors</span>
    <span class="n">flavors_</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;clone&#39;</span><span class="p">,</span> <span class="s1">&#39;local-url&#39;</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">on_windows</span>
                <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">,</span> <span class="s1">&#39;network-clone&#39;</span><span class="p">])</span> \
               <span class="k">if</span> <span class="n">flavors</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="k">else</span> <span class="n">flavors</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flavors_</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">flavors_</span> <span class="o">=</span> <span class="p">[</span><span class="n">flavors_</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datalad.tests.nonetwork&#39;</span><span class="p">):</span>
        <span class="n">flavors_</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flavors_</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;network&#39;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">flavors_</span>


<div class="viewcode-block" id="clone_url"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.clone_url">[docs]</a><span class="k">def</span> <span class="nf">clone_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">GitWitlessRunner</span><span class="p">()</span>
    <span class="n">tdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="o">**</span><span class="n">get_tempfile_kwargs</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datalad.tests.temp.dir&quot;</span><span class="p">)},</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;clone_url&#39;</span><span class="p">))</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;clone&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">tdir</span><span class="p">],</span> <span class="n">protocol</span><span class="o">=</span><span class="n">KillOutput</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">GitRepo</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span><span class="o">.</span><span class="n">is_with_annex</span><span class="p">():</span>
        <span class="n">AnnexRepo</span><span class="p">(</span><span class="n">tdir</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_TEMP_PATHS_CLONES</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tdir</span></div>


<span class="n">local_testrepo_flavors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]</span> <span class="c1"># &#39;local-url&#39;</span>

<span class="n">_TESTREPOS</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">_get_testrepos_uris</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">flavors</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_TESTREPOS</span>
    <span class="c1"># we should instantiate those whenever test repos actually asked for</span>
    <span class="c1"># TODO: just absorb all this lazy construction within some class</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_TESTREPOS</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.utils_testrepos</span> <span class="kn">import</span> <span class="n">BasicAnnexTestRepo</span><span class="p">,</span> <span class="n">BasicGitTestRepo</span><span class="p">,</span> \
            <span class="n">SubmoduleDataset</span><span class="p">,</span> <span class="n">NestedDataset</span><span class="p">,</span> <span class="n">InnerSubmodule</span>

        <span class="n">_basic_annex_test_repo</span> <span class="o">=</span> <span class="n">BasicAnnexTestRepo</span><span class="p">()</span>
        <span class="n">_basic_git_test_repo</span> <span class="o">=</span> <span class="n">BasicGitTestRepo</span><span class="p">()</span>
        <span class="n">_submodule_annex_test_repo</span> <span class="o">=</span> <span class="n">SubmoduleDataset</span><span class="p">()</span>
        <span class="n">_nested_submodule_annex_test_repo</span> <span class="o">=</span> <span class="n">NestedDataset</span><span class="p">()</span>
        <span class="n">_inner_submodule_annex_test_repo</span> <span class="o">=</span> <span class="n">InnerSubmodule</span><span class="p">()</span>
        <span class="n">_TESTREPOS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;basic_annex&#39;</span><span class="p">:</span>
                        <span class="p">{</span><span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/datalad/testrepo--basic--r1&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">_basic_annex_test_repo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                         <span class="s1">&#39;local-url&#39;</span><span class="p">:</span> <span class="n">_basic_annex_test_repo</span><span class="o">.</span><span class="n">url</span><span class="p">},</span>
                      <span class="s1">&#39;basic_git&#39;</span><span class="p">:</span>
                        <span class="p">{</span><span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">_basic_git_test_repo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                         <span class="s1">&#39;local-url&#39;</span><span class="p">:</span> <span class="n">_basic_git_test_repo</span><span class="o">.</span><span class="n">url</span><span class="p">},</span>
                      <span class="s1">&#39;submodule_annex&#39;</span><span class="p">:</span>
                        <span class="p">{</span><span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">_submodule_annex_test_repo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                         <span class="s1">&#39;local-url&#39;</span><span class="p">:</span> <span class="n">_submodule_annex_test_repo</span><span class="o">.</span><span class="n">url</span><span class="p">},</span>
                      <span class="s1">&#39;nested_submodule_annex&#39;</span><span class="p">:</span>
                        <span class="p">{</span><span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">_nested_submodule_annex_test_repo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                         <span class="s1">&#39;local-url&#39;</span><span class="p">:</span> <span class="n">_nested_submodule_annex_test_repo</span><span class="o">.</span><span class="n">url</span><span class="p">},</span>
                      <span class="c1"># TODO: append &#39;annex&#39; to the name:</span>
                      <span class="c1"># Currently doesn&#39;t work with some annex tests, despite</span>
                      <span class="c1"># working manually. So, figure out how the tests&#39; setup</span>
                      <span class="c1"># messes things up with this one.</span>
                      <span class="s1">&#39;inner_submodule&#39;</span><span class="p">:</span>
                        <span class="p">{</span><span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">_inner_submodule_annex_test_repo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                         <span class="s1">&#39;local-url&#39;</span><span class="p">:</span> <span class="n">_inner_submodule_annex_test_repo</span><span class="o">.</span><span class="n">url</span><span class="p">}</span>
                      <span class="p">}</span>
        <span class="c1"># assure that now we do have those test repos created -- delayed</span>
        <span class="c1"># their creation until actually used</span>
        <span class="n">_basic_annex_test_repo</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">_basic_git_test_repo</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">_submodule_annex_test_repo</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">_nested_submodule_annex_test_repo</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">_inner_submodule_annex_test_repo</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">uris</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">_TESTREPOS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">uris</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spec</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">flavors</span><span class="p">)]</span>

        <span class="c1"># additional flavors which might have not been</span>
        <span class="k">if</span> <span class="s1">&#39;clone&#39;</span> <span class="ow">in</span> <span class="n">flavors</span> <span class="ow">and</span> <span class="s1">&#39;clone&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clone_url</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="s1">&#39;network-clone&#39;</span> <span class="ow">in</span> <span class="n">flavors</span> \
                <span class="ow">and</span> <span class="s1">&#39;network&#39;</span> <span class="ow">in</span> <span class="n">spec</span> \
                <span class="ow">and</span> <span class="s1">&#39;network-clone&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clone_url</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">uris</span>


<div class="viewcode-block" id="with_testrepos"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_testrepos">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_testrepos</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">flavors</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to provide a local/remote test repository</span>

<span class="sd">    All tests under datalad/tests/testrepos are stored in two-level hierarchy,</span>
<span class="sd">    where top-level name describes nature/identifier of the test repository,</span>
<span class="sd">    and there could be multiple instances (e.g. generated differently) of the</span>
<span class="sd">    same &quot;content&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regex : string, optional</span>
<span class="sd">      Regex to select which test repos to use</span>
<span class="sd">    flavors : {&#39;auto&#39;, &#39;local&#39;, &#39;local-url&#39;, &#39;clone&#39;, &#39;network&#39;, &#39;network-clone&#39;} or list of thereof, optional</span>
<span class="sd">      What URIs to provide.  E.g. &#39;local&#39; would just provide path to the</span>
<span class="sd">      repository, while &#39;network&#39; would provide url of the remote location</span>
<span class="sd">      available on Internet containing the test repository.  &#39;clone&#39; would</span>
<span class="sd">      clone repository first to a temporary location. &#39;network-clone&#39; would</span>
<span class="sd">      first clone from the network location. &#39;auto&#39; would include the list of</span>
<span class="sd">      appropriate ones (e.g., no &#39;network*&#39; flavors if network tests are</span>
<span class="sd">      &quot;forbidden&quot;).</span>
<span class="sd">    count: int, optional</span>
<span class="sd">      If specified, only up to that number of repositories to test with</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from datalad.tests.utils import with_testrepos</span>
<span class="sd">    &gt;&gt;&gt; @with_testrepos(&#39;basic_annex&#39;)</span>
<span class="sd">    ... def test_write(repo):</span>
<span class="sd">    ...    assert(os.path.exists(os.path.join(repo, &#39;.git&#39;, &#39;annex&#39;)))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;with_testrepos&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_testrepos</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># addurls with our generated file:// URLs doesn&#39;t work on appveyor</span>
        <span class="c1"># https://ci.appveyor.com/project/mih/datalad/builds/29841505/job/330rwn2a3cvtrakj</span>
        <span class="c1">#if &#39;APPVEYOR&#39; in os.environ:</span>
        <span class="c1">#    raise SkipTest(&quot;Testrepo setup is broken on AppVeyor&quot;)</span>
        <span class="c1"># TODO: would need to either avoid this &quot;decorator&quot; approach for</span>
        <span class="c1"># parametric tests or again aggregate failures like sweepargs does</span>
        <span class="n">flavors_</span> <span class="o">=</span> <span class="n">_get_resolved_flavors</span><span class="p">(</span><span class="n">flavors</span><span class="p">)</span>

        <span class="n">testrepos_uris</span> <span class="o">=</span> <span class="n">_get_testrepos_uris</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">flavors_</span><span class="p">)</span>
        <span class="c1"># we should always have at least one repo to test on, unless explicitly only</span>
        <span class="c1"># network was requested by we are running without networked tests</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datalad.tests.nonetwork&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">flavors</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]):</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">testrepos_uris</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">testrepos_uris</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;No non-networked repos to test on&quot;</span><span class="p">)</span>

        <span class="n">fake_dates</span> <span class="o">=</span> <span class="n">dl_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datalad.fake-dates&quot;</span><span class="p">)</span>
        <span class="n">ntested</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">testrepos_uris</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="ow">and</span> <span class="n">ntested</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">ntested</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="p">(</span><span class="n">uri</span><span class="p">,)),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># The is_explicit_path check is needed because it may be a URL,</span>
                <span class="c1"># but check_dates needs a local path or GitRepo object.</span>
                <span class="k">if</span> <span class="n">fake_dates</span> <span class="ow">and</span> <span class="n">is_explicit_path</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
                    <span class="kn">from</span> <span class="nn">..support.repodates</span> <span class="kn">import</span> <span class="n">check_dates</span>
                    <span class="n">assert_false</span><span class="p">(</span>
                        <span class="n">check_dates</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">annex</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">)[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">_TEMP_PATHS_CLONES</span><span class="p">:</span>
                    <span class="n">_TEMP_PATHS_CLONES</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                    <span class="n">rmtemp</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                <span class="k">pass</span>  <span class="c1"># might need to provide additional handling so, handle</span>
    <span class="k">return</span>  <span class="n">_wrap_with_testrepos</span></div>
<span class="n">with_testrepos</span><span class="o">.</span><span class="n">__test__</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="with_sameas_remote"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_sameas_remote">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_sameas_remote</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">autoenabled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide a repository with a git-annex sameas remote configured.</span>

<span class="sd">    The repository will have two special remotes: r_dir (type=directory) and</span>
<span class="sd">    r_rsync (type=rsync). The rsync remote will be configured with</span>
<span class="sd">    --sameas=r_dir, and autoenabled if `autoenabled` is true.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datalad.support.annexrepo</span> <span class="kn">import</span> <span class="n">AnnexRepo</span>
    <span class="kn">from</span> <span class="nn">datalad.support.exceptions</span> <span class="kn">import</span> <span class="n">CommandError</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;with_sameas_remotes&#39;</span><span class="p">)</span>
    <span class="nd">@skip_if_on_windows</span>
    <span class="nd">@skip_ssh</span>
    <span class="nd">@with_tempfile</span><span class="p">(</span><span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@with_tempfile</span><span class="p">(</span><span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_sameas_remote</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># With git-annex&#39;s 8.20200522-77-g1f2e2d15e, transferring from an rsync</span>
        <span class="c1"># special remote hangs on Xenial. This is likely due to an interaction</span>
        <span class="c1"># with an older rsync or openssh version. Use openssh as a rough</span>
        <span class="c1"># indicator. See</span>
        <span class="c1"># https://git-annex.branchable.com/bugs/Recent_hang_with_rsync_remote_with_older_systems___40__Xenial__44___Jessie__41__/</span>
        <span class="k">if</span> <span class="n">external_versions</span><span class="p">[</span><span class="s1">&#39;cmd:system-ssh&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s1">&#39;7.4&#39;</span> <span class="ow">and</span> \
           <span class="s1">&#39;8.20200522&#39;</span> <span class="o">&lt;</span> <span class="n">external_versions</span><span class="p">[</span><span class="s1">&#39;cmd:annex&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s1">&#39;8.20200720&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Test known to hang&quot;</span><span class="p">)</span>

        <span class="n">sr_path</span><span class="p">,</span> <span class="n">repo_path</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">fn_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">AnnexRepo</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">init_remote</span><span class="p">(</span><span class="s2">&quot;r_dir&quot;</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;type=directory&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;encryption=none&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;directory=&quot;</span> <span class="o">+</span> <span class="n">sr_path</span><span class="p">])</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;type=rsync&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;rsyncurl=datalad-test:&quot;</span> <span class="o">+</span> <span class="n">sr_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">autoenabled</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;autoenable=true&quot;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--sameas=r_dir&quot;</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">init_remote</span><span class="p">(</span><span class="s2">&quot;r_rsync&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">fn_args</span> <span class="o">+</span> <span class="p">(</span><span class="n">repo</span><span class="p">,)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_with_sameas_remote</span></div>


<div class="viewcode-block" id="with_fake_cookies_db"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_fake_cookies_db">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_fake_cookies_db</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;mock original cookies db with a fake one for the duration of the test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">..support.cookies</span> <span class="kn">import</span> <span class="n">cookies_db</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;with_fake_cookies_db&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_fake_cookies_db</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">orig_cookies_db</span> <span class="o">=</span> <span class="n">cookies_db</span><span class="o">.</span><span class="n">_cookies_db</span>
            <span class="n">cookies_db</span><span class="o">.</span><span class="n">_cookies_db</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">cookies_db</span><span class="o">.</span><span class="n">_cookies_db</span> <span class="o">=</span> <span class="n">orig_cookies_db</span>
    <span class="k">return</span>  <span class="n">_wrap_with_fake_cookies_db</span></div>


<div class="viewcode-block" id="assert_cwd_unchanged"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_cwd_unchanged">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">assert_cwd_unchanged</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ok_to_chdir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to test whether the current working directory remains unchanged</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ok_to_chdir: bool, optional</span>
<span class="sd">      If True, allow to chdir, so this decorator would not then raise exception</span>
<span class="sd">      if chdir&#39;ed but only return to original directory</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_assert_cwd_unchanged</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cwd_before</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">pwd_before</span> <span class="o">=</span> <span class="n">getpwd</span><span class="p">()</span>
        <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># record previous state of PWD handling</span>
        <span class="n">utils_pwd_mode</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_pwd_mode</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">_pwd_mode</span> <span class="o">=</span> <span class="n">utils_pwd_mode</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cwd_after</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to getcwd: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">cwd_after</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">cwd_after</span> <span class="o">!=</span> <span class="n">cwd_before</span><span class="p">:</span>
            <span class="n">chpwd</span><span class="p">(</span><span class="n">pwd_before</span><span class="p">)</span>
            <span class="c1"># Above chpwd could also trigger the change of _pwd_mode, so we</span>
            <span class="c1"># would need to reset it again since we know that it is all kosher</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">_pwd_mode</span> <span class="o">=</span> <span class="n">utils_pwd_mode</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok_to_chdir</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> changed cwd to </span><span class="si">%s</span><span class="s2">. Mitigating and changing back to </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">cwd_after</span><span class="p">,</span> <span class="n">pwd_before</span><span class="p">))</span>
                <span class="c1"># If there was already exception raised, we better reraise</span>
                <span class="c1"># that one since it must be more important, so not masking it</span>
                <span class="c1"># here with our assertion</span>
                <span class="k">if</span> <span class="n">exc_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">assert_equal</span><span class="p">(</span><span class="n">cwd_before</span><span class="p">,</span> <span class="n">cwd_after</span><span class="p">,</span>
                                 <span class="s2">&quot;CWD changed from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cwd_before</span><span class="p">,</span> <span class="n">cwd_after</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">exc_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">return</span>  <span class="n">_wrap_assert_cwd_unchanged</span></div>


<div class="viewcode-block" id="run_under_dir"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.run_under_dir">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">run_under_dir</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">newdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to run tests under another directory</span>

<span class="sd">    It is somewhat ugly since we can&#39;t really chdir</span>
<span class="sd">    back to a directory which had a symlink in its path.</span>
<span class="sd">    So using this decorator has potential to move entire</span>
<span class="sd">    testing run under the dereferenced directory name -- sideeffect.</span>

<span class="sd">    The only way would be to instruct testing framework (i.e. nose</span>
<span class="sd">    in our case ATM) to run a test by creating a new process with</span>
<span class="sd">    a new cwd</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_run_under_dir</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">pwd_before</span> <span class="o">=</span> <span class="n">getpwd</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chpwd</span><span class="p">(</span><span class="n">newdir</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">chpwd</span><span class="p">(</span><span class="n">pwd_before</span><span class="p">)</span>


    <span class="k">return</span>  <span class="n">_wrap_run_under_dir</span></div>


<div class="viewcode-block" id="assert_re_in"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_re_in">[docs]</a><span class="k">def</span> <span class="nf">assert_re_in</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assert that container (list, str, etc) contains entry matching the regex</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">)(</span><span class="n">regex</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">):</span>
            <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
        <span class="n">msg</span> <span class="ow">or</span> <span class="s2">&quot;Not a single entry matched </span><span class="si">%r</span><span class="s2"> in </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="assert_dict_equal"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_dict_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_dict_equal</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
    <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">d2</span><span class="p">):</span>
        <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; keys in the first dict but not in the second: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">d2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">d1</span><span class="p">):</span>
        <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; keys in the second dict but not in the first: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">d1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">d2</span><span class="p">):</span>
        <span class="n">same</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># do not compare types for string types to avoid all the hassle</span>
                <span class="c1"># with the distinction of str and unicode in PY3, and simple</span>
                <span class="c1"># test for equality</span>
                <span class="n">same</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">same</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># if comparison or conversion to bool (e.g. with numpy arrays) fails</span>
            <span class="n">same</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">same</span><span class="p">:</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; [</span><span class="si">%r</span><span class="s2">] differs: </span><span class="si">%r</span><span class="s2"> != </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;and more&quot;</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">msgs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;dicts differ:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgs</span><span class="p">))</span>
    <span class="c1"># do generic comparison just in case we screwed up to detect difference correctly above</span>
    <span class="n">eq_</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_str_equal"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_str_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_str_equal</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to compare two lines&quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unified_diff</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">s2</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">diff</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">assert_equal</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_status"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_status">[docs]</a><span class="k">def</span> <span class="nf">assert_status</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that each status dict in the results has a given status label</span>

<span class="sd">    `label` can be a sequence, in which case status must be one of the items</span>
<span class="sd">    in this sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">assert_in</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">assert_in</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Test </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">: expected status </span><span class="si">{}</span><span class="s1"> not found in:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                <span class="n">label</span><span class="p">,</span>
                <span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span></div>


<div class="viewcode-block" id="assert_message"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_message">[docs]</a><span class="k">def</span> <span class="nf">assert_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that each status dict in the results has a message</span>

<span class="sd">    This only tests the message template string, and not a formatted message</span>
<span class="sd">    with args expanded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">assert_in</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="n">assert_equal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_format_res</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span>
        <span class="n">dumps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">)</span>


<div class="viewcode-block" id="assert_result_count"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_result_count">[docs]</a><span class="k">def</span> <span class="nf">assert_result_count</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify specific number of results (matching criteria, if any)&quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span> <span class="o">==</span> <span class="n">count</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s1">&#39;Got </span><span class="si">{}</span><span class="s1"> instead of </span><span class="si">{}</span><span class="s1"> expected results matching</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Inspected </span><span class="si">{}</span><span class="s1"> record(s):</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">count</span><span class="p">,</span>
                <span class="n">n</span><span class="p">,</span>
                <span class="n">_format_res</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                <span class="n">_format_res</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">_check_results_in</span><span class="p">(</span><span class="n">should_contain</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">found</span> <span class="o">^</span> <span class="n">should_contain</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">should_contain</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Desired result</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">not found among</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Result</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">unexpectedly found among</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_format_res</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),</span>
                                        <span class="n">_format_res</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>


<div class="viewcode-block" id="assert_in_results"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_in_results">[docs]</a><span class="k">def</span> <span class="nf">assert_in_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that the particular combination of keys and values is found in</span>
<span class="sd">    one of the results&quot;&quot;&quot;</span>
    <span class="n">_check_results_in</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_not_in_results"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_not_in_results">[docs]</a><span class="k">def</span> <span class="nf">assert_not_in_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that the particular combination of keys and values is not in any</span>
<span class="sd">    of the results&quot;&quot;&quot;</span>
    <span class="n">_check_results_in</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_result_values_equal"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_result_values_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_result_values_equal</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that the values of all results for a given key in the status dicts</span>
<span class="sd">    match the given sequence&quot;&quot;&quot;</span>
    <span class="n">assert_equal</span><span class="p">(</span>
        <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
        <span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_result_values_cond"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_result_values_cond">[docs]</a><span class="k">def</span> <span class="nf">assert_result_values_cond</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that the values of all results for a given key in the status dicts</span>
<span class="sd">    fulfill condition `cond`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results:</span>
<span class="sd">    prop: str</span>
<span class="sd">    cond: callable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">ok_</span><span class="p">(</span><span class="n">cond</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">prop</span><span class="p">]),</span>
            <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;r[</span><span class="si">{prop}</span><span class="s2">]: </span><span class="si">{value}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="n">prop</span><span class="p">]))</span></div>


<div class="viewcode-block" id="ignore_nose_capturing_stdout"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.ignore_nose_capturing_stdout">[docs]</a><span class="k">def</span> <span class="nf">ignore_nose_capturing_stdout</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DEPRECATED and will be removed soon.  Does nothing!</span>

<span class="sd">    Originally was intended as a decorator workaround for nose&#39;s behaviour</span>
<span class="sd">    with redirecting sys.stdout, but now we monkey patch nose now so no test</span>
<span class="sd">    should no longer be skipped.</span>

<span class="sd">    See issue reported here:</span>
<span class="sd">    https://code.google.com/p/python-nose/issues/detail?id=243&amp;can=1&amp;sort=-id&amp;colspec=ID%20Type%20Status%20Priority%20Stars%20Milestone%20Owner%20Summary</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;@ignore_nose_capturing_stdout no longer does anything - nose should &quot;</span>
        <span class="s2">&quot;just be monkey patched in setup_package. </span><span class="si">{}</span><span class="s2"> still has it&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="skip_httpretty_on_problematic_pythons"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_httpretty_on_problematic_pythons">[docs]</a><span class="k">def</span> <span class="nf">skip_httpretty_on_problematic_pythons</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;As discovered some httpretty bug causes a side-effect</span>
<span class="sd">    on other tests on some Pythons.  So we skip the test if such</span>
<span class="sd">    problematic combination detected</span>

<span class="sd">    References</span>
<span class="sd">    https://travis-ci.org/datalad/datalad/jobs/94464988</span>
<span class="sd">    http://stackoverflow.com/a/29603206/1265472</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@make_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_skip_httpretty_on_problematic_pythons</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Known to cause trouble due to httpretty bug on this Python&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_skip_httpretty_on_problematic_pythons</span></div>


<div class="viewcode-block" id="with_parametric_batch"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_parametric_batch">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_parametric_batch</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to run parametric test with possible combinations of batch and direct</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_parametric_batch</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">batch</span>

    <span class="k">return</span>  <span class="n">_wrap_with_parametric_batch</span></div>


<span class="c1"># List of most obscure filenames which might or not be supported by different</span>
<span class="c1"># filesystems across different OSs.  Start with the most obscure</span>
<span class="n">OBSCURE_PREFIX</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DATALAD_TESTS_OBSCURE_PREFIX&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="c1"># Those will be tried to be added to the base name if filesystem allows</span>
<span class="n">OBSCURE_FILENAME_PARTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;%b5&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">]</span>
<span class="n">UNICODE_FILENAME</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;ΔЙקم๗あ&quot;</span>

<span class="c1"># OSX is exciting -- some I guess FS might be encoding differently from decoding</span>
<span class="c1"># so Й might get recoded</span>
<span class="c1"># (ref: https://github.com/datalad/datalad/pull/1921#issuecomment-385809366)</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">on_osx</span><span class="p">:</span>
        <span class="c1"># TODO: figure it really out</span>
        <span class="n">UNICODE_FILENAME</span> <span class="o">=</span> <span class="n">UNICODE_FILENAME</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Й&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">on_windows</span><span class="p">:</span>
        <span class="c1"># TODO: really figure out unicode handling on windows</span>
        <span class="n">UNICODE_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">UNICODE_FILENAME</span><span class="p">:</span>
        <span class="n">OBSCURE_FILENAME_PARTS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNICODE_FILENAME</span><span class="p">)</span>
<span class="c1"># space before extension, simple extension and trailing space to finish it up</span>
<span class="n">OBSCURE_FILENAME_PARTS</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;.datc&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">]</span>


<div class="viewcode-block" id="get_most_obscure_supported_name"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.get_most_obscure_supported_name">[docs]</a><span class="nd">@with_tempfile</span><span class="p">(</span><span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_most_obscure_supported_name</span><span class="p">(</span><span class="n">tdir</span><span class="p">,</span> <span class="n">return_candidates</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the most obscure filename that the filesystem would support under TEMPDIR</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    return_candidates: bool, optional</span>
<span class="sd">      if True, return a tuple of (good, candidates) where candidates are &quot;partially&quot;</span>
<span class="sd">      sorted from trickiest considered</span>
<span class="sd">    TODO: we might want to use it as a function where we would provide tdir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># we need separate good_base so we do not breed leading/trailing spaces</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">good</span> <span class="o">=</span> <span class="n">OBSCURE_PREFIX</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

    <span class="n">OBSCURE_FILENAMES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">good_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">OBSCURE_FILENAMES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Windows seems to not tollerate trailing spaces and</span>
            <span class="c1"># ATM we do not distinguish obscure filename and dirname.</span>
            <span class="c1"># So here we will test for both - being able to create dir</span>
            <span class="c1"># with obscure name and obscure filename under</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">tdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">tdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;TEST LOAD&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Filename </span><span class="si">%r</span><span class="s2"> is not supported on </span><span class="si">%s</span><span class="s2"> under </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="n">filename</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">tdir</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># incrementally build up the most obscure filename from parts</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">OBSCURE_FILENAME_PARTS</span><span class="p">:</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="n">good</span> <span class="o">+</span> <span class="n">part</span>
        <span class="k">if</span> <span class="n">good_filename</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
            <span class="n">good</span> <span class="o">=</span> <span class="n">candidate</span>

    <span class="k">if</span> <span class="n">good</span> <span class="o">==</span> <span class="n">initial</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not create any of the files under </span><span class="si">%s</span><span class="s2"> among </span><span class="si">%s</span><span class="s2">&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">tdir</span><span class="p">,</span> <span class="n">OBSCURE_FILENAMES</span><span class="p">))</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tested </span><span class="si">%d</span><span class="s2"> obscure filename candidates. The winner: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OBSCURE_FILENAMES</span><span class="p">),</span> <span class="n">good</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_candidates</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">good</span><span class="p">,</span> <span class="n">OBSCURE_FILENAMES</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">good</span></div>


<span class="n">OBSCURE_FILENAME</span><span class="p">,</span> <span class="n">OBSCURE_FILENAMES</span> <span class="o">=</span> <span class="n">get_most_obscure_supported_name</span><span class="p">(</span><span class="n">return_candidates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="with_testsui"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.with_testsui">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">with_testsui</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Switch main UI to be &#39;tests&#39; UI and possibly provide answers to be used&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_with_testsui</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">datalad.ui</span> <span class="kn">import</span> <span class="n">ui</span>
        <span class="n">old_backend</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">backend</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ui</span><span class="o">.</span><span class="n">set_backend</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span> <span class="k">if</span> <span class="n">interactive</span> <span class="k">else</span> <span class="s1">&#39;tests-noninteractive&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">responses</span><span class="p">:</span>
                <span class="n">ui</span><span class="o">.</span><span class="n">add_responses</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">responses</span><span class="p">:</span>
                <span class="n">responses_left</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">get_responses</span><span class="p">()</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses_left</span><span class="p">),</span> <span class="s2">&quot;Some responses were left not used: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">responses_left</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">ui</span><span class="o">.</span><span class="n">set_backend</span><span class="p">(</span><span class="n">old_backend</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span> <span class="ow">and</span> <span class="n">responses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-interactive UI cannot provide responses&quot;</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">_wrap_with_testsui</span></div>

<span class="n">with_testsui</span><span class="o">.</span><span class="n">__test__</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="assert_no_errors_logged"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_no_errors_logged">[docs]</a><span class="k">def</span> <span class="nf">assert_no_errors_logged</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">skip_re</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator around function to assert that no errors logged during its execution&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_assert_no_errors_logged</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">swallow_logs</span><span class="p">(</span><span class="n">new_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span> <span class="k">as</span> <span class="n">cml</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cml</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">skip_re</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">skip_re</span><span class="p">,</span> <span class="n">cml</span><span class="o">.</span><span class="n">out</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="s2">&quot;Expected no errors to be logged, but log output is </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">cml</span><span class="o">.</span><span class="n">out</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">return</span>  <span class="n">_wrap_assert_no_errors_logged</span></div>


<div class="viewcode-block" id="get_mtimes_and_digests"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.get_mtimes_and_digests">[docs]</a><span class="k">def</span> <span class="nf">get_mtimes_and_digests</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return digests (md5) and mtimes for all the files under target_path&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datalad.utils</span> <span class="kn">import</span> <span class="n">find_files</span>
    <span class="kn">from</span> <span class="nn">datalad.support.digests</span> <span class="kn">import</span> <span class="n">Digester</span>
    <span class="n">digester</span> <span class="o">=</span> <span class="n">Digester</span><span class="p">([</span><span class="s1">&#39;md5&#39;</span><span class="p">])</span>

    <span class="c1"># bother only with existing ones for this test, i.e. skip annexed files without content</span>
    <span class="n">target_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">find_files</span><span class="p">(</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">topdir</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span> <span class="n">exclude_vcs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_datalad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># let&#39;s leave only relative paths for easier analysis</span>
    <span class="n">target_files_</span> <span class="o">=</span> <span class="p">[</span><span class="n">relpath</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">target_files</span><span class="p">]</span>

    <span class="n">digests</span> <span class="o">=</span> <span class="p">{</span><span class="n">frel</span><span class="p">:</span> <span class="n">digester</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">frel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_files</span><span class="p">,</span> <span class="n">target_files_</span><span class="p">)}</span>
    <span class="n">mtimes</span> <span class="o">=</span> <span class="p">{</span><span class="n">frel</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">frel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_files</span><span class="p">,</span> <span class="n">target_files_</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">digests</span><span class="p">,</span> <span class="n">mtimes</span></div>


<div class="viewcode-block" id="get_datasets_topdir"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.get_datasets_topdir">[docs]</a><span class="k">def</span> <span class="nf">get_datasets_topdir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delayed parsing so it could be monkey patched etc&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datalad.consts</span> <span class="kn">import</span> <span class="n">DATASETS_TOPURL</span>
    <span class="k">return</span> <span class="n">RI</span><span class="p">(</span><span class="n">DATASETS_TOPURL</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span></div>


<div class="viewcode-block" id="assert_repo_status"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.assert_repo_status">[docs]</a><span class="k">def</span> <span class="nf">assert_repo_status</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">annex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked_mode</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare a repo status against (optional) exceptions.</span>

<span class="sd">    Anything file/directory that is not explicitly indicated must have</span>
<span class="sd">    state &#39;clean&#39;, i.e. no modifications and recorded in Git.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str or Repo</span>
<span class="sd">      in case of a str: path to the repository&#39;s base dir;</span>
<span class="sd">      Note, that passing a Repo instance prevents detecting annex. This might</span>
<span class="sd">      be useful in case of a non-initialized annex, a GitRepo is pointing to.</span>
<span class="sd">    annex: bool or None</span>
<span class="sd">      explicitly set to True or False to indicate, that an annex is (not)</span>
<span class="sd">      expected; set to None to autodetect, whether there is an annex.</span>
<span class="sd">      Default: None.</span>
<span class="sd">    untracked_mode: {&#39;no&#39;, &#39;normal&#39;, &#39;all&#39;}</span>
<span class="sd">      If and how untracked content is reported. The specification of untracked</span>
<span class="sd">      files that are OK to be found must match this mode. See `Repo.status()`</span>
<span class="sd">    **kwargs</span>
<span class="sd">      Files/directories that are OK to not be in &#39;clean&#39; state. Each argument</span>
<span class="sd">      must be one of &#39;added&#39;, &#39;untracked&#39;, &#39;deleted&#39;, &#39;modified&#39; and each</span>
<span class="sd">      value must be a list of filenames (relative to the root of the</span>
<span class="sd">      repository, in POSIX convention).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">AnnexRepo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">annex</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># if `annex` was set to False, but we find an annex =&gt; fail</span>
        <span class="n">assert_is</span><span class="p">(</span><span class="n">annex</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">GitRepo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">annex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">annex</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># explicitly given GitRepo instance doesn&#39;t make sense with</span>
        <span class="c1"># &#39;annex&#39; True</span>
        <span class="n">assert_is</span><span class="p">(</span><span class="n">annex</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># &#39;path&#39; is an actual path</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">AnnexRepo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">annex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">annex</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if `annex` was set to False, but we find an annex =&gt; fail</span>
            <span class="n">assert_is</span><span class="p">(</span><span class="n">annex</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Instantiation failed =&gt; no annex</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">GitRepo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find an annex or a git &quot;</span>
                                     <span class="s2">&quot;repository at </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">annex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">annex</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># explicitly given GitRepo instance doesn&#39;t make sense with</span>
            <span class="c1"># &#39;annex&#39; True</span>
            <span class="n">assert_is</span><span class="p">(</span><span class="n">annex</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">untracked</span><span class="o">=</span><span class="n">untracked_mode</span><span class="p">)</span>
    <span class="c1"># for any file state that indicates some kind of change (all but &#39;clean)</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;added&#39;</span><span class="p">,</span> <span class="s1">&#39;untracked&#39;</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">):</span>
        <span class="n">oktobefound</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">pathobj</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                             <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">state_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">eq_</span><span class="p">(</span><span class="n">state_files</span><span class="p">,</span> <span class="n">oktobefound</span><span class="p">,</span>
            <span class="s1">&#39;unexpected content of state &quot;</span><span class="si">%s</span><span class="s1">&quot;: </span><span class="si">%r</span><span class="s1"> != </span><span class="si">%r</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state_files</span><span class="p">,</span> <span class="n">oktobefound</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_convoluted_situation"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.get_convoluted_situation">[docs]</a><span class="k">def</span> <span class="nf">get_convoluted_situation</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">repocls</span><span class="o">=</span><span class="n">AnnexRepo</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">datalad.api</span> <span class="kn">import</span> <span class="n">create</span>

    <span class="c1">#if &#39;APPVEYOR&#39; in os.environ:</span>
    <span class="c1">#    # issue only happens on appveyor, Python itself implodes</span>
    <span class="c1">#    # cannot be reproduced on a real windows box</span>
    <span class="c1">#    raise SkipTest(</span>
    <span class="c1">#        &#39;get_convoluted_situation() causes appveyor to crash, &#39;</span>
    <span class="c1">#        &#39;reason unknown&#39;)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">repocls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># use create(force) to get an ID and config into the empty repo</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># base content</span>
    <span class="n">create_tree</span><span class="p">(</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;.gitignore&#39;</span><span class="p">:</span> <span class="s1">&#39;*.ignored&#39;</span><span class="p">,</span>
            <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;file_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;file_clean&#39;</span><span class="p">,</span>
                <span class="s1">&#39;file_deleted&#39;</span><span class="p">:</span> <span class="s1">&#39;file_deleted&#39;</span><span class="p">,</span>
                <span class="s1">&#39;file_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_clean&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;subdir-only-ignored&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;1.ignored&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;file_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;file_clean&#39;</span><span class="p">,</span>
            <span class="s1">&#39;file_deleted&#39;</span><span class="p">:</span> <span class="s1">&#39;file_deleted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;file_staged_deleted&#39;</span><span class="p">:</span> <span class="s1">&#39;file_staged_deleted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;file_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_clean&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">AnnexRepo</span><span class="p">):</span>
        <span class="n">create_tree</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;file_dropped_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;file_dropped_clean&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;file_dropped_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;file_dropped_clean&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">AnnexRepo</span><span class="p">):</span>
        <span class="c1"># some files straight in git</span>
        <span class="n">create_tree</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;file_ingit_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;file_ingit_clean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;file_ingit_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_ingit_clean&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;file_ingit_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;file_ingit_clean&#39;</span><span class="p">,</span>
                <span class="s1">&#39;file_ingit_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_ingit_clean&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">to_git</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span>
            <span class="s1">&#39;file_dropped_clean&#39;</span><span class="p">,</span>
            <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;file_dropped_clean&#39;</span><span class="p">)],</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># clean and proper subdatasets</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;subds_clean&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_clean&#39;</span><span class="p">))</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;subds_unavailable_clean&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_unavailable_clean&#39;</span><span class="p">))</span>
    <span class="c1"># uninstall some subdatasets (still clean)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span>
        <span class="s1">&#39;subds_unavailable_clean&#39;</span><span class="p">,</span>
        <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_unavailable_clean&#39;</span><span class="p">)],</span>
        <span class="n">what</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">reckless</span><span class="o">=</span><span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">assert_repo_status</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># make a dirty subdataset</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;subds_modified&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subds_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;someds&#39;</span><span class="p">))</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subds_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;someds&#39;</span><span class="p">,</span> <span class="s1">&#39;dirtyds&#39;</span><span class="p">))</span>
    <span class="c1"># make a subdataset with additional commits</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_modified&#39;</span><span class="p">))</span>
    <span class="n">pdspath</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;progressedds&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pdspath</span><span class="p">)</span>
    <span class="n">create_tree</span><span class="p">(</span>
        <span class="n">pdspath</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;file_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;file_ingit_clean&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">Dataset</span><span class="p">(</span><span class="n">pdspath</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">assert_repo_status</span><span class="p">(</span><span class="n">pdspath</span><span class="p">)</span>
    <span class="c1"># staged subds, and files</span>
    <span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;subds_added&#39;</span><span class="p">))</span>
    <span class="c1"># use internal helper to get subdataset into an &#39;added&#39; state</span>
    <span class="c1"># that would not happen in standard datalad workflows</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">_save_add_submodules</span><span class="p">([</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;subds_added&#39;</span><span class="p">]))</span>
    <span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_added&#39;</span><span class="p">))</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">_save_add_submodules</span><span class="p">([</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;subdir&#39;</span> <span class="o">/</span> <span class="s1">&#39;subds_added&#39;</span><span class="p">]))</span>
    <span class="c1"># some more untracked files</span>
    <span class="n">create_tree</span><span class="p">(</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;file_untracked&#39;</span><span class="p">:</span> <span class="s1">&#39;file_untracked&#39;</span><span class="p">,</span>
                <span class="s1">&#39;file_added&#39;</span><span class="p">:</span> <span class="s1">&#39;file_added&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;file_untracked&#39;</span><span class="p">:</span> <span class="s1">&#39;file_untracked&#39;</span><span class="p">,</span>
            <span class="s1">&#39;file_added&#39;</span><span class="p">:</span> <span class="s1">&#39;file_added&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dir_untracked&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;file_untracked&#39;</span><span class="p">:</span> <span class="s1">&#39;file_untracked&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;subds_modified&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;someds&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;dirtyds&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;file_untracked&#39;</span><span class="p">:</span> <span class="s1">&#39;file_untracked&#39;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s1">&#39;file_added&#39;</span><span class="p">,</span> <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;file_added&#39;</span><span class="p">)])</span>
    <span class="c1"># untracked subdatasets</span>
    <span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;subds_untracked&#39;</span><span class="p">))</span>
    <span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_untracked&#39;</span><span class="p">))</span>
    <span class="c1"># deleted files</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;file_deleted&#39;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;file_deleted&#39;</span><span class="p">))</span>
    <span class="c1"># staged deletion</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;file_staged_deleted&#39;</span><span class="p">)</span>
    <span class="c1"># modified files</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">AnnexRepo</span><span class="p">):</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">unlock</span><span class="p">([</span><span class="s1">&#39;file_modified&#39;</span><span class="p">,</span> <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;file_modified&#39;</span><span class="p">)])</span>
        <span class="n">create_tree</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;file_ingit_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_ingit_modified&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;file_ingit_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_ingit_modified&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="n">create_tree</span><span class="p">(</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;file_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_modified&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;file_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_modified&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="get_deeply_nested_structure"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.get_deeply_nested_structure">[docs]</a><span class="k">def</span> <span class="nf">get_deeply_nested_structure</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Here is what this does (assuming UNIX, locked):</span>
<span class="sd">    |  .</span>
<span class="sd">    |  ├── directory_untracked</span>
<span class="sd">    |  │  └── link2dir -&gt; ../subdir</span>
<span class="sd">    |  ├── OBSCURE_FILENAME_file_modified</span>
<span class="sd">    |  ├── link2dir -&gt; subdir</span>
<span class="sd">    |  ├── link2subdsdir -&gt; subds_modified/subdir</span>
<span class="sd">    |  ├── link2subdsroot -&gt; subds_modified</span>
<span class="sd">    |  ├── subdir</span>
<span class="sd">    |  │   ├── annexed_file.txt -&gt; ../.git/annex/objects/...</span>
<span class="sd">    |  │   ├── file_modified</span>
<span class="sd">    |  │   ├── git_file.txt</span>
<span class="sd">    |  │   └── link2annex_files.txt -&gt; annexed_file.txt</span>
<span class="sd">    |  └── subds_modified</span>
<span class="sd">    |      ├── link2superdsdir -&gt; ../subdir</span>
<span class="sd">    |      ├── subdir</span>
<span class="sd">    |      │   └── annexed_file.txt -&gt; ../.git/annex/objects/...</span>
<span class="sd">    |      └── subds_lvl1_modified</span>
<span class="sd">    |          └── OBSCURE_FILENAME_directory_untracked</span>
<span class="sd">    |              └── untracked_file</span>

<span class="sd">    When a system has no symlink support, the link2... components are not</span>
<span class="sd">    included.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;subdir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;subdir&#39;</span> <span class="o">/</span> <span class="s1">&#39;annexed_file.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;dummy&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;subdir&#39;</span> <span class="o">/</span> <span class="s1">&#39;git_file.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;dummy&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">to_git</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># a subtree of datasets</span>
    <span class="n">subds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;subds_modified&#39;</span><span class="p">)</span>
    <span class="c1"># another dataset, plus an additional dir in it</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subds_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;subds_lvl1_modified&#39;</span><span class="p">))</span>
    <span class="n">create_tree</span><span class="p">(</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;file_modified&#39;</span><span class="p">:</span> <span class="s1">&#39;file_modified&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">OBSCURE_FILENAME</span> <span class="o">+</span> <span class="sa">u</span><span class="s1">&#39;file_modified_&#39;</span><span class="p">:</span> <span class="s1">&#39;file_modified&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">create_tree</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;subds_modified&#39;</span> <span class="o">/</span> <span class="s1">&#39;subds_lvl1_modified&#39;</span><span class="p">),</span>
        <span class="p">{</span><span class="n">OBSCURE_FILENAME</span> <span class="o">+</span> <span class="sa">u</span><span class="s1">&#39;_directory_untracked&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;untracked_file&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}}</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">subds</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;subdir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">subds</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;subdir&#39;</span> <span class="o">/</span> <span class="s1">&#39;annexed_file.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;dummy&#39;</span><span class="p">)</span>
    <span class="n">subds</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;directory_untracked&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_symlink_capability</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="c1"># symlink farm #1</span>
    <span class="c1"># symlink to annexed file</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;subdir&#39;</span> <span class="o">/</span> <span class="s1">&#39;link2annex_files.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span>
        <span class="s1">&#39;annexed_file.txt&#39;</span><span class="p">)</span>
    <span class="c1"># symlink to directory within the dataset</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;link2dir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">)</span>
    <span class="c1"># upwards pointing symlink to directory within the same dataset</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;directory_untracked&#39;</span> <span class="o">/</span> <span class="s1">&#39;link2dir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span>
        <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">))</span>
    <span class="c1"># symlink pointing to a subdataset mount in the same dataset</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;link2subdsroot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="s1">&#39;subds_modified&#39;</span><span class="p">)</span>
    <span class="c1"># symlink to a dir in a subdataset (across dataset boundaries)</span>
    <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;link2subdsdir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span>
        <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;subds_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">))</span>
    <span class="c1"># symlink to a dir in a superdataset (across dataset boundaries)</span>
    <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">subds</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;link2superdsdir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span>
        <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="maybe_adjust_repo"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.maybe_adjust_repo">[docs]</a><span class="k">def</span> <span class="nf">maybe_adjust_repo</span><span class="p">(</span><span class="n">repo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Put repo into an adjusted branch if it is not already.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="o">.</span><span class="n">is_managed_branch</span><span class="p">():</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">call_annex</span><span class="p">([</span><span class="s2">&quot;upgrade&quot;</span><span class="p">])</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">adjust</span><span class="p">()</span></div>


<div class="viewcode-block" id="has_symlink_capability"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.has_symlink_capability">[docs]</a><span class="nd">@with_tempfile</span>
<span class="nd">@with_tempfile</span>
<span class="k">def</span> <span class="nf">has_symlink_capability</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">check_symlink_capability</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="skip_wo_symlink_capability"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_wo_symlink_capability">[docs]</a><span class="k">def</span> <span class="nf">skip_wo_symlink_capability</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip test when environment does not support symlinks</span>

<span class="sd">    Perform a behavioral test instead of top-down logic, as on</span>
<span class="sd">    windows this could be on or off on a case-by-case basis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_wo_symlink_capability&#39;</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_skip_wo_symlink_capability</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_symlink_capability</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;no symlink capabilities&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">_wrap_skip_wo_symlink_capability</span></div>


<span class="n">_TESTS_ADJUSTED_TMPDIR</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="skip_if_adjusted_branch"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.skip_if_adjusted_branch">[docs]</a><span class="k">def</span> <span class="nf">skip_if_adjusted_branch</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip test if adjusted branch is used by default on TMPDIR file system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;skip_if_adjusted_branch&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_wrap_skip_if_adjusted_branch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">_TESTS_ADJUSTED_TMPDIR</span>
        <span class="k">if</span> <span class="n">_TESTS_ADJUSTED_TMPDIR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nd">@with_tempfile</span>
            <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">is_managed_branch</span><span class="p">()</span>
            <span class="n">_TESTS_ADJUSTED_TMPDIR</span> <span class="o">=</span> <span class="n">_check</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">_TESTS_ADJUSTED_TMPDIR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Test incompatible with adjusted branch default&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_wrap_skip_if_adjusted_branch</span></div>


<div class="viewcode-block" id="get_ssh_port"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.get_ssh_port">[docs]</a><span class="k">def</span> <span class="nf">get_ssh_port</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get port of `host` in ssh_config.</span>

<span class="sd">    Our tests depend on the host being defined in ssh_config, including its</span>
<span class="sd">    port. This method can be used by tests that want to check handling of an</span>
<span class="sd">    explicitly specified</span>

<span class="sd">    Note that if `host` does not match a host in ssh_config, the default value</span>
<span class="sd">    of 22 is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    host : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    port (int)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    SkipTest if port cannot be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">WitlessRunner</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;ssh&quot;</span><span class="p">,</span> <span class="s2">&quot;-G&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">],</span> <span class="n">protocol</span><span class="o">=</span><span class="n">StdOutErrCapture</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

    <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;port &quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;port for </span><span class="si">{}</span><span class="s2"> could not be determined: </span><span class="si">{}</span><span class="s2">&quot;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">port</span></div>


<span class="c1">#</span>
<span class="c1"># Context Managers</span>
<span class="c1">#</span>


<div class="viewcode-block" id="patch_config"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.patch_config">[docs]</a><span class="k">def</span> <span class="nf">patch_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Patch our config with custom settings. Returns mock.patch cm</span>

<span class="sd">    Only the merged configuration from all sources (global, local, dataset)</span>
<span class="sd">    will be patched. Source-constrained patches (e.g. only committed dataset</span>
<span class="sd">    configuration) are not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">dl_cfg</span><span class="o">.</span><span class="n">_merged_store</span><span class="p">,</span> <span class="nb">vars</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_date"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.set_date">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">set_date</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Temporarily override environment variables for git/git-annex dates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timestamp : int</span>
<span class="sd">        Unix timestamp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">git_ts</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">{}</span><span class="s2"> +0000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s2">&quot;os.environ&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;GIT_COMMITTER_DATE&quot;</span><span class="p">:</span> <span class="n">git_ts</span><span class="p">,</span>
                     <span class="s2">&quot;GIT_AUTHOR_DATE&quot;</span><span class="p">:</span> <span class="n">git_ts</span><span class="p">,</span>
                     <span class="s2">&quot;GIT_ANNEX_VECTOR_CLOCK&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
                     <span class="s2">&quot;DATALAD_FAKE__DATES&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">}):</span>
        <span class="k">yield</span></div>


<div class="viewcode-block" id="set_annex_version"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.set_annex_version">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">set_annex_version</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Override the git-annex version.</span>

<span class="sd">    This temporarily masks the git-annex version present in external_versions</span>
<span class="sd">    and make AnnexRepo forget its cached version information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datalad.support.annexrepo</span> <span class="kn">import</span> <span class="n">AnnexRepo</span>
    <span class="n">ar_vers</span> <span class="o">=</span> <span class="n">AnnexRepo</span><span class="o">.</span><span class="n">git_annex_version</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span>
            <span class="s2">&quot;datalad.support.annexrepo.external_versions._versions&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;cmd:annex&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">}):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AnnexRepo</span><span class="o">.</span><span class="n">git_annex_version</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">AnnexRepo</span><span class="o">.</span><span class="n">git_annex_version</span> <span class="o">=</span> <span class="n">ar_vers</span></div>

<span class="c1">#</span>
<span class="c1"># Test tags</span>
<span class="c1">#</span>
<span class="c1"># To be explicit, and not &quot;loose&quot; some tests due to typos, decided to make</span>
<span class="c1"># explicit decorators for common types</span>

<span class="kn">from</span> <span class="nn">nose.plugins.attrib</span> <span class="kn">import</span> <span class="n">attr</span>


<div class="viewcode-block" id="integration"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.integration">[docs]</a><span class="k">def</span> <span class="nf">integration</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark test as an &quot;integration&quot; test which generally is not needed to be run</span>
<span class="sd">    </span>
<span class="sd">    Generally tend to be slower.</span>
<span class="sd">    Should be used in combination with @slow and @turtle if that is the case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attr</span><span class="p">(</span><span class="s1">&#39;integration&#39;</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="slow"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.slow">[docs]</a><span class="k">def</span> <span class="nf">slow</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark test as a slow, although not necessarily integration or usecase test</span>

<span class="sd">    Rule of thumb cut-off to mark as slow is 10 sec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attr</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="turtle"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.turtle">[docs]</a><span class="k">def</span> <span class="nf">turtle</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark test as very slow, meaning to not run it on Travis due to its</span>
<span class="sd">    time limit</span>

<span class="sd">    Rule of thumb cut-off to mark as turtle is 2 minutes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attr</span><span class="p">(</span><span class="s1">&#39;turtle&#39;</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="usecase"><a class="viewcode-back" href="../../../generated/datalad.tests.utils.html#datalad.tests.utils.usecase">[docs]</a><span class="k">def</span> <span class="nf">usecase</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark test as a usecase user ran into and which (typically) caused bug report</span>
<span class="sd">    to be filed/troubleshooted</span>

<span class="sd">    Should be used in combination with @slow and @turtle if slow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attr</span><span class="p">(</span><span class="s1">&#39;usecase&#39;</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, DataLad team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>