<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>datalad.support.gitrepo &mdash; DataLad 0.15.3+529.gc81453444.dirty documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> DataLad
            <img src="../../../_static/datalad_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.15
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgements.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../background.html">Background and motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../related.html">Delineation from related solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html">Basic principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credentials.html">Credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customization.html">Customization and extension of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/index.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cmdline.html">Command line reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modref.html">Python module reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html">Configuration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DataLad</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>datalad.support.gitrepo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for datalad.support.gitrepo</h1><div class="highlight"><pre>
<span></span><span class="c1"># emacs: -*- mode: python; py-indent-offset: 4; tab-width: 4; indent-tabs-mode: nil -*-</span>
<span class="c1"># ex: set sts=4 ts=4 sw=4 et:</span>
<span class="c1"># ## ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##</span>
<span class="c1">#</span>
<span class="c1">#   See COPYING file distributed along with the datalad package for the</span>
<span class="c1">#   copyright and license terms.</span>
<span class="c1">#</span>
<span class="c1"># ## ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ##</span>
<span class="sd">&quot;&quot;&quot;Internal low-level interface to Git repositories</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OrderedDict</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Mapping</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">linesep</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span><span class="p">,</span>
    <span class="n">exists</span><span class="p">,</span>
    <span class="n">isabs</span><span class="p">,</span>
    <span class="n">commonprefix</span><span class="p">,</span>
    <span class="n">relpath</span><span class="p">,</span>
    <span class="n">dirname</span><span class="p">,</span>
    <span class="n">curdir</span><span class="p">,</span>
    <span class="n">pardir</span><span class="p">,</span>
    <span class="n">sep</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">posixpath</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">datalad.log</span> <span class="kn">import</span> <span class="n">log_progress</span>
<span class="kn">from</span> <span class="nn">datalad.support.due</span> <span class="kn">import</span> <span class="n">due</span><span class="p">,</span> <span class="n">Doi</span>

<span class="kn">from</span> <span class="nn">datalad</span> <span class="kn">import</span> <span class="n">ssh_manager</span>
<span class="kn">from</span> <span class="nn">datalad.cmd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GitWitlessRunner</span><span class="p">,</span>
    <span class="n">WitlessProtocol</span><span class="p">,</span>
    <span class="n">BatchedCommand</span><span class="p">,</span>
    <span class="n">NoCapture</span><span class="p">,</span>
    <span class="n">StdOutErrCapture</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">datalad.config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">parse_gitconfig_dump</span><span class="p">,</span>
    <span class="n">write_config_section</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">datalad.utils</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">from</span> <span class="nn">datalad.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Path</span><span class="p">,</span>
    <span class="n">PurePosixPath</span><span class="p">,</span>
    <span class="n">ensure_list</span><span class="p">,</span>
    <span class="n">optional_args</span><span class="p">,</span>
    <span class="n">on_windows</span><span class="p">,</span>
    <span class="n">getpwd</span><span class="p">,</span>
    <span class="n">posix_relpath</span><span class="p">,</span>
    <span class="n">ensure_dir</span><span class="p">,</span>
    <span class="n">generate_file_chunks</span><span class="p">,</span>
    <span class="n">ensure_unicode</span><span class="p">,</span>
    <span class="n">is_interactive</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># imports from same module:</span>
<span class="kn">from</span> <span class="nn">.external_versions</span> <span class="kn">import</span> <span class="n">external_versions</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CapturedException</span><span class="p">,</span>
    <span class="n">CommandError</span><span class="p">,</span>
    <span class="n">FileNotInRepositoryError</span><span class="p">,</span>
    <span class="n">InvalidGitReferenceError</span><span class="p">,</span>
    <span class="n">InvalidGitRepositoryError</span><span class="p">,</span>
    <span class="n">NoSuchPathError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.network</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RI</span><span class="p">,</span>
    <span class="n">PathRI</span><span class="p">,</span>
    <span class="n">is_ssh</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.path</span> <span class="kn">import</span> <span class="n">get_parent_paths</span>
<span class="kn">from</span> <span class="nn">datalad.core.local.repo</span> <span class="kn">import</span> <span class="n">repo_from_path</span>
<span class="kn">from</span> <span class="nn">datalad.dataset.gitrepo</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GitRepo</span> <span class="k">as</span> <span class="n">CoreGitRepo</span><span class="p">,</span>
    <span class="n">_get_dot_git</span><span class="p">,</span>
    <span class="n">path_based_str_repr</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># shortcuts</span>
<span class="n">_curdirsep</span> <span class="o">=</span> <span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span>
<span class="n">_pardirsep</span> <span class="o">=</span> <span class="n">pardir</span> <span class="o">+</span> <span class="n">sep</span>


<span class="n">lgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;datalad.gitrepo&#39;</span><span class="p">)</span>


<span class="c1"># outside the repo base classes only used in ConfigManager</span>
<div class="viewcode-block" id="to_options"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.to_options">[docs]</a><span class="k">def</span> <span class="nf">to_options</span><span class="p">(</span><span class="n">split_single_char_options</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform keyword arguments into a list of cmdline options</span>

<span class="sd">    Imported from GitPython.</span>

<span class="sd">    Original copyright:</span>
<span class="sd">        Copyright (C) 2008, 2009 Michael Trier and contributors</span>
<span class="sd">    Original license:</span>
<span class="sd">        BSD 3-Clause &quot;New&quot; or &quot;Revised&quot; License</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    split_single_char_options: bool</span>

<span class="sd">    kwargs:</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">dashify</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transform_kwarg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">split_single_char_options</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">split_single_char_options</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;-</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;--</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dashify</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;--</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dashify</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">value</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="n">transform_kwarg</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">split_single_char_options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="n">transform_kwarg</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">split_single_char_options</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span></div>


<span class="k">def</span> <span class="nf">_normalize_path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to check paths passed to methods of this class.</span>

<span class="sd">    Checks whether `path` is beneath `base_dir` and normalizes it.</span>
<span class="sd">    Additionally paths are converted into relative paths with respect to</span>
<span class="sd">    `base_dir`, considering PWD in case of relative paths. This</span>
<span class="sd">    is intended to be used in repository classes, which means that</span>
<span class="sd">    `base_dir` usually will be the repository&#39;s base directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_dir: str</span>
<span class="sd">        directory to serve as base to normalized, relative paths</span>
<span class="sd">    path: str</span>
<span class="sd">        path to be normalized</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str:</span>
<span class="sd">        path, that is a relative path with respect to `base_dir`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="n">pathobj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># do absolute() in addition to always get an absolute path</span>
    <span class="c1"># even with non-existing base_dirs on windows</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>  <span class="c1"># realpath OK</span>

    <span class="c1"># path = normpath(path)</span>
    <span class="c1"># Note: disabled normpath, because it may break paths containing symlinks;</span>
    <span class="c1"># But we don&#39;t want to realpath relative paths, in case cwd isn&#39;t the</span>
    <span class="c1"># correct base.</span>

    <span class="k">if</span> <span class="n">pathobj</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
        <span class="c1"># path might already be a symlink pointing to annex etc,</span>
        <span class="c1"># so realpath only its directory, to get &quot;inline&quot; with</span>
        <span class="c1"># realpath(base_dir) above</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathobj</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="n">pathobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># realpath OK</span>
    <span class="c1"># Executive decision was made to not do this kind of magic!</span>
    <span class="c1">#</span>
    <span class="c1"># elif commonprefix([realpath(getpwd()), base_dir]) == base_dir:</span>
    <span class="c1">#     # If we are inside repository, rebuilt relative paths.</span>
    <span class="c1">#     path = opj(realpath(getpwd()), path)</span>
    <span class="c1">#</span>
    <span class="c1"># BUT with relative curdir/pardir start it would assume relative to curdir</span>
    <span class="c1">#</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_curdirsep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_pardirsep</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">getpwd</span><span class="p">())</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">/</span> <span class="n">pathobj</span><span class="p">)</span>  <span class="c1"># realpath OK</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We were called from outside the repo. Therefore relative paths</span>
        <span class="c1"># are interpreted as being relative to self.path already.</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">commonprefix</span><span class="p">([</span><span class="n">path</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">])</span> <span class="o">!=</span> <span class="n">base_dir</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FileNotInRepositoryError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Path outside repository: </span><span class="si">%s</span><span class="s2">&quot;</span>
                                           <span class="o">%</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">relpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">base_dir</span><span class="p">)</span>


<div class="viewcode-block" id="normalize_path"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.normalize_path">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">normalize_path</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to provide unified path conversion for a single file</span>

<span class="sd">    Unlike normalize_paths, intended to be used for functions dealing with a</span>
<span class="sd">    single filename at a time</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This is intended to be used within the repository classes and therefore</span>
<span class="sd">    returns a class method!</span>

<span class="sd">    The decorated function is expected to take a path at</span>
<span class="sd">    first positional argument (after &#39;self&#39;). Additionally the class `func`</span>
<span class="sd">    is a member of, is expected to have an attribute &#39;path&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_normalize_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">file_new</span> <span class="o">=</span> <span class="n">_normalize_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">file_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_new</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">_wrap_normalize_path</span></div>


<div class="viewcode-block" id="normalize_paths"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.normalize_paths">[docs]</a><span class="nd">@optional_args</span>
<span class="k">def</span> <span class="nf">normalize_paths</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">match_return_type</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">map_filenames_back</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">serialize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to provide unified path conversions.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This is intended to be used within the repository classes and therefore</span>
<span class="sd">    returns a class method!</span>

<span class="sd">    The decorated function is expected to take a path or a list of paths at</span>
<span class="sd">    first positional argument (after &#39;self&#39;). Additionally the class `func`</span>
<span class="sd">    is a member of, is expected to have an attribute &#39;path&#39;.</span>

<span class="sd">    Accepts either a list of paths or a single path in a str. Passes a list</span>
<span class="sd">    to decorated function either way, but would return based on the value of</span>
<span class="sd">    match_return_type and possibly input argument.</span>

<span class="sd">    If a call to the wrapped function includes normalize_path and it is False</span>
<span class="sd">    no normalization happens for that function call (used for calls to wrapped</span>
<span class="sd">    functions within wrapped functions, while possible CWD is within a</span>
<span class="sd">    repository)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    match_return_type : bool, optional</span>
<span class="sd">      If True, and a single string was passed in, it would return the first</span>
<span class="sd">      element of the output (after verifying that it is a list of length 1).</span>
<span class="sd">      It makes easier to work with single files input.</span>
<span class="sd">    map_filenames_back : bool, optional</span>
<span class="sd">      If True and returned value is a dictionary, it assumes to carry entries</span>
<span class="sd">      one per file, and then filenames are mapped back to as provided from the</span>
<span class="sd">      normalized (from the root of the repo) paths</span>
<span class="sd">    serialize : bool, optional</span>
<span class="sd">      Loop through files giving only a single one to the function one at a time.</span>
<span class="sd">      This allows to simplify implementation and interface to annex commands</span>
<span class="sd">      which do not take multiple args in the same call (e.g. checkpresentkey)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span>  <span class="nf">_wrap_normalize_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">normalize</span> <span class="o">=</span> <span class="n">_normalize_path</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;normalize_paths&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> \
            <span class="k">else</span> <span class="k">lambda</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">filepath</span>

        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">files_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">files</span><span class="p">)]</span>
                <span class="n">single_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">files_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
                <span class="n">single_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_files_decorator: Don&#39;t know how to handle &quot;</span>
                                 <span class="s2">&quot;instance of </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">files_new</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">map_filenames_back</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">remap_filenames</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Helper to map files back to non-normalized paths&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_new</span><span class="p">))</span>
                    <span class="n">files_</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span> <span class="k">if</span> <span class="n">single_file</span> <span class="k">else</span> <span class="n">files</span>
                    <span class="n">mapped</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">fin</span><span class="p">,</span> <span class="n">fout</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_</span><span class="p">,</span> <span class="n">files_new</span><span class="p">):</span>
                        <span class="n">mapped</span><span class="p">[</span><span class="n">fin</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">fout</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">mapped</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remap_filenames</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">serialize</span><span class="p">:</span>  <span class="c1"># and not single_file:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_new</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_new</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">single_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># no files were provided, nothing we can do really</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">match_return_type</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">single_file</span><span class="p">:</span>
            <span class="c1"># If function doesn&#39;t return anything or no denormalization</span>
            <span class="c1"># was requested or it was not a single file</span>
            <span class="k">return</span> <span class="n">remap_filenames</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">single_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Magic doesn&#39;t apply</span>
                <span class="k">return</span> <span class="n">remap_filenames</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">files_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># assume that returned dictionary has files as keys.</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no magic can apply</span>
                <span class="k">return</span> <span class="n">remap_filenames</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;should have not got here... check logic&quot;</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">_wrap_normalize_paths</span></div>


<span class="k">if</span> <span class="s2">&quot;2.24.0&quot;</span> <span class="o">&lt;=</span> <span class="n">external_versions</span><span class="p">[</span><span class="s2">&quot;cmd:git&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s2">&quot;2.25.0&quot;</span><span class="p">:</span>
    <span class="c1"># An unintentional change in Git 2.24.0 led to `ls-files -o` traversing</span>
    <span class="c1"># into untracked submodules when multiple pathspecs are given, returning</span>
    <span class="c1"># repositories that are deeper than the first level. This helper filters</span>
    <span class="c1"># these deeper levels out so that save_() doesn&#39;t fail trying to add them.</span>
    <span class="c1">#</span>
    <span class="c1"># This regression fixed with upstream&#39;s 072a231016 (2019-12-10).</span>
    <span class="k">def</span> <span class="nf">_prune_deeper_repos</span><span class="p">(</span><span class="n">repos</span><span class="p">):</span>
        <span class="n">firstlevel_repos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">repos</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">prev</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prev</span><span class="p">)):</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
                <span class="n">firstlevel_repos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">firstlevel_repos</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_prune_deeper_repos</span><span class="p">(</span><span class="n">repos</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">repos</span>


<div class="viewcode-block" id="GitProgress"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitProgress">[docs]</a><span class="k">class</span> <span class="nc">GitProgress</span><span class="p">(</span><span class="n">WitlessProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reduced variant of GitPython&#39;s RemoteProgress class</span>

<span class="sd">    Original copyright:</span>
<span class="sd">        Copyright (C) 2008, 2009 Michael Trier and contributors</span>
<span class="sd">    Original license:</span>
<span class="sd">        BSD 3-Clause &quot;New&quot; or &quot;Revised&quot; License</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># inform super-class to capture stderr</span>
    <span class="n">proc_err</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">_num_op_codes</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">BEGIN</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="n">COUNTING</span><span class="p">,</span> <span class="n">COMPRESSING</span><span class="p">,</span> <span class="n">WRITING</span><span class="p">,</span> <span class="n">RECEIVING</span><span class="p">,</span> <span class="n">RESOLVING</span><span class="p">,</span> <span class="n">FINDING_SOURCES</span><span class="p">,</span> <span class="n">CHECKING_OUT</span><span class="p">,</span> <span class="n">ENUMERATING</span> <span class="o">=</span> \
        <span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_num_op_codes</span><span class="p">)]</span>
    <span class="n">STAGE_MASK</span> <span class="o">=</span> <span class="n">BEGIN</span> <span class="o">|</span> <span class="n">END</span>
    <span class="n">OP_MASK</span> <span class="o">=</span> <span class="o">~</span><span class="n">STAGE_MASK</span>

    <span class="n">DONE_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;done.&#39;</span>
    <span class="n">TOKEN_SEPARATOR</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>

    <span class="n">_known_ops</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">COUNTING</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Counting&quot;</span><span class="p">,</span> <span class="s2">&quot;Objects&quot;</span><span class="p">),</span>
        <span class="n">ENUMERATING</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Enumerating&quot;</span><span class="p">,</span> <span class="s2">&quot;Objects&quot;</span><span class="p">),</span>
        <span class="n">COMPRESSING</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Compressing&quot;</span><span class="p">,</span> <span class="s2">&quot;Objects&quot;</span><span class="p">),</span>
        <span class="n">WRITING</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Writing&quot;</span><span class="p">,</span> <span class="s2">&quot;Objects&quot;</span><span class="p">),</span>
        <span class="n">RECEIVING</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Receiving&quot;</span><span class="p">,</span> <span class="s2">&quot;Objects&quot;</span><span class="p">),</span>
        <span class="n">RESOLVING</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Resolving&quot;</span><span class="p">,</span> <span class="s2">&quot;Deltas&quot;</span><span class="p">),</span>
        <span class="n">FINDING_SOURCES</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Finding&quot;</span><span class="p">,</span> <span class="s2">&quot;Sources&quot;</span><span class="p">),</span>
        <span class="n">CHECKING_OUT</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Check out&quot;</span><span class="p">,</span> <span class="s2">&quot;Things&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_seen_ops&#39;</span><span class="p">,</span> <span class="s1">&#39;_pbars&#39;</span><span class="p">,</span> <span class="s1">&#39;_encoding&#39;</span><span class="p">)</span>

    <span class="n">re_op_absolute</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(remote: )?([\w\s]+):\s+()(\d+)()(.*)&quot;</span><span class="p">)</span>
    <span class="n">re_op_relative</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(remote: )?([\w\s]+):\s+(\d+)% \((\d+)/(\d+)\)(.*)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unprocessed</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="GitProgress.connection_made"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitProgress.connection_made">[docs]</a>    <span class="k">def</span> <span class="nf">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connection_made</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seen_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pbars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="GitProgress.process_exited"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitProgress.process_exited">[docs]</a>    <span class="k">def</span> <span class="nf">process_exited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># take down any progress bars that were not closed orderly</span>
        <span class="k">for</span> <span class="n">pbar_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pbars</span><span class="p">:</span>
            <span class="n">log_progress</span><span class="p">(</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                <span class="n">pbar_id</span><span class="p">,</span>
                <span class="s1">&#39;Finished&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_exited</span><span class="p">()</span></div>

<div class="viewcode-block" id="GitProgress.pipe_data_received"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitProgress.pipe_data_received">[docs]</a>    <span class="k">def</span> <span class="nf">pipe_data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">byts</span><span class="p">):</span>
        <span class="c1"># progress reports only come from stderr</span>
        <span class="k">if</span> <span class="n">fd</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># let the base class decide what to do with it</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pipe_data_received</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">byts</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">byts</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># put any unprocessed content back in front</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprocessed</span> <span class="o">+</span> <span class="n">line</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprocessed</span> <span class="k">else</span> <span class="n">line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unprocessed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_progress_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="c1"># anything that doesn&#39;t look like a progress report</span>
                <span class="c1"># is retained and returned</span>
                <span class="c1"># in case of partial progress lines, this can lead to</span>
                <span class="c1"># leakage of progress info into the output, but</span>
                <span class="c1"># it is better to enable better (maybe more expensive)</span>
                <span class="c1"># subsequent filtering than hiding lines with</span>
                <span class="c1"># unknown, potentially important info</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Non-progress stderr: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)):</span>
                    <span class="c1"># complete non-progress line, pass on</span>
                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pipe_data_received</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># an incomplete line, maybe the next batch completes</span>
                    <span class="c1"># it to become a recognizable progress report</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_unprocessed</span> <span class="o">=</span> <span class="n">line</span></div>

    <span class="k">def</span> <span class="nf">_parse_progress_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a single line</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        line : bytes</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">          Flag whether the line was recognized as a Git progress report.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle</span>
        <span class="c1"># Counting objects: 4, done.</span>
        <span class="c1"># Compressing objects:  50% (1/2)</span>
        <span class="c1"># Compressing objects: 100% (2/2)</span>
        <span class="c1"># Compressing objects: 100% (2/2), done.</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;warning:&#39;</span><span class="p">,</span> <span class="s1">&#39;error:&#39;</span><span class="p">,</span> <span class="s1">&#39;fatal:&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># find escape characters and cut them away - regex will not work with</span>
        <span class="c1"># them as they are non-ascii. As git might expect a tty, it will send them</span>
        <span class="n">last_valid_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
                <span class="c1"># its a slice index</span>
                <span class="n">last_valid_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1"># END character was non-ascii</span>
        <span class="c1"># END for each character in line</span>
        <span class="k">if</span> <span class="n">last_valid_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">last_valid_index</span><span class="p">]</span>
        <span class="c1"># END cut away invalid part</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="n">cur_count</span><span class="p">,</span> <span class="n">max_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_op_relative</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_op_absolute</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># END could not get match</span>

        <span class="n">op_code</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">_remote</span><span class="p">,</span> <span class="n">op_name</span><span class="p">,</span> <span class="n">_percent</span><span class="p">,</span> <span class="n">cur_count</span><span class="p">,</span> <span class="n">max_count</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

        <span class="c1"># get operation id</span>
        <span class="k">if</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s2">&quot;Counting objects&quot;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COUNTING</span>
        <span class="k">elif</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s2">&quot;Compressing objects&quot;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPRESSING</span>
        <span class="k">elif</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s2">&quot;Writing objects&quot;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WRITING</span>
        <span class="k">elif</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s1">&#39;Receiving objects&#39;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECEIVING</span>
        <span class="k">elif</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s1">&#39;Resolving deltas&#39;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESOLVING</span>
        <span class="k">elif</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s1">&#39;Finding sources&#39;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINDING_SOURCES</span>
        <span class="k">elif</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s1">&#39;Checking out files&#39;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECKING_OUT</span>
        <span class="k">elif</span> <span class="n">op_name</span> <span class="o">==</span> <span class="s1">&#39;Enumerating objects&#39;</span><span class="p">:</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ENUMERATING</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Note: On windows it can happen that partial lines are sent</span>
            <span class="c1"># Hence we get something like &quot;CompreReceiving objects&quot;, which is</span>
            <span class="c1"># a blend of &quot;Compressing objects&quot; and &quot;Receiving objects&quot;.</span>
            <span class="c1"># This can&#39;t really be prevented.</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Output line matched a progress report of an unknown type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="p">)</span>
            <span class="c1"># TODO investigate if there is any chance that we might swallow</span>
            <span class="c1"># important info -- until them do not flag this line</span>
            <span class="c1"># as progress</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># END handle op code</span>

        <span class="n">pbar_id</span> <span class="o">=</span> <span class="s1">&#39;gitprogress-</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">op_code</span><span class="p">)</span>

        <span class="n">op_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_ops</span><span class="p">[</span><span class="n">op_code</span><span class="p">]</span>

        <span class="c1"># figure out stage</span>
        <span class="k">if</span> <span class="n">op_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seen_ops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seen_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_code</span><span class="p">)</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BEGIN</span>
            <span class="n">log_progress</span><span class="p">(</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                <span class="n">pbar_id</span><span class="p">,</span>
                <span class="s1">&#39;Start </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">op_props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                    <span class="n">op_props</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                <span class="p">),</span>
                <span class="n">label</span><span class="o">=</span><span class="n">op_props</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_props</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">max_count</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_count</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pbars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pbar_id</span><span class="p">)</span>
        <span class="c1"># END begin opcode</span>

        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># END message handling</span>

        <span class="n">done_progress</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DONE_TOKEN</span><span class="p">):</span>
            <span class="n">op_code</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">END</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DONE_TOKEN</span><span class="p">)]</span>
            <span class="n">done_progress</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># END end message handling</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TOKEN_SEPARATOR</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cur_count</span> <span class="ow">and</span> <span class="n">max_count</span><span class="p">:</span>
            <span class="n">log_progress</span><span class="p">(</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                <span class="n">pbar_id</span><span class="p">,</span>
                <span class="n">line</span><span class="p">,</span>
                <span class="n">update</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cur_count</span><span class="p">),</span>
                <span class="n">noninteractive_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">done_progress</span><span class="p">:</span>
            <span class="n">log_progress</span><span class="p">(</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                <span class="n">pbar_id</span><span class="p">,</span>
                <span class="s1">&#39;Finished </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">op_props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                    <span class="n">op_props</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                <span class="p">),</span>
                <span class="n">noninteractive_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pbars</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pbar_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="StdOutCaptureWithGitProgress"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.StdOutCaptureWithGitProgress">[docs]</a><span class="k">class</span> <span class="nc">StdOutCaptureWithGitProgress</span><span class="p">(</span><span class="n">GitProgress</span><span class="p">):</span>
    <span class="n">proc_out</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FetchInfo"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.FetchInfo">[docs]</a><span class="k">class</span> <span class="nc">FetchInfo</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    dict that carries results of a fetch operation of a single head</span>

<span class="sd">    Reduced variant of GitPython&#39;s RemoteProgress class</span>

<span class="sd">    Original copyright:</span>
<span class="sd">        Copyright (C) 2008, 2009 Michael Trier and contributors</span>
<span class="sd">    Original license:</span>
<span class="sd">        BSD 3-Clause &quot;New&quot; or &quot;Revised&quot; License</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NEW_TAG</span><span class="p">,</span> <span class="n">NEW_HEAD</span><span class="p">,</span> <span class="n">HEAD_UPTODATE</span><span class="p">,</span> <span class="n">TAG_UPDATE</span><span class="p">,</span> <span class="n">REJECTED</span><span class="p">,</span> <span class="n">FORCED_UPDATE</span><span class="p">,</span> \
        <span class="n">FAST_FORWARD</span><span class="p">,</span> <span class="n">ERROR</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>

    <span class="n">_re_fetch_result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(.) (\[?[\w\s\.$@]+\]?)\s+(.+) [-&gt; ]+ ([^\s]+)(    \(.*\)?$)?&#39;</span><span class="p">)</span>

    <span class="n">_flag_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;!&#39;</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">,</span>
        <span class="s1">&#39;+&#39;</span><span class="p">:</span> <span class="n">FORCED_UPDATE</span><span class="p">,</span>
        <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="n">HEAD_UPTODATE</span><span class="p">,</span>
        <span class="s1">&#39; &#39;</span><span class="p">:</span> <span class="n">FAST_FORWARD</span><span class="p">,</span>
        <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="n">TAG_UPDATE</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">_operation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">NEW_TAG</span><span class="p">:</span> <span class="s1">&#39;new-tag&#39;</span><span class="p">,</span>
        <span class="n">NEW_HEAD</span><span class="p">:</span> <span class="s1">&#39;new-branch&#39;</span><span class="p">,</span>
        <span class="n">HEAD_UPTODATE</span><span class="p">:</span> <span class="s1">&#39;uptodate&#39;</span><span class="p">,</span>
        <span class="n">TAG_UPDATE</span><span class="p">:</span> <span class="s1">&#39;tag-update&#39;</span><span class="p">,</span>
        <span class="n">REJECTED</span><span class="p">:</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span>
        <span class="n">FORCED_UPDATE</span><span class="p">:</span> <span class="s1">&#39;forced-update&#39;</span><span class="p">,</span>
        <span class="n">FAST_FORWARD</span><span class="p">:</span> <span class="s1">&#39;fast-forward&#39;</span><span class="p">,</span>
        <span class="n">ERROR</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse information from the given line as returned by git-fetch -v</span>
<span class="sd">        and return a new FetchInfo object representing this information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_re_fetch_result</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to parse line: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

        <span class="c1"># parse lines</span>
        <span class="n">control_character</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">local_remote_ref</span><span class="p">,</span> <span class="n">remote_local_ref</span><span class="p">,</span> <span class="n">note</span> <span class="o">=</span> \
            <span class="k">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

        <span class="c1"># parse flags from control_character</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_flag_map</span><span class="p">[</span><span class="n">control_character</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Control character </span><span class="si">%r</span><span class="s2"> unknown as parsed from line </span><span class="si">%r</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">control_character</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="c1"># END control char exception handling</span>

        <span class="c1"># parse operation string for more info - makes no sense for symbolic refs,</span>
        <span class="c1"># but we parse it anyway</span>
        <span class="n">old_commit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;rejected&#39;</span> <span class="ow">in</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">REJECTED</span>
        <span class="k">if</span> <span class="s1">&#39;new tag&#39;</span> <span class="ow">in</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NEW_TAG</span>
        <span class="k">if</span> <span class="s1">&#39;tag update&#39;</span> <span class="ow">in</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_UPDATE</span>
        <span class="k">if</span> <span class="s1">&#39;new branch&#39;</span> <span class="ow">in</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NEW_HEAD</span>
        <span class="k">if</span> <span class="s1">&#39;...&#39;</span> <span class="ow">in</span> <span class="n">operation</span> <span class="ow">or</span> <span class="s1">&#39;..&#39;</span> <span class="ow">in</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">split_token</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
            <span class="k">if</span> <span class="n">control_character</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                <span class="n">split_token</span> <span class="o">=</span> <span class="n">split_token</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">old_commit</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split_token</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># END handle refspec</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">remote_local_ref</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="n">local_ref</span><span class="o">=</span><span class="n">local_remote_ref</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="c1"># convert flag int into a list of operation labels</span>
            <span class="n">operations</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_operation_map</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_operation_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">o</span>
            <span class="p">],</span>
            <span class="n">note</span><span class="o">=</span><span class="n">note</span><span class="p">,</span>
            <span class="n">old_commit</span><span class="o">=</span><span class="n">old_commit</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PushInfo"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.PushInfo">[docs]</a><span class="k">class</span> <span class="nc">PushInfo</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;dict that carries results of a push operation of a single head</span>

<span class="sd">    Reduced variant of GitPython&#39;s RemoteProgress class</span>

<span class="sd">    Original copyright:</span>
<span class="sd">        Copyright (C) 2008, 2009 Michael Trier and contributors</span>
<span class="sd">    Original license:</span>
<span class="sd">        BSD 3-Clause &quot;New&quot; or &quot;Revised&quot; License</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NEW_TAG</span><span class="p">,</span> <span class="n">NEW_HEAD</span><span class="p">,</span> <span class="n">NO_MATCH</span><span class="p">,</span> <span class="n">REJECTED</span><span class="p">,</span> <span class="n">REMOTE_REJECTED</span><span class="p">,</span> <span class="n">REMOTE_FAILURE</span><span class="p">,</span> <span class="n">DELETED</span><span class="p">,</span> \
        <span class="n">FORCED_UPDATE</span><span class="p">,</span> <span class="n">FAST_FORWARD</span><span class="p">,</span> <span class="n">UP_TO_DATE</span><span class="p">,</span> <span class="n">ERROR</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)]</span>

    <span class="n">_flag_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">NO_MATCH</span><span class="p">,</span>
                 <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="n">DELETED</span><span class="p">,</span>
                 <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="s1">&#39;+&#39;</span><span class="p">:</span> <span class="n">FORCED_UPDATE</span><span class="p">,</span>
                 <span class="s1">&#39; &#39;</span><span class="p">:</span> <span class="n">FAST_FORWARD</span><span class="p">,</span>
                 <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="n">UP_TO_DATE</span><span class="p">,</span>
                 <span class="s1">&#39;!&#39;</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">}</span>

    <span class="n">_operation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">NEW_TAG</span><span class="p">:</span> <span class="s1">&#39;new-tag&#39;</span><span class="p">,</span>
        <span class="n">NEW_HEAD</span><span class="p">:</span> <span class="s1">&#39;new-branch&#39;</span><span class="p">,</span>
        <span class="n">NO_MATCH</span><span class="p">:</span> <span class="s1">&#39;no-match&#39;</span><span class="p">,</span>
        <span class="n">REJECTED</span><span class="p">:</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span>
        <span class="n">REMOTE_REJECTED</span><span class="p">:</span> <span class="s1">&#39;remote-rejected&#39;</span><span class="p">,</span>
        <span class="n">REMOTE_FAILURE</span><span class="p">:</span> <span class="s1">&#39;remote-failure&#39;</span><span class="p">,</span>
        <span class="n">DELETED</span><span class="p">:</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span>
        <span class="n">FORCED_UPDATE</span><span class="p">:</span> <span class="s1">&#39;forced-update&#39;</span><span class="p">,</span>
        <span class="n">FAST_FORWARD</span><span class="p">:</span> <span class="s1">&#39;fast-forward&#39;</span><span class="p">,</span>
        <span class="n">UP_TO_DATE</span><span class="p">:</span> <span class="s1">&#39;uptodate&#39;</span><span class="p">,</span>
        <span class="n">ERROR</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new PushInfo instance as parsed from line which is expected to be like</span>
<span class="sd">            refs/heads/master:refs/heads/master 05d2687..1d0568e as bytes&quot;&quot;&quot;</span>
        <span class="n">control_character</span><span class="p">,</span> <span class="n">from_to</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># control character handling</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_flag_map</span><span class="p">[</span><span class="n">control_character</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Control character </span><span class="si">%r</span><span class="s2"> unknown as parsed from line </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">control_character</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="c1"># END handle control character</span>

        <span class="c1"># from_to handling</span>
        <span class="n">from_ref_string</span><span class="p">,</span> <span class="n">to_ref_string</span> <span class="o">=</span> <span class="n">from_to</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

        <span class="c1"># commit handling, could be message or commit info</span>
        <span class="n">old_commit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;[rejected]&quot;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">REJECTED</span>
            <span class="k">elif</span> <span class="s2">&quot;[remote rejected]&quot;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">REMOTE_REJECTED</span>
            <span class="k">elif</span> <span class="s2">&quot;[remote failure]&quot;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">REMOTE_FAILURE</span>
            <span class="k">elif</span> <span class="s2">&quot;[no match]&quot;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ERROR</span>
            <span class="k">elif</span> <span class="s2">&quot;[new tag]&quot;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NEW_TAG</span>
            <span class="k">elif</span> <span class="s2">&quot;[new branch]&quot;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NEW_HEAD</span>
            <span class="c1"># up-to-date encoded in control character</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fast-forward or forced update - was encoded in control character,</span>
            <span class="c1"># but we parse the old and new commit</span>
            <span class="n">split_token</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
            <span class="k">if</span> <span class="n">control_character</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                <span class="n">split_token</span> <span class="o">=</span> <span class="s2">&quot;..&quot;</span>
            <span class="n">old_sha</span><span class="p">,</span> <span class="n">_new_sha</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split_token</span><span class="p">)</span>
            <span class="c1"># have to use constructor here as the sha usually is abbreviated</span>
            <span class="n">old_commit</span> <span class="o">=</span> <span class="n">old_sha</span>
        <span class="c1"># END message handling</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">from_ref</span><span class="o">=</span><span class="n">from_ref_string</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="n">to_ref</span><span class="o">=</span><span class="n">to_ref_string</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="c1"># convert flag int into a list of operation labels</span>
            <span class="n">operations</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_operation_map</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_operation_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">o</span>
            <span class="p">],</span>
            <span class="n">note</span><span class="o">=</span><span class="n">summary</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="n">old_commit</span><span class="o">=</span><span class="n">old_commit</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GitRepo"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo">[docs]</a><span class="nd">@path_based_str_repr</span>
<span class="k">class</span> <span class="nc">GitRepo</span><span class="p">(</span><span class="n">CoreGitRepo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Representation of a git repository</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We must check git config to have name and email set, but</span>
    <span class="c1"># should do it once</span>
    <span class="n">_config_checked</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">GIT_MIN_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2.19.1&quot;</span>
    <span class="n">git_version</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_check_git_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">external_versions</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;cmd:git&quot;</span><span class="p">,</span> <span class="n">min_version</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">GIT_MIN_VERSION</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">git_version</span> <span class="o">=</span> <span class="n">external_versions</span><span class="p">[</span><span class="s1">&#39;cmd:git&#39;</span><span class="p">]</span>

    <span class="c1"># This is the least common denominator to claim that a user</span>
    <span class="c1"># used DataLad.</span>
    <span class="c1"># For now citing Zenodo&#39;s all (i.e., latest) version</span>
    <span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span><span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.5281/zenodo.808846&quot;</span><span class="p">),</span>
               <span class="c1"># override path since there is no need ATM for such details</span>
               <span class="n">path</span><span class="o">=</span><span class="s2">&quot;datalad&quot;</span><span class="p">,</span>
               <span class="n">description</span><span class="o">=</span><span class="s2">&quot;DataLad - Data management and distribution platform&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">git_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fake_dates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">create_sanity_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates representation of git repository at `path`.</span>

<span class="sd">        Can also be used to create a git repository at `path`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">          path to the git repository; In case it&#39;s not an absolute path,</span>
<span class="sd">          it&#39;s relative to PWD</span>
<span class="sd">        create: bool, optional</span>
<span class="sd">          if true, creates a git repository at `path` if there is none. Also</span>
<span class="sd">          creates `path`, if it doesn&#39;t exist.</span>
<span class="sd">          If set to false, an exception is raised in case `path` doesn&#39;t exist</span>
<span class="sd">          or doesn&#39;t contain a git repository.</span>
<span class="sd">        repo: git.Repo, optional</span>
<span class="sd">          This argument is ignored.</span>
<span class="sd">        create_sanity_checks: bool, optional</span>
<span class="sd">          Whether to perform sanity checks during initialization (when</span>
<span class="sd">          `create=True` and target path is not a valid repo already), such as</span>
<span class="sd">          that new repository is not created in the directory where git already</span>
<span class="sd">          tracks some files.</span>
<span class="sd">        kwargs:</span>
<span class="sd">          keyword arguments serving as additional options to the git-init</span>
<span class="sd">          command. Therefore, it makes sense only if called with `create`.</span>

<span class="sd">          Generally, this way of passing options to the git executable is</span>
<span class="sd">          (or will be) used a lot in this class. It&#39;s a transformation of</span>
<span class="sd">          python-style keyword arguments (or a `dict`) to command line arguments,</span>
<span class="sd">          provided by GitPython.</span>

<span class="sd">          A single character keyword will be prefixed by &#39;-&#39;, multiple characters</span>
<span class="sd">          by &#39;--&#39;. An underscore in the keyword becomes a dash. The value of the</span>
<span class="sd">          keyword argument is used as the value for the corresponding command</span>
<span class="sd">          line argument. Assigning a boolean creates a flag.</span>

<span class="sd">          Examples:</span>
<span class="sd">          no_commit=True =&gt; --no-commit</span>
<span class="sd">          C=&#39;/my/path&#39;   =&gt; -C /my/path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this will set up .pathobj and .dot_git</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">git_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_git_version</span><span class="p">()</span>

        <span class="c1"># BEGIN Repo validity test</span>
        <span class="c1"># We want to fail early for tests, that would be performed a lot. In</span>
        <span class="c1"># particular this is about GitRepo.is_valid_repo. We would use the</span>
        <span class="c1"># latter to decide whether or not to call GitRepo() only for __init__ to</span>
        <span class="c1"># then test the same things again. If we fail early we can save the</span>
        <span class="c1"># additional test from outer scope.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="c1"># Note, that the following three path objects are used often and</span>
        <span class="c1"># therefore are stored for performance. Path object creation comes with</span>
        <span class="c1"># a cost. Most notably, this is used for validity checking of the</span>
        <span class="c1"># repository.</span>
        <span class="n">_valid_repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_git</span><span class="p">()</span>

        <span class="n">do_create</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">create</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_valid_repo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">repo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># `repo` passed with `create`, which doesn&#39;t make sense</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;argument &#39;repo&#39; must not be used with &#39;create&#39;&quot;</span><span class="p">)</span>
            <span class="n">do_create</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Note: We used to call gitpy.Repo(path) here, which potentially</span>
            <span class="c1"># raised NoSuchPathError or InvalidGitRepositoryError. This is</span>
            <span class="c1"># used by callers of GitRepo.__init__() to detect whether we have a</span>
            <span class="c1"># valid repo at `path`. Now, with switching to lazy loading property</span>
            <span class="c1"># `repo`, we detect those cases without instantiating a</span>
            <span class="c1"># gitpy.Repo().</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">NoSuchPathError</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_valid_repo</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidGitRepositoryError</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># END Repo validity test</span>

        <span class="c1"># So that we &quot;share&quot; control paths with git/git-annex</span>
        <span class="k">if</span> <span class="n">ssh_manager</span><span class="p">:</span>
            <span class="n">ssh_manager</span><span class="o">.</span><span class="n">ensure_initialized</span><span class="p">()</span>

        <span class="c1"># note: we may also want to distinguish between a path to the worktree</span>
        <span class="c1"># and the actual repository</span>

        <span class="k">if</span> <span class="n">git_opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">git_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">git_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">do_create</span><span class="p">:</span>  <span class="c1"># we figured it out earlier</span>
            <span class="n">from_cmdline</span> <span class="o">=</span> <span class="n">git_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_from_cmdline_&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                <span class="n">sanity_checks</span><span class="o">=</span><span class="n">create_sanity_checks</span><span class="p">,</span>
                <span class="n">init_options</span><span class="o">=</span><span class="n">from_cmdline</span> <span class="o">+</span> <span class="n">to_options</span><span class="p">(</span><span class="o">**</span><span class="n">git_opts</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># with DryRunProtocol path might still not exist</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_ino</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">fake_dates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configure_fake_dates</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="s2">&quot;bare&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dot_git</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="s2">&quot;bare&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dot_git</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidGitRepositoryError</span><span class="p">(</span><span class="s2">&quot;GitRepo contains inconsistent hints&quot;</span>
                                            <span class="s2">&quot; on whether or not it is a bare &quot;</span>
                                            <span class="s2">&quot;repository.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GitRepo.clone"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.clone">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">clone_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clone url into path</span>

<span class="sd">        Provides workarounds for known issues (e.g.</span>
<span class="sd">        https://github.com/datalad/datalad/issues/785)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">        path : str</span>
<span class="sd">        clone_options : dict or list</span>
<span class="sd">          Arbitrary options that will be passed on to the underlying call to</span>
<span class="sd">          `git-clone`. This may be a list of plain options or key-value pairs</span>
<span class="sd">          that will be converted to a list of plain options with `to_options`.</span>
<span class="sd">        expect_fail : bool</span>
<span class="sd">          Whether expect that command might fail, so error should be logged then</span>
<span class="sd">          at DEBUG level instead of ERROR</span>
<span class="sd">        kwargs:</span>
<span class="sd">          Passed to the Repo class constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;repo&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;argument &#39;repo&#39; conflicts with cloning&quot;</span><span class="p">)</span>
            <span class="c1"># TODO: what about &#39;create&#39;?</span>

        <span class="n">expect_fail</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;expect_fail&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># fail early on non-empty target:</span>
        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;destination path &#39;</span><span class="si">%s</span><span class="s2">&#39; already exists and is not an &quot;</span>
                <span class="s2">&quot;empty directory.&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># protect against cloning into existing and obviously dangling</span>
            <span class="c1"># instance for that location</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_unique_instances</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># didn&#39;t exist - all fine</span>
                <span class="k">pass</span>

        <span class="c1"># Massage URL</span>
        <span class="n">url_ri</span> <span class="o">=</span> <span class="n">RI</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">RI</span><span class="p">)</span> <span class="k">else</span> <span class="n">url</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">on_windows</span><span class="p">:</span>
            <span class="c1"># if we are on windows, the local path of a URL</span>
            <span class="c1"># would not end up being a proper local path and cloning</span>
            <span class="c1"># would fail. Don&#39;t try to be smart and just pass the</span>
            <span class="c1"># URL along unmodified</span>

            <span class="c1"># try to get a local path from `url`:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url_ri</span><span class="o">.</span><span class="n">localpath</span>
                <span class="n">url_ri</span> <span class="o">=</span> <span class="n">RI</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">is_ssh</span><span class="p">(</span><span class="n">url_ri</span><span class="p">):</span>
            <span class="n">ssh_manager</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url_ri</span><span class="p">,</span> <span class="n">PathRI</span><span class="p">):</span>
                <span class="c1"># expand user, because execution not going through a shell</span>
                <span class="c1"># doesn&#39;t work well otherwise</span>
                <span class="n">new_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">url</span> <span class="o">!=</span> <span class="n">new_url</span><span class="p">:</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expanded source path to </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_url</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">new_url</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_git_cmd_prefix</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;clone&#39;</span><span class="p">,</span> <span class="s1">&#39;--progress&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">clone_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clone_options</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">clone_options</span> <span class="o">=</span> <span class="n">to_options</span><span class="p">(</span><span class="o">**</span><span class="n">clone_options</span><span class="p">)</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">clone_options</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">])</span>

        <span class="n">fix_annex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ntries</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 3 is not enough for robust workaround</span>
        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Git clone from </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

                <span class="n">res</span> <span class="o">=</span> <span class="n">GitWitlessRunner</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">GitProgress</span><span class="p">)</span>
                <span class="c1"># fish out non-critical warnings by git-clone</span>
                <span class="c1"># (empty repo clone, etc.), all other content is logged</span>
                <span class="c1"># by the progress helper to &#39;debug&#39;</span>
                <span class="k">for</span> <span class="n">errline</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">errline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;warning:&#39;</span><span class="p">):</span>
                        <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">errline</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Git clone completed&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># log here but let caller decide what to do</span>
                <span class="n">ce</span> <span class="o">=</span> <span class="n">CapturedException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">str_e</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="c1"># see https://github.com/datalad/datalad/issues/785</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;Request for .*aborted.*Unable to find&quot;</span><span class="p">,</span> <span class="n">str_e</span><span class="p">,</span>
                             <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="n">trial</span> <span class="o">&lt;</span> <span class="n">ntries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Hit a known issue with Git (see GH#785). Trial #</span><span class="si">%d</span><span class="s2">, &quot;</span>
                        <span class="s2">&quot;retrying&quot;</span><span class="p">,</span>
                        <span class="n">trial</span><span class="p">)</span>
                    <span class="k">continue</span>
                    <span class="c1">#(lgr.debug if expect_fail else lgr.error)(e_str)</span>

                <span class="k">if</span> <span class="s2">&quot;Clone succeeded, but checkout failed.&quot;</span> <span class="ow">in</span> <span class="n">str_e</span><span class="p">:</span>
                    <span class="n">fix_annex</span> <span class="o">=</span> <span class="n">ce</span>
                    <span class="k">break</span>

                <span class="k">raise</span>

        <span class="c1"># get ourselves a repository instance</span>
        <span class="n">gr</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fix_annex</span><span class="p">:</span>
            <span class="c1"># cheap check whether we deal with an AnnexRepo - we can&#39;t check the class of `gr` itself, since we then</span>
            <span class="c1"># would need to import our own subclass</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gr</span><span class="p">,</span> <span class="s1">&#39;is_valid_annex&#39;</span><span class="p">):</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Experienced issues while cloning. &quot;</span>
                            <span class="s2">&quot;Trying to fix it, using git-annex-fsck.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">gr</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                    <span class="n">gr</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
                <span class="n">gr</span><span class="o">.</span><span class="n">fsck</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Experienced issues while cloning: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fix_annex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gr</span></div>

    <span class="c1"># Note: __del__ shouldn&#39;t be needed anymore as we switched to</span>
    <span class="c1">#       `weakref.finalize`.</span>
    <span class="c1">#       https://docs.python.org/3/library/weakref.html#comparing-finalizers-with-del-methods</span>
    <span class="c1">#</span>
    <span class="c1">#       Keeping both methods and this comment around as a reminder to not</span>
    <span class="c1">#       use __del__, if we figure there&#39;s a need for cleanup in the future.</span>
    <span class="c1">#</span>
    <span class="c1"># def __del__(self):</span>
    <span class="c1">#     # unbind possibly bound ConfigManager, to prevent all kinds of weird</span>
    <span class="c1">#     # stalls etc</span>
    <span class="c1">#     self._cfg = None</span>

<div class="viewcode-block" id="GitRepo.is_valid_git"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.is_valid_git">[docs]</a>    <span class="k">def</span> <span class="nf">is_valid_git</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the underlying repository appears to be still valid</span>

<span class="sd">        Note, that this almost identical to the classmethod is_valid_repo().</span>
<span class="sd">        However, if we are testing an existing instance, we can save Path object</span>
<span class="sd">        creations. Since this testing is done a lot, this is relevant. Creation</span>
<span class="sd">        of the Path objects in is_valid_repo() takes nearly half the time of the</span>
<span class="sd">        entire function.</span>

<span class="sd">        Also note, that this method is bound to an instance but still</span>
<span class="sd">        class-dependent, meaning that a subclass cannot simply overwrite it.</span>
<span class="sd">        This is particularly important for the call from within __init__(),</span>
<span class="sd">        which in turn is called by the subclasses&#39; __init__. Using an overwrite</span>
<span class="sd">        would lead to the wrong thing being called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span></div>

<div class="viewcode-block" id="GitRepo.is_valid_repo"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.is_valid_repo">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_valid_repo</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns if a given path points to a git repository&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.get_git_dir"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_git_dir">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_git_dir</span><span class="p">(</span><span class="n">repo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;figure out a repo&#39;s gitdir</span>

<span class="sd">        &#39;.git&#39; might be a  directory, a symlink or a file</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This method is likely to get deprecated, please use GitRepo.dot_git instead!</span>
<span class="sd">        That one&#39;s not static, but it&#39;s cheaper and you should avoid</span>
<span class="sd">        not having an instance of a repo you&#39;re working on anyway.</span>
<span class="sd">        Note, that the property in opposition to this method returns an absolute path.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repo: path or Repo instance</span>
<span class="sd">          currently expected to be the repos base dir</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">          relative path to the repo&#39;s git dir; So, default would be &quot;.git&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">GitRepo</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">dot_git</span><span class="p">)</span>
        <span class="n">pathobj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
        <span class="n">dot_git</span> <span class="o">=</span> <span class="n">_get_dot_git</span><span class="p">(</span><span class="n">pathobj</span><span class="p">,</span> <span class="n">ok_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dot_git</span> <span class="o">=</span> <span class="n">dot_git</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">pathobj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># is not a subpath, return as is</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">%r</span><span class="s2"> is not subpath of </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dot_git</span><span class="p">,</span> <span class="n">pathobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">dot_git</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># just proxy the core repo APIs property for backward-compatibility</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span>

<div class="viewcode-block" id="GitRepo.is_with_annex"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.is_with_annex">[docs]</a>    <span class="k">def</span> <span class="nf">is_with_annex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Report if GitRepo (assumed) has (remotes with) a git-annex branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">b</span><span class="p">[</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;git-annex&#39;</span> <span class="ow">or</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/git-annex&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_each_ref_</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;refs/heads&#39;</span><span class="p">,</span> <span class="s1">&#39;refs/remotes&#39;</span><span class="p">])</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.get_toppath"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_toppath">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_toppath</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">follow_up</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return top-level of a repository given the path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        follow_up : bool</span>
<span class="sd">          If path has symlinks -- they get resolved by git.  If follow_up is</span>
<span class="sd">          True, we will follow original path up until we hit the same resolved</span>
<span class="sd">          path.  If no such path found, resolved one would be returned.</span>
<span class="sd">        git_options: list of str</span>
<span class="sd">          options to be passed to the git rev-parse call</span>

<span class="sd">        Return None if no parent directory contains a git repository.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">git_options</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">git_options</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-toplevel&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">GitWitlessRunner</span><span class="p">(</span><span class="n">cwd</span><span class="o">=</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">StdOutErrCapture</span><span class="p">)</span>
            <span class="n">toppath</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">toppath</span> <span class="o">=</span> <span class="n">GitRepo</span><span class="o">.</span><span class="n">get_toppath</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">follow_up</span><span class="o">=</span><span class="n">follow_up</span><span class="p">,</span>
                                          <span class="n">git_options</span><span class="o">=</span><span class="n">git_options</span><span class="p">)</span>

        <span class="c1"># normalize the report, because, e.g. on windows it can come out</span>
        <span class="c1"># with improper directory separators (C:/Users/datalad)</span>
        <span class="n">toppath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">toppath</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">follow_up</span><span class="p">:</span>
            <span class="n">path_</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">path_prev</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="n">path_</span> <span class="ow">and</span> <span class="n">path_</span> <span class="o">!=</span> <span class="n">path_prev</span><span class="p">:</span>  <span class="c1"># on top /.. = /</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path_</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span> <span class="o">==</span> <span class="n">toppath</span><span class="p">:</span>
                    <span class="n">toppath</span> <span class="o">=</span> <span class="n">path_</span>
                    <span class="k">break</span>
                <span class="n">path_prev</span> <span class="o">=</span> <span class="n">path_</span>
                <span class="n">path_</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">path_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">toppath</span></div>

<div class="viewcode-block" id="GitRepo.add"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.add">[docs]</a>    <span class="nd">@normalize_paths</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds file(s) to the repository.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files: list</span>
<span class="sd">          list of paths to add</span>
<span class="sd">        git: bool</span>
<span class="sd">          somewhat ugly construction to be compatible with AnnexRepo.add();</span>
<span class="sd">          has to be always true.</span>
<span class="sd">        update: bool</span>
<span class="sd">          --update option for git-add. From git&#39;s manpage:</span>
<span class="sd">           Update the index just where it already has an entry matching</span>
<span class="sd">           &lt;pathspec&gt;. This removes as well as modifies index entries to match</span>
<span class="sd">           the working tree, but adds no new files.</span>

<span class="sd">           If no &lt;pathspec&gt; is given when --update option is used, all tracked</span>
<span class="sd">           files in the entire working tree are updated (old versions of Git</span>
<span class="sd">           used to limit the update to the current directory and its</span>
<span class="sd">           subdirectories).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">          Of status dicts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># under all circumstances call this class&#39; add_ (otherwise</span>
        <span class="c1"># AnnexRepo.add would go into a loop</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">GitRepo</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="n">git</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="n">git_options</span><span class="p">,</span>
                    <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">))</span></div>

<div class="viewcode-block" id="GitRepo.add_"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.add_">[docs]</a>    <span class="k">def</span> <span class="nf">add_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">git</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like `add`, but returns a generator&quot;&quot;&quot;</span>
        <span class="c1"># TODO: git_options is used as options for the git-add here,</span>
        <span class="c1"># instead of options to the git executable =&gt; rename for consistency</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">git</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;GitRepo.add() called with git=</span><span class="si">%s</span><span class="s1">, this should not happen&#39;</span><span class="p">,</span>
                <span class="n">git</span><span class="p">)</span>
            <span class="n">git</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># there is no other way then to collect all files into a list</span>
        <span class="c1"># at this point, because we need to pass them at once to a single</span>
        <span class="c1"># `git add` call</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">_normalize_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">files</span> <span class="ow">or</span> <span class="n">git_options</span> <span class="ow">or</span> <span class="n">update</span><span class="p">):</span>
            <span class="c1"># wondering why just a warning? in cmdline this is also not an error</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;add was called with empty file list and no options.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># without --verbose git 2.9.3  add does not return anything</span>
            <span class="n">add_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_git</span><span class="p">(</span>
                <span class="c1"># Set annex.gitaddtoannex to prevent storing files in</span>
                <span class="c1"># annex with a v6+ annex repo.</span>
                <span class="p">[</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;annex.gitaddtoannex=false&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">ensure_list</span><span class="p">(</span><span class="n">git_options</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">to_options</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;--verbose&#39;</span><span class="p">],</span>
                <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
                <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># get all the entries</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_git_get_output</span><span class="p">(</span><span class="o">*</span><span class="n">add_out</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">o</span>
            <span class="c1"># Note: as opposed to git cmdline, force is True by default in</span>
            <span class="c1">#       gitpython, which would lead to add things, that are</span>
            <span class="c1">#       ignored or excluded otherwise</span>
            <span class="c1"># 2. Note: There is an issue with globbing (like adding &#39;.&#39;),</span>
            <span class="c1">#       which apparently doesn&#39;t care for &#39;force&#39; and therefore</span>
            <span class="c1">#       adds &#39;.git/...&#39;. May be it&#39;s expanded at the wrong</span>
            <span class="c1">#       point in time or sth. like that.</span>
            <span class="c1"># For now, use direct call to git add.</span>
            <span class="c1">#self.cmd_call_wrapper(self.repo.index.add, files, write=True,</span>
            <span class="c1">#                      force=False)</span>
            <span class="c1"># TODO: May be make use of &#39;fprogress&#39;-option to indicate</span>
            <span class="c1"># progress</span>
            <span class="c1"># But then, we don&#39;t have it for git-annex add, anyway.</span>
            <span class="c1">#</span>
            <span class="c1"># TODO: Is write=True a reasonable way to do it?</span>
            <span class="c1"># May be should not write until success of operation is</span>
            <span class="c1"># confirmed?</span>
            <span class="c1"># What&#39;s best in case of a list of files?</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;add: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Make sure return value from GitRepo is consistent with AnnexRepo</span>
        <span class="c1"># currently simulating similar return value, assuming success</span>
        <span class="c1"># for all files:</span>
        <span class="c1"># TODO: Make return values consistent across both *Repo classes!</span>
        <span class="k">return</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_process_git_get_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given both outputs (stderr is ignored atm) of git add - process it</span>

<span class="sd">        Primarily to centralize handling in both indirect annex and direct</span>
<span class="sd">        modes when ran through proxy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[{</span><span class="sa">u</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;&#39;(.*)&#39;[</span><span class="se">\n</span><span class="s2">$]&quot;</span><span class="p">,</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="n">stdout</span><span class="p">))]</span>

<div class="viewcode-block" id="GitRepo.remove"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.remove">[docs]</a>    <span class="nd">@normalize_paths</span><span class="p">(</span><span class="n">match_return_type</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove files.</span>

<span class="sd">        Calls git-rm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files: str</span>
<span class="sd">          list of paths to remove</span>
<span class="sd">        recursive: False</span>
<span class="sd">          whether to allow recursive removal from subdirectories</span>
<span class="sd">        kwargs:</span>
<span class="sd">          see `__init__`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [str]</span>
<span class="sd">          list of successfully removed files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># output per removed file is expected to be &quot;rm &#39;PATH&#39;&quot;:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_items_</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;rm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">to_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="GitRepo.precommit"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.precommit">[docs]</a>    <span class="k">def</span> <span class="nf">precommit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform pre-commit maintenance tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># we used to clean up GitPython here</span>
        <span class="k">pass</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_prefixed_commit_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
        <span class="n">DATALAD_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;[DATALAD]&quot;</span>
        <span class="k">return</span> <span class="n">DATALAD_PREFIX</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DATALAD_PREFIX</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<div class="viewcode-block" id="GitRepo.configure_fake_dates"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.configure_fake_dates">[docs]</a>    <span class="k">def</span> <span class="nf">configure_fake_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure repository to use fake dates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Enabling fake dates&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;datalad.fake-dates&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fake_dates_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the repository configured to use fake dates?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this turned into a private property of the CoreGitRepo</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fake_dates_enabled</span>

<div class="viewcode-block" id="GitRepo.add_fake_dates"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.add_fake_dates">[docs]</a>    <span class="k">def</span> <span class="nf">add_fake_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="c1"># was renamed in CoreGitRepo</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_fake_dates_to_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.commit"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_datalad_msg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">careless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Commit changes to git.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg: str, optional</span>
<span class="sd">          commit-message</span>
<span class="sd">        options: list of str, optional</span>
<span class="sd">          cmdline options for git-commit</span>
<span class="sd">        _datalad_msg: bool, optional</span>
<span class="sd">          To signal that commit is automated commit by datalad, so</span>
<span class="sd">          it would carry the [DATALAD] prefix</span>
<span class="sd">        careless: bool, optional</span>
<span class="sd">          if False, raise when there&#39;s nothing actually committed;</span>
<span class="sd">          if True, don&#39;t care</span>
<span class="sd">        files: list of str, optional</span>
<span class="sd">          path(s) to commit</span>
<span class="sd">        date: str, optional</span>
<span class="sd">          Date in one of the formats git understands</span>
<span class="sd">        index_file: str, optional</span>
<span class="sd">          An alternative index to use</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">precommit</span><span class="p">()</span>

        <span class="c1"># assemble commandline</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_git_cmd_prefix</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--date&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">]</span>

        <span class="n">orig_msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;--amend&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;--no-edit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                    <span class="c1"># don&#39;t overwrite old commit message with our default</span>
                    <span class="c1"># message by default, but re-use old one. In other words:</span>
                    <span class="c1"># Make --no-edit the default:</span>
                    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--no-edit&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Recorded changes&#39;</span>
                <span class="n">_datalad_msg</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">_datalad_msg</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prefixed_commit_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">]</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># set up env for commit</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_fake_dates</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_dates_enabled</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">index_file</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;GIT_INDEX_FILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_file</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Committing via direct call of git: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="n">file_chunks</span> <span class="o">=</span> <span class="n">generate_file_chunks</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="k">if</span> <span class="n">files</span> <span class="k">else</span> <span class="p">[[]]</span>

        <span class="c1"># store pre-commit state to be able to check if anything was committed</span>
        <span class="n">prev_sha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hexsha</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_chunks</span><span class="p">):</span>
                <span class="n">cur_cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># if this is an explicit dry-run, there is no point in</span>
                <span class="c1"># amending, because no commit was ever made</span>
                <span class="c1"># otherwise, amend the first commit, and prevent</span>
                <span class="c1"># leaving multiple commits behind</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;--dry-run&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;--amend&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                        <span class="n">cur_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--amend&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;--no-edit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                        <span class="n">cur_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--no-edit&#39;</span><span class="p">)</span>
                <span class="n">cur_cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">chunk</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_git_runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="n">cur_cmd</span><span class="p">,</span>
                    <span class="n">protocol</span><span class="o">=</span><span class="n">StdOutErrCapture</span><span class="p">,</span>
                    <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># real errors first</span>
            <span class="k">if</span> <span class="s2">&quot;did not match any file(s) known to git&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FileNotInRepositoryError</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">cmd</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;File(s) unknown to git&quot;</span><span class="p">,</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                        <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;error: pathspec&quot;</span><span class="p">)</span>
                    <span class="p">])</span>
                <span class="p">)</span>
            <span class="c1"># behavior choices now</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">careless</span><span class="p">:</span>
                <span class="c1"># not willing to compromise at all</span>
                <span class="k">raise</span>
            <span class="k">elif</span> <span class="s1">&#39;nothing to commit&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;nothing to commit in </span><span class="si">%s</span><span class="s2">. Ignored.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;no changes added to commit&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> \
                    <span class="s1">&#39;nothing added to commit&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;no changes added to commit in </span><span class="si">%s</span><span class="s2">. Ignored.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="n">orig_msg</span> \
                <span class="ow">or</span> <span class="s1">&#39;--dry-run&#39;</span> <span class="ow">in</span> <span class="n">cmd</span> \
                <span class="ow">or</span> <span class="n">prev_sha</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hexsha</span><span class="p">()</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;--amend&#39;</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s1">&#39;--no-edit&#39;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_interactive</span><span class="p">())</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">obtain</span><span class="p">(</span><span class="s1">&#39;datalad.save.no-message&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;interactive&#39;</span><span class="p">:</span>
            <span class="c1"># we had a message given, or nothing was committed, or prev. commit</span>
            <span class="c1"># was amended, or we are not connected to a terminal, or no</span>
            <span class="c1"># interactive message input is desired:</span>
            <span class="c1"># we can go home</span>
            <span class="k">return</span>

        <span class="c1"># handle interactive message entry by running another `git-commit`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_git_runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">cmd</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;--amend&#39;</span><span class="p">,</span> <span class="s1">&#39;--edit&#39;</span><span class="p">],</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">NoCapture</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># TODO usage is primarily in the tests, consider making a test helper and</span>
    <span class="c1"># remove from GitRepo API</span>
<div class="viewcode-block" id="GitRepo.get_indexed_files"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_indexed_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexed_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of files in git&#39;s index</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of paths rooting in git&#39;s base dir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_info</span><span class="p">(</span>
                <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="GitRepo.format_commit"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.format_commit">[docs]</a>    <span class="k">def</span> <span class="nf">format_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">commitish</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return `git show` output for `commitish`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmt : str</span>
<span class="sd">            A format string accepted by `git show`.</span>
<span class="sd">        commitish: str, optional</span>
<span class="sd">          Any commit identifier (defaults to &quot;HEAD&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or, if there are not commits yet, None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># use git-log and not git-show due to faster performance with</span>
        <span class="c1"># complex commits (e.g. octopus merges)</span>
        <span class="c1"># https://github.com/datalad/datalad/issues/4801</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=&#39;</span> <span class="o">+</span> <span class="n">fmt</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">commitish</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commitish</span> <span class="o">+</span> <span class="s2">&quot;^</span><span class="si">{commit}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># make sure Git takes our argument as a revision</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">expect_stderr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expect_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;bad revision&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown commit identifier: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">commitish</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;does not have any commits yet&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="c1"># This trailing null is coming from the -z above, which avoids the</span>
        <span class="c1"># newline that Git would append to the output. We could drop -z and</span>
        <span class="c1"># strip the newline directly, but then we&#39;d have to worry about</span>
        <span class="c1"># compatibility across platforms.</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="GitRepo.get_hexsha"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_hexsha">[docs]</a>    <span class="k">def</span> <span class="nf">get_hexsha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commitish</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a hexsha for a given commitish.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        commitish : str, optional</span>
<span class="sd">          Any identifier that refers to a commit (defaults to &quot;HEAD&quot;).</span>
<span class="sd">        short : bool, optional</span>
<span class="sd">          Return the abbreviated form of the hexsha.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or, if no commitish was given and there are no commits yet, None.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">          If a commitish was given, but no corresponding commit could be</span>
<span class="sd">          determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># use --quiet because the &#39;Needed a single revision&#39; error message</span>
        <span class="c1"># that is the result of running this in a repo with no commits</span>
        <span class="c1"># isn&#39;t useful to report</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="s1">&#39;--quiet&#39;</span><span class="p">,</span> <span class="s1">&#39;--verify&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">^{{commit}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">commitish</span> <span class="k">if</span> <span class="n">commitish</span> <span class="k">else</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">short</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--short&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_oneline</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">commitish</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown commit identifier: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">commitish</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.get_last_commit_hexsha"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_last_commit_hexsha">[docs]</a>    <span class="nd">@normalize_paths</span><span class="p">(</span><span class="n">match_return_type</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_last_commit_hexsha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the hash of the last commit the modified any of the given</span>
<span class="sd">        paths&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;rev-list&#39;</span><span class="p">,</span> <span class="s1">&#39;-n1&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">],</span>
                <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
                <span class="n">expect_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">commit</span> <span class="k">if</span> <span class="n">commit</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hexsha</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># unborn branch, don&#39;t freak out</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="GitRepo.get_revisions"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_revisions">[docs]</a>    <span class="k">def</span> <span class="nf">get_revisions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">revrange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;%H&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of revisions in `revrange`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        revrange : str or list of str or None, optional</span>
<span class="sd">            Revisions or revision ranges to walk. If None, revision defaults to</span>
<span class="sd">            HEAD unless a revision-modifying option like `--all` or</span>
<span class="sd">            `--branches` is included in `options`.</span>
<span class="sd">        fmt : string, optional</span>
<span class="sd">            Format accepted by `--format` option of `git log`. This should not</span>
<span class="sd">            contain new lines because the output is split on new lines.</span>
<span class="sd">        options : list of str, optional</span>
<span class="sd">            Options to pass to `git log`.  This should not include `--format`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List of revisions (str), formatted according to `fmt`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">revrange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">revrange</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">revrange</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">revrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">revrange</span><span class="p">]</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;--format=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">)]</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">options</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">revrange</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;--&quot;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">expect_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;does not have any commits&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span></div>

<div class="viewcode-block" id="GitRepo.commit_exists"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.commit_exists">[docs]</a>    <span class="k">def</span> <span class="nf">commit_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commitish</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does `commitish` exist in the repo?</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        commitish : str</span>
<span class="sd">            A commit or an object that can be dereferenced to one.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: The peeling operator &quot;^{commit}&quot; is required so that rev-parse</span>
        <span class="c1"># doesn&#39;t succeed if passed a full hexsha that is valid but doesn&#39;t</span>
        <span class="c1"># exist.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_success</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;--verify&quot;</span><span class="p">,</span> <span class="n">commitish</span> <span class="o">+</span> <span class="s2">&quot;^</span><span class="si">{commit}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.get_merge_base"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_merge_base">[docs]</a>    <span class="k">def</span> <span class="nf">get_merge_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commitishes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a merge base hexsha</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        commitishes: str or list of str</span>
<span class="sd">          List of commitishes (branches, hexshas, etc) to determine the merge</span>
<span class="sd">          base of. If a single value provided, returns merge_base with the</span>
<span class="sd">          current branch.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">          If no merge-base for given commits, or specified treeish doesn&#39;t</span>
<span class="sd">          exist, None returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">commitishes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">commitishes</span> <span class="o">=</span> <span class="p">[</span><span class="n">commitishes</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">commitishes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide at least a single value&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">commitishes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">commitishes</span> <span class="o">=</span> <span class="n">commitishes</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_active_branch</span><span class="p">()]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_oneline</span><span class="p">([</span><span class="s1">&#39;merge-base&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">commitishes</span><span class="p">,</span>
                                         <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> <span class="n">exc</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
                <span class="c1"># No merge base was found (unrelated commits).</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;fatal: Not a valid object name&quot;</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">base</span></div>

<div class="viewcode-block" id="GitRepo.is_ancestor"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.is_ancestor">[docs]</a>    <span class="k">def</span> <span class="nf">is_ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reva</span><span class="p">,</span> <span class="n">revb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is `reva` an ancestor of `revb`?</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reva, revb : str</span>
<span class="sd">            Revisions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_success</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;merge-base&quot;</span><span class="p">,</span> <span class="s2">&quot;--is-ancestor&quot;</span><span class="p">,</span> <span class="n">reva</span><span class="p">,</span> <span class="n">revb</span><span class="p">],</span>
            <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.get_commit_date"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_commit_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_commit_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;authored&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the date stamp of the last commit (in a branch or head otherwise)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date: {&#39;authored&#39;, &#39;committed&#39;}</span>
<span class="sd">          Which date to return.  &quot;authored&quot; will be the date shown by &quot;git show&quot;</span>
<span class="sd">          and the one possibly specified via --date to `git commit`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or None</span>
<span class="sd">          None if no commit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">==</span> <span class="s1">&#39;committed&#39;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">t&#39;</span>
        <span class="k">elif</span> <span class="n">date</span> <span class="o">==</span> <span class="s1">&#39;authored&#39;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1">t&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknow date type: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_commit</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">commitish</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GitRepo.get_active_branch"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_active_branch">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the name of the active branch</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">          Returns None if there is no active branch, i.e. detached HEAD,</span>
<span class="sd">          and the branch name otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">([</span><span class="s2">&quot;symbolic-ref&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span> <span class="n">expect_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;HEAD is not a symbolic ref&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;detached HEAD in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">11</span><span class="p">:]</span>  <span class="c1"># strip refs/heads/</span></div>

<div class="viewcode-block" id="GitRepo.get_corresponding_branch"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_corresponding_branch">[docs]</a>    <span class="k">def</span> <span class="nf">get_corresponding_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Always returns None, a plain GitRepo has no managed branches&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GitRepo.get_branches"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_branches">[docs]</a>    <span class="k">def</span> <span class="nf">get_branches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all branches of the repo.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [str]</span>
<span class="sd">            Names of all branches of this repository.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">b</span><span class="p">[</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_each_ref_</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;refs/heads&#39;</span><span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="GitRepo.get_remote_branches"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_remote_branches">[docs]</a>    <span class="k">def</span> <span class="nf">get_remote_branches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all branches of all remotes of the repo.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        [str]</span>
<span class="sd">            Names of all remote branches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Reconsider melting with get_branches()</span>

        <span class="c1"># TODO: treat entries like this: origin/HEAD -&gt; origin/master&#39;</span>
        <span class="c1"># currently this is done in collection</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">b</span><span class="p">[</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_each_ref_</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;refs/remotes&#39;</span><span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="GitRepo.get_remotes"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_remotes">[docs]</a>    <span class="k">def</span> <span class="nf">get_remotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_urls_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get known remotes of the repository</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        with_urls_only : bool, optional</span>
<span class="sd">          return only remotes which have urls</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        remotes : list of str</span>
<span class="sd">          List of names of the remotes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">datalad.utils</span> <span class="kn">import</span> <span class="n">unique</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="n">remotes</span> <span class="o">=</span> <span class="n">unique</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;remote.&quot;</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">with_urls_only</span><span class="p">:</span>
            <span class="n">remotes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remotes</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remote.</span><span class="si">%s</span><span class="s1">.url&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">remotes</span></div>

    <span class="c1"># TODO this is practically unused outside the tests, consider turning</span>
    <span class="c1"># into a test helper and trim from the API</span>
<div class="viewcode-block" id="GitRepo.get_files"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of files in git.</span>

<span class="sd">        Lists the files in the (remote) branch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        branch: str</span>
<span class="sd">          Name of the branch to query. Default: active branch.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [str]</span>
<span class="sd">          list of files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_info</span><span class="p">(</span>
                <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
            <span class="p">]</span></div>

<div class="viewcode-block" id="GitRepo.add_remote"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.add_remote">[docs]</a>    <span class="k">def</span> <span class="nf">add_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register remote pointing to a url</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">options</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">]</span>

        <span class="c1"># for historical reasons this method returns stdout and</span>
        <span class="c1"># stderr, keeping that for now</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_git</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GitRepo.remove_remote"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.remove_remote">[docs]</a>    <span class="k">def</span> <span class="nf">remove_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove existing remote</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: testing and error handling!</span>
        <span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">RemoteNotAvailableError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">([</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;No such remote&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RemoteNotAvailableError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">cmd</span><span class="o">=</span><span class="s2">&quot;git remote remove&quot;</span><span class="p">,</span>
                                              <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;No such remote&quot;</span><span class="p">,</span>
                                              <span class="n">stdout</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                              <span class="n">stderr</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># config.reload necessary, because the associated remote config</span>
        <span class="c1"># will vanish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_maybe_open_ssh_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="p">,</span> <span class="n">prefer_push</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open connection if `remote` has an SSH URL.</span>

<span class="sd">        Doing so enables SSH caching, preventing datalad-sshrun subprocesses</span>
<span class="sd">        from opening (and then closing) their own.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote : str</span>
<span class="sd">        prefer_push : bool, optional</span>
<span class="sd">            Use `remote.&lt;remote&gt;.pushurl` if there is one, falling back to</span>
<span class="sd">            `remote.&lt;remote&gt;.url`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">remote</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">prefer_push</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_url</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">push</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_url</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">is_ssh</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                <span class="n">ssh_manager</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

<div class="viewcode-block" id="GitRepo.update_remote"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.update_remote">[docs]</a>    <span class="k">def</span> <span class="nf">update_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-v&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_open_ssh_connection</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;remote&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">options</span><span class="p">,</span>
            <span class="n">expect_stderr</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.fetch"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetches changes from a remote (or all remotes).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote : str, optional</span>
<span class="sd">          name of the remote to fetch from. If no remote is given and</span>
<span class="sd">          `all_` is not set, the tracking branch is fetched.</span>
<span class="sd">        refspec : str or list, optional</span>
<span class="sd">          refspec(s) to fetch.</span>
<span class="sd">        all_ : bool, optional</span>
<span class="sd">          fetch all remotes (and all of their branches).</span>
<span class="sd">          Fails if `remote` was given.</span>
<span class="sd">        git_options : list, optional</span>
<span class="sd">          Additional command line options for git-fetch.</span>
<span class="sd">        kwargs :</span>
<span class="sd">          Deprecated. GitPython-style keyword argument for git-fetch.</span>
<span class="sd">          Will be appended to any git_options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">git_options</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">git_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">git_options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">to_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_</span><span class="p">(</span>
                <span class="n">remote</span><span class="o">=</span><span class="n">remote</span><span class="p">,</span>
                <span class="n">refspec</span><span class="o">=</span><span class="n">refspec</span><span class="p">,</span>
                <span class="n">all_</span><span class="o">=</span><span class="n">all_</span><span class="p">,</span>
                <span class="n">git_options</span><span class="o">=</span><span class="n">git_options</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.fetch_"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.fetch_">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like `fetch`, but returns a generator&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_push_helper</span><span class="p">(</span>
            <span class="n">base_cmd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_git_cmd_prefix</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;--progress&#39;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span>
            <span class="n">urlvars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;remote.</span><span class="si">{}</span><span class="s1">.url&#39;</span><span class="p">,</span> <span class="s1">&#39;remote.</span><span class="si">{}</span><span class="s1">.url&#39;</span><span class="p">),</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">GitProgress</span><span class="p">,</span>
            <span class="n">info_cls</span><span class="o">=</span><span class="n">FetchInfo</span><span class="p">,</span>
            <span class="n">info_from</span><span class="o">=</span><span class="s1">&#39;stderr&#39;</span><span class="p">,</span>
            <span class="n">add_remote</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">remote</span><span class="o">=</span><span class="n">remote</span><span class="p">,</span>
            <span class="n">refspec</span><span class="o">=</span><span class="n">refspec</span><span class="p">,</span>
            <span class="n">all_</span><span class="o">=</span><span class="n">all_</span><span class="p">,</span>
            <span class="n">git_options</span><span class="o">=</span><span class="n">git_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.push"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.push">[docs]</a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_remotes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">all_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Push changes to a remote (or all remotes).</span>

<span class="sd">        If remote and refspec are specified, and remote has</span>
<span class="sd">        `remote.{remote}.datalad-push-default-first` configuration variable</span>
<span class="sd">        set (e.g. by `create-sibling-github`), we will first push the first</span>
<span class="sd">        refspec separately to possibly ensure that the first refspec is chosen</span>
<span class="sd">        by remote as the &quot;default branch&quot;.</span>
<span class="sd">        See https://github.com/datalad/datalad/issues/4997</span>
<span class="sd">        Upon successful push if this variable was set in the local git config,</span>
<span class="sd">        we unset it, so subsequent pushes would proceed normally.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote : str, optional</span>
<span class="sd">          name of the remote to push to. If no remote is given and</span>
<span class="sd">          `all_` is not set, the tracking branch is pushed.</span>
<span class="sd">        refspec : str or list, optional</span>
<span class="sd">          refspec(s) to push.</span>
<span class="sd">        all_ : bool, optional</span>
<span class="sd">          push to all remotes. Fails if `remote` was given.</span>
<span class="sd">        git_options : list, optional</span>
<span class="sd">          Additional command line options for git-push.</span>
<span class="sd">        kwargs :</span>
<span class="sd">          Deprecated. GitPython-style keyword argument for git-push.</span>
<span class="sd">          Will be appended to any git_options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">git_options</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">git_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">git_options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">to_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">all_remotes</span><span class="p">:</span>
            <span class="c1"># be nice to the elderly</span>
            <span class="n">all_</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">push_refspecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">refspec</span><span class="p">]</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>  <span class="c1"># shortcut</span>
        <span class="n">cfg_push_var</span> <span class="o">=</span> <span class="s2">&quot;remote.</span><span class="si">{}</span><span class="s2">.datalad-push-default-first&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remote</span> <span class="ow">and</span> <span class="n">refspec</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">obtain</span><span class="p">(</span><span class="n">cfg_push_var</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">valtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">refspec</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">refspec</span><span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;As indicated by </span><span class="si">%s</span><span class="s2"> pushing first refspec </span><span class="si">%s</span><span class="s2"> separately first&quot;</span><span class="p">,</span>
                      <span class="n">cfg_push_var</span><span class="p">,</span> <span class="n">refspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">push_refspecs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">refspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">refspec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="n">push_res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">refspecs</span> <span class="ow">in</span> <span class="n">push_refspecs</span><span class="p">:</span>
            <span class="n">push_res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push_</span><span class="p">(</span>
                    <span class="n">remote</span><span class="o">=</span><span class="n">remote</span><span class="p">,</span>
                    <span class="n">refspec</span><span class="o">=</span><span class="n">refspecs</span><span class="p">,</span>
                    <span class="n">all_</span><span class="o">=</span><span class="n">all_</span><span class="p">,</span>
                    <span class="n">git_options</span><span class="o">=</span><span class="n">git_options</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># note: above push_ should raise exception if errors out</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_from_source</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">cfg_push_var</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">%s</span><span class="s2"> variable from local git config after successful push&quot;</span><span class="p">,</span> <span class="n">cfg_push_var</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">cfg_push_var</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">push_res</span></div>

<div class="viewcode-block" id="GitRepo.push_"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.push_">[docs]</a>    <span class="k">def</span> <span class="nf">push_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like `push`, but returns a generator&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_push_helper</span><span class="p">(</span>
            <span class="n">base_cmd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_git_cmd_prefix</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s1">&#39;--progress&#39;</span><span class="p">,</span> <span class="s1">&#39;--porcelain&#39;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;push&#39;</span><span class="p">,</span>
            <span class="n">urlvars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;remote.</span><span class="si">{}</span><span class="s1">.pushurl&#39;</span><span class="p">,</span> <span class="s1">&#39;remote.</span><span class="si">{}</span><span class="s1">.url&#39;</span><span class="p">),</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">StdOutCaptureWithGitProgress</span><span class="p">,</span>
            <span class="n">info_cls</span><span class="o">=</span><span class="n">PushInfo</span><span class="p">,</span>
            <span class="n">info_from</span><span class="o">=</span><span class="s1">&#39;stdout&#39;</span><span class="p">,</span>
            <span class="n">add_remote</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">remote</span><span class="o">=</span><span class="n">remote</span><span class="p">,</span>
            <span class="n">refspec</span><span class="o">=</span><span class="n">refspec</span><span class="p">,</span>
            <span class="n">all_</span><span class="o">=</span><span class="n">all_</span><span class="p">,</span>
            <span class="n">git_options</span><span class="o">=</span><span class="n">git_options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_fetch_push_helper</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">base_cmd</span><span class="p">,</span>     <span class="c1"># arg list</span>
            <span class="n">action</span><span class="p">,</span>       <span class="c1"># label fetch|push</span>
            <span class="n">urlvars</span><span class="p">,</span>      <span class="c1"># variables to query for URLs</span>
            <span class="n">protocol</span><span class="p">,</span>     <span class="c1"># processor for output</span>
            <span class="n">info_cls</span><span class="p">,</span>     <span class="c1"># Push|FetchInfo</span>
            <span class="n">info_from</span><span class="p">,</span>    <span class="c1"># stdout, stderr</span>
            <span class="n">add_remote</span><span class="p">,</span>   <span class="c1"># whether to add a &#39;remote&#39; field to the info dict</span>
            <span class="n">remote</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">git_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">git_options</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">git_options</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="n">base_cmd</span> <span class="o">+</span> <span class="n">git_options</span>

        <span class="k">if</span> <span class="n">remote</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">refspec</span><span class="p">:</span>
                <span class="c1"># conflicts with using tracking branch or push all remotes</span>
                <span class="c1"># For now: Just fail.</span>
                <span class="c1"># TODO: May be check whether it fits to tracking branch</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;refspec specified without a remote. (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">refspec</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">all_</span><span class="p">:</span>
                <span class="n">remotes_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remotes</span><span class="p">(</span><span class="n">with_urls_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No explicit remote to fetch.</span>
                <span class="c1"># =&gt; get tracking branch:</span>
                <span class="n">tb_remote</span><span class="p">,</span> <span class="n">refspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tracking_branch</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tb_remote</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">remotes_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">tb_remote</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No remote, no tracking branch</span>
                    <span class="c1"># =&gt; fail</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Neither a remote is specified to </span><span class="si">{}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;from nor a tracking branch is set up.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">all_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Option &#39;all_&#39; conflicts with specified remote &quot;</span>
                    <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remote</span><span class="p">))</span>
            <span class="n">remotes_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">remote</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">refspec</span><span class="p">:</span>
            <span class="c1"># prep for appending to cmd</span>
            <span class="n">refspec</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">refspec</span><span class="p">)</span>

        <span class="c1"># no need for progress report, when there is just one remote</span>
        <span class="n">log_remote_progress</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remotes_to_process</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">log_remote_progress</span><span class="p">:</span>
            <span class="n">pbar_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">remotes-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="n">log_progress</span><span class="p">(</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                <span class="n">pbar_id</span><span class="p">,</span>
                <span class="s1">&#39;Start </span><span class="si">%s</span><span class="s1">ing remotes for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">remotes_to_process</span><span class="p">),</span>
                <span class="n">label</span><span class="o">=</span><span class="n">action</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; Remotes&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">remote</span> <span class="ow">in</span> <span class="n">remotes_to_process</span><span class="p">:</span>
                <span class="n">r_cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="p">[</span><span class="n">remote</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">refspec</span><span class="p">:</span>
                    <span class="n">r_cmd</span> <span class="o">+=</span> <span class="n">refspec</span>

                <span class="k">if</span> <span class="n">log_remote_progress</span><span class="p">:</span>
                    <span class="n">log_progress</span><span class="p">(</span>
                        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                        <span class="n">pbar_id</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">ing remote </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()),</span>
                        <span class="n">remote</span><span class="p">,</span>
                        <span class="n">update</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">increment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># best effort to enable SSH connection caching</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="c1"># make two attempts to get a URL</span>
                    <span class="n">urlvars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remote</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">urlvars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remote</span><span class="p">),</span>
                        <span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">is_ssh</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                    <span class="n">ssh_manager</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_git_runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="n">r_cmd</span><span class="p">,</span>
                        <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">info_from</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># intercept some errors that we express as an error report</span>
                    <span class="c1"># in the info dicts</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                            <span class="s1">&#39;.*^error: failed to (push|fetch) some refs&#39;</span><span class="p">,</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                            <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">):</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">info_from</span><span class="p">)</span>
                        <span class="n">hints</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                                          <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;hint: &#39;</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">:</span>
                        <span class="k">raise</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># push info doesn&#39;t identify a remote, add it here</span>
                        <span class="n">pi</span> <span class="o">=</span> <span class="n">info_cls</span><span class="o">.</span><span class="n">_from_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">add_remote</span><span class="p">:</span>
                            <span class="n">pi</span><span class="p">[</span><span class="s1">&#39;remote&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote</span>
                        <span class="c1"># There were errors, but Git provided hints</span>
                        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">pi</span><span class="p">[</span><span class="s1">&#39;operations&#39;</span><span class="p">]:</span>
                            <span class="n">pi</span><span class="p">[</span><span class="s1">&#39;hints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hints</span> <span class="ow">or</span> <span class="kc">None</span>
                        <span class="k">yield</span> <span class="n">pi</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># it is not progress and no push info</span>
                        <span class="c1"># don&#39;t hide it completely</span>
                        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;git-</span><span class="si">%s</span><span class="s1"> reported: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_remote_progress</span><span class="p">:</span>
                <span class="n">log_progress</span><span class="p">(</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                    <span class="n">pbar_id</span><span class="p">,</span>
                    <span class="s1">&#39;Finished </span><span class="si">%s</span><span class="s1">ing remotes for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>

<div class="viewcode-block" id="GitRepo.get_remote_url"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_remote_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the url of a remote.</span>

<span class="sd">        Reads the configuration of remote `name` and returns its url or None,</span>
<span class="sd">        if there is no url configured.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">          name of the remote</span>
<span class="sd">        push: bool</span>
<span class="sd">          if True, get the pushurl instead of the fetch url.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;remote.</span><span class="si">{0}</span><span class="s1">.</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pushurl&#39;</span> <span class="k">if</span> <span class="n">push</span> <span class="k">else</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.set_remote_url"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.set_remote_url">[docs]</a>    <span class="k">def</span> <span class="nf">set_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the URL a remote is pointing to</span>

<span class="sd">        Sets the URL of the remote `name`. Requires the remote to already exist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">          name of the remote</span>
<span class="sd">        url: str</span>
<span class="sd">        push: bool</span>
<span class="sd">          if True, set the push URL, otherwise the fetch URL</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;remote.</span><span class="si">{0}</span><span class="s1">.</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pushurl&#39;</span> <span class="k">if</span> <span class="n">push</span> <span class="k">else</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.get_branch_commits_"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_branch_commits_">[docs]</a>    <span class="k">def</span> <span class="nf">get_branch_commits_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return commit hexshas for a branch</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        branch: str, optional</span>
<span class="sd">          If not provided, assumes current branch</span>
<span class="sd">        limit: None | &#39;left-only&#39;, optional</span>
<span class="sd">          Limit which commits to report.  If None -- all commits (merged or not),</span>
<span class="sd">          if &#39;left-only&#39; -- only the commits from the left side of the tree upon</span>
<span class="sd">          merges</span>
<span class="sd">        stop: str, optional</span>
<span class="sd">          hexsha of the commit at which stop reporting (matched one is not</span>
<span class="sd">          reported either)</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rev-list&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="s1">&#39;left-only&#39;</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--left-only&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">branch</span><span class="p">:</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_branch</span><span class="p">()</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_items_</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">and</span> <span class="n">stop</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">yield</span> <span class="n">r</span></div>

<div class="viewcode-block" id="GitRepo.checkout"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.checkout">[docs]</a>    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: May be check for the need of -b options herein?</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;checkout&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">options</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">expect_stderr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># checkout can change committed config, or create branch config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span></div>

    <span class="c1"># TODO: Before implementing annex merge, find usages and check for a needed</span>
    <span class="c1"># change to call super().merge</span>
<div class="viewcode-block" id="GitRepo.merge"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_unrelated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">]</span>
        <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--allow-unrelated-histories&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;merge&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">options</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.remove_branch"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.remove_branch">[docs]</a>    <span class="k">def</span> <span class="nf">remove_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">([</span><span class="s1">&#39;branch&#39;</span><span class="p">,</span> <span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="n">branch</span><span class="p">])</span></div>

<div class="viewcode-block" id="GitRepo.cherry_pick"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.cherry_pick">[docs]</a>    <span class="k">def</span> <span class="nf">cherry_pick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cherry pick `commit` to the current branch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        commit : str</span>
<span class="sd">            A single commit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">([</span><span class="s2">&quot;cherry-pick&quot;</span><span class="p">,</span> <span class="n">commit</span><span class="p">])</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the repository dirty?</span>

<span class="sd">        Note: This provides a quick answer when you simply want to know if</span>
<span class="sd">        there are any untracked changes or modifications in this repository or</span>
<span class="sd">        its submodules. For finer-grained control and more detailed reporting,</span>
<span class="sd">        use status() instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;--porcelain&quot;</span><span class="p">,</span>
             <span class="c1"># Ensure the result isn&#39;t influenced by status.showUntrackedFiles.</span>
             <span class="s2">&quot;--untracked-files=normal&quot;</span><span class="p">,</span>
             <span class="c1"># Ensure the result isn&#39;t influenced by diff.ignoreSubmodules.</span>
             <span class="s2">&quot;--ignore-submodules=none&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
            <span class="c1"># The quick `git status`-based check can give a different answer</span>
            <span class="c1"># than `datalad status` for submodules on an adjusted branch.</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffstatus</span><span class="p">(</span><span class="n">fr</span><span class="o">=</span><span class="s2">&quot;HEAD&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hexsha</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;clean&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">untracked_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Legacy interface, do not use! Use the status() method instead.</span>

<span class="sd">        Despite its name, it also reports on untracked datasets, and</span>
<span class="sd">        yields their names with trailing path separators.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">)),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="k">if</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;file&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">(</span>
                    <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">eval_submodule_state</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;untracked&#39;</span>
        <span class="p">]</span>

<div class="viewcode-block" id="GitRepo.gc"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.gc">[docs]</a>    <span class="k">def</span> <span class="nf">gc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform house keeping (garbage collection, repacking)&quot;&quot;&quot;</span>
        <span class="n">cmd_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_background</span><span class="p">:</span>
            <span class="n">cmd_options</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;gc.autodetach=0&#39;</span><span class="p">]</span>
        <span class="n">cmd_options</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;--aggressive&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">auto</span><span class="p">:</span>
            <span class="n">cmd_options</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--auto&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span><span class="n">cmd_options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_parse_gitmodules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO read .gitconfig from Git blob?</span>
        <span class="n">gitmodules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;.gitmodules&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gitmodules</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="c1"># pull out file content</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--file&#39;</span><span class="p">,</span> <span class="s1">&#39;.gitmodules&#39;</span><span class="p">],</span>
            <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># abuse our config parser</span>
        <span class="c1"># disable multi-value report, because we could not deal with them</span>
        <span class="c1"># anyways, and they should not appear in a normal .gitmodules file</span>
        <span class="c1"># but could easily appear when duplicates are included. In this case,</span>
        <span class="c1"># we better not crash</span>
        <span class="n">db</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parse_gitconfig_dump</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">multi_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;submodule.&#39;</span><span class="p">):</span>
                <span class="c1"># we don&#39;t know what this is</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skip unrecognized .gitmodule specification: </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">k_l</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="c1"># module name is everything after &#39;submodule.&#39; that is not the variable</span>
            <span class="c1"># name</span>
            <span class="n">mod_name</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k_l</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># variable name is the last &#39;dot-free&#39; segment in the key</span>
            <span class="n">mod</span><span class="p">[</span><span class="n">k_l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">mods</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># bring into traditional shape</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
                <span class="n">lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to get &#39;</span><span class="si">%s</span><span class="s2">.path&#39;, skipping this submodule&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">modprops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gitmodule_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">)}</span>
            <span class="n">modpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="n">PurePosixPath</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
            <span class="n">modprops</span><span class="p">[</span><span class="s1">&#39;gitmodule_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">out</span><span class="p">[</span><span class="n">modpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">modprops</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="GitRepo.get_submodules_"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_submodules_">[docs]</a>    <span class="k">def</span> <span class="nf">get_submodules_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield submodules in this repository.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        paths : list(pathlib.PurePath), optional</span>
<span class="sd">            Restrict submodules to those under `paths`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A generator that yields a dictionary with information for each</span>
<span class="sd">        submodule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s2">&quot;.gitmodules&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">modinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_gitmodules</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_info</span><span class="p">(</span>
                <span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
                <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span>
                <span class="c1"># make sure this method never talks about non-dataset</span>
                <span class="c1"># content</span>
                <span class="k">continue</span>
            <span class="n">props</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">props</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">modinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="k">yield</span> <span class="n">props</span></div>

<div class="viewcode-block" id="GitRepo.get_submodules"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_submodules">[docs]</a>    <span class="k">def</span> <span class="nf">get_submodules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sorted_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of submodules.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sorted_ : bool, optional</span>
<span class="sd">            Sort submodules by path name.</span>
<span class="sd">        paths : list(pathlib.PurePath), optional</span>
<span class="sd">            Restrict submodules to those under `paths`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List of submodule namedtuples if `compat` is true or otherwise a list</span>
<span class="sd">        of dictionaries as returned by `get_submodules_`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_submodules_</span><span class="p">(</span><span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sorted_</span><span class="p">:</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.update_ref"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.update_ref">[docs]</a>    <span class="k">def</span> <span class="nf">update_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">oldvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symbolic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the object name stored in a ref &quot;safely&quot;.</span>

<span class="sd">        Just a shim for `git update-ref` call if not symbolic, and</span>
<span class="sd">        `git symbolic-ref` if symbolic</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ref : str</span>
<span class="sd">          Reference, such as `ref/heads/BRANCHNAME` or HEAD.</span>
<span class="sd">        value : str</span>
<span class="sd">          Value to update to, e.g. hexsha of a commit when updating for a</span>
<span class="sd">          branch ref, or branch ref if updating HEAD</span>
<span class="sd">        oldvalue: str</span>
<span class="sd">          Value to update from. Safeguard to be verified by git. This is only</span>
<span class="sd">          valid if `symbolic` is not True.</span>
<span class="sd">        symbolic : None</span>
<span class="sd">          To instruct if ref is symbolic, e.g. should be used in case of</span>
<span class="sd">          ref=HEAD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbolic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oldvalue</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;oldvalue and symbolic must not be given both&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;symbolic-ref&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;update-ref&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="n">oldvalue</span><span class="p">]</span> <span class="k">if</span> <span class="n">oldvalue</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.tag"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.tag">[docs]</a>    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tag a commit</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag : str</span>
<span class="sd">          Custom tag label. Must be a valid tag name.</span>
<span class="sd">        message : str, optional</span>
<span class="sd">          If provided, adds [&#39;-m&#39;, &lt;message&gt;] to the list of `git tag`</span>
<span class="sd">          arguments.</span>
<span class="sd">        commit : str, optional</span>
<span class="sd">          If provided, will be appended as last argument to the `git tag` call,</span>
<span class="sd">          and can be used to identify the commit that shall be tagged, if</span>
<span class="sd">          not HEAD.</span>
<span class="sd">        options : list, optional</span>
<span class="sd">          Additional command options, inserted prior a potential `commit`</span>
<span class="sd">          argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: call in save.py complains about extensive logging. When does it</span>
        <span class="c1"># happen in what way? Figure out, whether to just silence it or raise or</span>
        <span class="c1"># whatever else.</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.get_tags"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_tags">[docs]</a>    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get list of tags</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output : str, optional</span>
<span class="sd">          If given, limit the return value to a list of values matching that</span>
<span class="sd">          particular key of the tag properties.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">          Each item is a dictionary with information on a tag. At present</span>
<span class="sd">          this includes &#39;hexsha&#39;, and &#39;name&#39;, where the latter is the string</span>
<span class="sd">          label of the tag, and the former the hexsha of the object the tag</span>
<span class="sd">          is attached to. The list is sorted by the creator date (committer</span>
<span class="sd">          date for lightweight tags and tagger date for annotated tags), with</span>
<span class="sd">          the most recent commit being the last element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">],</span>
                <span class="n">hexsha</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;objectname&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_each_ref_</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;refname:strip=2&#39;</span><span class="p">,</span> <span class="s1">&#39;objectname&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">],</span>
                <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;refs/tags&#39;</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;creatordate&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">output</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span></div>

<div class="viewcode-block" id="GitRepo.describe"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commitish</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Quick and dirty implementation to call git-describe</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs:</span>
<span class="sd">            transformed to cmdline options for git-describe;</span>
<span class="sd">            see __init__ for description of the transformation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: be more precise what failure to expect when and raise actual</span>
        <span class="c1"># errors</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;describe&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">to_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commitish</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commitish</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">describe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">expect_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">describe</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># TODO: WTF &quot;catch everything&quot;?</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GitRepo.get_tracking_branch"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_tracking_branch">[docs]</a>    <span class="k">def</span> <span class="nf">get_tracking_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remote_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the tracking branch for `branch` if there is any.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        branch: str</span>
<span class="sd">            local branch to look up. If none is given, active branch is used.</span>
<span class="sd">        remote_only : bool</span>
<span class="sd">            Don&#39;t return a value if the upstream remote is set to &quot;.&quot; (meaning</span>
<span class="sd">            this repository).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (remote or None, refspec or None) of the tracking branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_corresponding_branch</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_branch</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">track_remote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;branch.</span><span class="si">{0}</span><span class="s1">.remote&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remote_only</span> <span class="ow">and</span> <span class="n">track_remote</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">track_branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;branch.</span><span class="si">{0}</span><span class="s1">.merge&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">track_remote</span><span class="p">,</span> <span class="n">track_branch</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return dictionary with count, size(in KiB) information of git objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">count_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;count-objects&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span><span class="p">]</span>
        <span class="n">count_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span><span class="n">count_cmd</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">count_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">count</span>

<div class="viewcode-block" id="GitRepo.get_git_attributes"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_git_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_git_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query gitattributes which apply to top level directory</span>

<span class="sd">        It is a thin compatibility/shortcut wrapper around more versatile</span>
<span class="sd">        get_gitattributes which operates on a list of paths and returns</span>
<span class="sd">        a dictionary per each path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict:</span>
<span class="sd">          a dictionary with attribute name and value items relevant for the</span>
<span class="sd">          top (&#39;.&#39;) directory of the repository, and thus most likely the</span>
<span class="sd">          default ones (if not overwritten with more rules) for all files within</span>
<span class="sd">          repo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gitattributes</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="GitRepo.get_gitattributes"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_gitattributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_gitattributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">index_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query gitattributes for one or more paths</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: path or list</span>
<span class="sd">          Path(s) to query. Paths may be relative or absolute.</span>
<span class="sd">        index_only: bool</span>
<span class="sd">          Flag whether to consider only gitattribute setting that are reflected</span>
<span class="sd">          in the repository index, not just in the work tree content.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict:</span>
<span class="sd">          Each key is a queried path (always relative to the repository root),</span>
<span class="sd">          each value is a dictionary with attribute</span>
<span class="sd">          name and value items. Attribute values are either True or False,</span>
<span class="sd">          for set and unset attributes, or are the literal attribute value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">ensure_list</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;check-attr&quot;</span><span class="p">,</span> <span class="s2">&quot;-z&quot;</span><span class="p">,</span> <span class="s2">&quot;--all&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index_only</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--cached&#39;</span><span class="p">)</span>
        <span class="c1"># make sure we have one entry for each query path to</span>
        <span class="c1"># simplify work with the result</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">}</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_items_</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">,</span>
                                         <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># we have a full record</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> \
                <span class="kc">True</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;unset&#39;</span> <span class="k">else</span> <span class="n">value</span>
            <span class="c1"># done, reset item</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">relpath</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">isabs</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>

<div class="viewcode-block" id="GitRepo.set_gitattributes"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.set_gitattributes">[docs]</a>    <span class="k">def</span> <span class="nf">set_gitattributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">attrfile</span><span class="o">=</span><span class="s1">&#39;.gitattributes&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set gitattributes</span>

<span class="sd">        By default appends additional lines to `attrfile`. Note, that later</span>
<span class="sd">        lines in `attrfile` overrule earlier ones, which may or may not be</span>
<span class="sd">        what you want. Set `mode` to &#39;w&#39; to replace the entire file by</span>
<span class="sd">        what you provided in `attrs`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attrs : list</span>
<span class="sd">          Each item is a 2-tuple, where the first element is a path pattern,</span>
<span class="sd">          and the second element is a dictionary with attribute key/value</span>
<span class="sd">          pairs. The attribute dictionary must use the same semantics as those</span>
<span class="sd">          returned by `get_gitattributes()`. Path patterns can use absolute paths,</span>
<span class="sd">          in which case they will be normalized relative to the directory</span>
<span class="sd">          that contains the target .gitattributes file (see `attrfile`).</span>
<span class="sd">        attrfile: path</span>
<span class="sd">          Path relative to the repository root of the .gitattributes file the</span>
<span class="sd">          attributes shall be set in.</span>
<span class="sd">        mode: str</span>
<span class="sd">          &#39;a&#39; to append .gitattributes, &#39;w&#39; to replace it</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">git_attributes_file</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">attrfile</span><span class="p">)</span>
        <span class="n">attrdir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">git_attributes_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">attrdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">attrdir</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">git_attributes_file</span><span class="p">,</span> <span class="n">mode</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># for append, fix existing files that do not end with \n</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="c1"># normalize the pattern relative to the target .gitattributes file</span>
                <span class="n">npath</span> <span class="o">=</span> <span class="n">_normalize_path</span><span class="p">(</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">attrfile</span><span class="p">)),</span> <span class="n">pattern</span><span class="p">)</span>
                <span class="c1"># paths in gitattributes always have to be POSIX</span>
                <span class="n">npath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">npath</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
                <span class="n">attrline</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">npath</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
                    <span class="c1"># quote patterns with spaces</span>
                    <span class="n">attrline</span> <span class="o">+=</span> <span class="sa">u</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrline</span> <span class="o">+=</span> <span class="n">npath</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">attrline</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">attrline</span> <span class="o">+=</span> <span class="s1">&#39; -</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attrline</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrline</span><span class="p">))</span></div>

<div class="viewcode-block" id="GitRepo.get_content_info"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_content_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_content_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                         <span class="n">eval_file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get identifier and type information from repository content.</span>

<span class="sd">        This is simplified front-end for `git ls-files/tree`.</span>

<span class="sd">        Both commands differ in their behavior when queried about subdataset</span>
<span class="sd">        paths. ls-files will not report anything, ls-tree will report on the</span>
<span class="sd">        subdataset record. This function uniformly follows the behavior of</span>
<span class="sd">        ls-tree (report on the respective subdataset mount).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        paths : list(pathlib.PurePath) or None</span>
<span class="sd">          Specific paths, relative to the resolved repository root, to query</span>
<span class="sd">          info for. Paths must be normed to match the reporting done by Git,</span>
<span class="sd">          i.e. no parent dir components (ala &quot;some/../this&quot;).</span>
<span class="sd">          If `None`, info is reported for all content.</span>
<span class="sd">        ref : gitref or None</span>
<span class="sd">          If given, content information is retrieved for this Git reference</span>
<span class="sd">          (via ls-tree), otherwise content information is produced for the</span>
<span class="sd">          present work tree (via ls-files). With a given reference, the</span>
<span class="sd">          reported content properties also contain a &#39;bytesize&#39; record,</span>
<span class="sd">          stating the size of a file in bytes.</span>
<span class="sd">        untracked : {&#39;no&#39;, &#39;normal&#39;, &#39;all&#39;}</span>
<span class="sd">          If and how untracked content is reported when no `ref` was given:</span>
<span class="sd">          &#39;no&#39;: no untracked files are reported; &#39;normal&#39;: untracked files</span>
<span class="sd">          and entire untracked directories are reported as such; &#39;all&#39;: report</span>
<span class="sd">          individual files even in fully untracked directories.</span>
<span class="sd">        eval_file_type :</span>
<span class="sd">          THIS FUNCTIONALITY IS NO LONGER SUPPORTED.</span>
<span class="sd">          Setting this flag has no effect.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">          Each content item has an entry under a pathlib `Path` object instance</span>
<span class="sd">          pointing to its absolute path inside the repository (this path is</span>
<span class="sd">          guaranteed to be underneath `Repo.path`).</span>
<span class="sd">          Each value is a dictionary with properties:</span>

<span class="sd">          `type`</span>
<span class="sd">            Can be &#39;file&#39;, &#39;symlink&#39;, &#39;dataset&#39;, &#39;directory&#39;</span>

<span class="sd">          `gitshasum`</span>
<span class="sd">            SHASUM of the item as tracked by Git, or None, if not</span>
<span class="sd">            tracked. This could be different from the SHASUM of the file</span>
<span class="sd">            in the worktree, if it was modified.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">          In case of an invalid Git reference (e.g. &#39;HEAD&#39; in an empty</span>
<span class="sd">          repository)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.get_content_info(...)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eval_file_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;GitRepo.get_content_info(eval_file_type=) no longer supported&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="c1"># TODO limit by file type to replace code in subdatasets command</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">paths</span><span class="p">:</span>
            <span class="c1"># path matching will happen against what Git reports</span>
            <span class="c1"># and Git always reports POSIX paths</span>
            <span class="c1"># any incoming path has to be relative already, so we can simply</span>
            <span class="c1"># convert unconditionally</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span>

        <span class="n">path_strs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">paths</span><span class="p">))</span> <span class="k">if</span> <span class="n">paths</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">path_strs</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ref</span> <span class="ow">or</span> <span class="n">external_versions</span><span class="p">[</span><span class="s2">&quot;cmd:git&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;2.29.0&quot;</span><span class="p">):</span>
            <span class="c1"># If a path points within a submodule, we need to map it to the</span>
            <span class="c1"># containing submodule before feeding it to ls-files or ls-tree.</span>
            <span class="c1">#</span>
            <span class="c1"># Before Git 2.29.0, ls-tree and ls-files differed in how they</span>
            <span class="c1"># reported paths within submodules: ls-files provided no output,</span>
            <span class="c1"># and ls-tree listed the submodule. Now they both return no output.</span>
            <span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_submodules_</span><span class="p">()]</span>
            <span class="n">path_strs</span> <span class="o">=</span> <span class="n">get_parent_paths</span><span class="p">(</span><span class="n">path_strs</span><span class="p">,</span> <span class="n">submodules</span><span class="p">)</span>

        <span class="c1"># this will not work in direct mode, but everything else should be</span>
        <span class="c1"># just fine</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ref</span><span class="p">:</span>
            <span class="c1"># make sure no operations are pending before we figure things</span>
            <span class="c1"># out in the worktree</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">precommit</span><span class="p">()</span>

            <span class="c1"># --exclude-standard will make sure to honor and standard way</span>
            <span class="c1"># git can be instructed to ignore content, and will prevent</span>
            <span class="c1"># crap from contaminating untracked file reports</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ls-files&#39;</span><span class="p">,</span> <span class="s1">&#39;--stage&#39;</span><span class="p">,</span> <span class="s1">&#39;-z&#39;</span><span class="p">]</span>
            <span class="c1"># untracked report mode, using labels from `git diff` option style</span>
            <span class="k">if</span> <span class="n">untracked</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--exclude-standard&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">untracked</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--exclude-standard&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--directory&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-empty-directory&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">untracked</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;unknown value for `untracked`: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">untracked</span><span class="p">))</span>
            <span class="n">props_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="sa">r</span><span class="s1">&#39;(?P&lt;type&gt;[0-9]+) (?P&lt;sha&gt;.*) (.*)\t(?P&lt;fname&gt;.*)$&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ls-tree&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--full-tree&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">]</span>
            <span class="n">props_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="sa">r</span><span class="s1">&#39;(?P&lt;type&gt;[0-9]+) ([a-z]*) (?P&lt;sha&gt;[^ ]*) [\s]*(?P&lt;size&gt;[0-9-]+)\t(?P&lt;fname&gt;.*)$&#39;</span><span class="p">)</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Query repo: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">files</span><span class="o">=</span><span class="n">path_strs</span><span class="p">,</span>
                <span class="n">expect_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;fatal: Not a valid object name&quot;</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidGitReferenceError</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done query repo: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_content_info_line_helper</span><span class="p">(</span>
            <span class="n">ref</span><span class="p">,</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="n">props_re</span><span class="p">)</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done </span><span class="si">%s</span><span class="s1">.get_content_info(...)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span></div>

    <span class="k">def</span> <span class="nf">_get_content_info_line_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">props_re</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal helper of get_content_info() to parse Git output&quot;&quot;&quot;</span>
        <span class="n">mode_type_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;100644&#39;</span><span class="p">:</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
            <span class="s1">&#39;100755&#39;</span><span class="p">:</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
            <span class="s1">&#39;120000&#39;</span><span class="p">:</span> <span class="s1">&#39;symlink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;160000&#39;</span><span class="p">:</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">inf</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">props_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="p">:</span>
                <span class="c1"># Kludge: Filter out paths starting with .git/ to work around</span>
                <span class="c1"># an `ls-files -o` bug that was fixed in Git 2.25.</span>
                <span class="c1">#</span>
                <span class="c1"># TODO: Drop this condition when GIT_MIN_VERSION is at least</span>
                <span class="c1"># 2.25.</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.git/&quot;</span><span class="p">):</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Filtering out .git/ file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># not known to Git, but Git always reports POSIX</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># again Git reports always in POSIX</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">))</span>

            <span class="c1"># revisit the file props after this path has not been rejected</span>
            <span class="k">if</span> <span class="n">props</span><span class="p">:</span>
                <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;sha&#39;</span><span class="p">)</span>
                <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_type_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">props</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">),</span> <span class="n">props</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">ref</span> <span class="ow">and</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                    <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">))</span>

            <span class="c1"># join item path with repo path to get a universally useful</span>
            <span class="c1"># path representation with auto-conversion and tons of other</span>
            <span class="c1"># stuff</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">:</span>
                <span class="c1"># be nice and assign types for untracked content</span>
                <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;symlink&#39;</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> \
                    <span class="k">else</span> <span class="s1">&#39;directory&#39;</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;file&#39;</span>
            <span class="n">info</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">inf</span>

<div class="viewcode-block" id="GitRepo.status"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">eval_submodule_state</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simplified `git status` equivalent.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        paths : list or None</span>
<span class="sd">          If given, limits the query to the specified paths. To query all</span>
<span class="sd">          paths specify `None`, not an empty list. If a query path points</span>
<span class="sd">          into a subdataset, a report is made on the subdataset record</span>
<span class="sd">          within the queried dataset only (no recursion).</span>
<span class="sd">        untracked : {&#39;no&#39;, &#39;normal&#39;, &#39;all&#39;}</span>
<span class="sd">          If and how untracked content is reported:</span>
<span class="sd">          &#39;no&#39;: no untracked files are reported; &#39;normal&#39;: untracked files</span>
<span class="sd">          and entire untracked directories are reported as such; &#39;all&#39;: report</span>
<span class="sd">          individual files even in fully untracked directories.</span>
<span class="sd">        eval_submodule_state : {&#39;full&#39;, &#39;commit&#39;, &#39;no&#39;}</span>
<span class="sd">          If &#39;full&#39; (the default), the state of a submodule is evaluated by</span>
<span class="sd">          considering all modifications, with the treatment of untracked files</span>
<span class="sd">          determined by `untracked`. If &#39;commit&#39;, the modification check is</span>
<span class="sd">          restricted to comparing the submodule&#39;s HEAD commit to the one</span>
<span class="sd">          recorded in the superdataset. If &#39;no&#39;, the state of the subdataset is</span>
<span class="sd">          not evaluated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">          Each content item has an entry under a pathlib `Path` object instance</span>
<span class="sd">          pointing to its absolute path inside the repository (this path is</span>
<span class="sd">          guaranteed to be underneath `Repo.path`).</span>
<span class="sd">          Each value is a dictionary with properties:</span>

<span class="sd">          `type`</span>
<span class="sd">            Can be &#39;file&#39;, &#39;symlink&#39;, &#39;dataset&#39;, &#39;directory&#39;</span>
<span class="sd">          `state`</span>
<span class="sd">            Can be &#39;added&#39;, &#39;untracked&#39;, &#39;clean&#39;, &#39;deleted&#39;, &#39;modified&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Query status of </span><span class="si">%r</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> paths&#39;</span><span class="p">,</span>
                  <span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="k">if</span> <span class="n">paths</span> <span class="k">else</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffstatus</span><span class="p">(</span>
            <span class="n">fr</span><span class="o">=</span><span class="s1">&#39;HEAD&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hexsha</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
            <span class="n">untracked</span><span class="o">=</span><span class="n">untracked</span><span class="p">,</span>
            <span class="n">eval_submodule_state</span><span class="o">=</span><span class="n">eval_submodule_state</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.diff"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.diff">[docs]</a>    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
             <span class="n">eval_submodule_state</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like status(), but reports changes between to arbitrary revisions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fr : str or None</span>
<span class="sd">          Revision specification (anything that Git understands). Passing</span>
<span class="sd">          `None` considers anything in the target state as new.</span>
<span class="sd">        to : str or None</span>
<span class="sd">          Revision specification (anything that Git understands), or None</span>
<span class="sd">          to compare to the state of the work tree.</span>
<span class="sd">        paths : list or None</span>
<span class="sd">          If given, limits the query to the specified paths. To query all</span>
<span class="sd">          paths specify `None`, not an empty list.</span>
<span class="sd">        untracked : {&#39;no&#39;, &#39;normal&#39;, &#39;all&#39;}</span>
<span class="sd">          If and how untracked content is reported when `to` is None:</span>
<span class="sd">          &#39;no&#39;: no untracked files are reported; &#39;normal&#39;: untracked files</span>
<span class="sd">          and entire untracked directories are reported as such; &#39;all&#39;: report</span>
<span class="sd">          individual files even in fully untracked directories.</span>
<span class="sd">        eval_submodule_state : {&#39;full&#39;, &#39;commit&#39;, &#39;no&#39;}</span>
<span class="sd">          If &#39;full&#39; (the default), the state of a submodule is evaluated by</span>
<span class="sd">          considering all modifications, with the treatment of untracked files</span>
<span class="sd">          determined by `untracked`. If &#39;commit&#39;, the modification check is</span>
<span class="sd">          restricted to comparing the submodule&#39;s HEAD commit to the one</span>
<span class="sd">          recorded in the superdataset. If &#39;no&#39;, the state of the subdataset is</span>
<span class="sd">          not evaluated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">          Each content item has an entry under a pathlib `Path` object instance</span>
<span class="sd">          pointing to its absolute path inside the repository (this path is</span>
<span class="sd">          guaranteed to be underneath `Repo.path`).</span>
<span class="sd">          Each value is a dictionary with properties:</span>

<span class="sd">          `type`</span>
<span class="sd">            Can be &#39;file&#39;, &#39;symlink&#39;, &#39;dataset&#39;, &#39;directory&#39;</span>
<span class="sd">          `state`</span>
<span class="sd">            Can be &#39;added&#39;, &#39;untracked&#39;, &#39;clean&#39;, &#39;deleted&#39;, &#39;modified&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffstatus</span><span class="p">(</span>
            <span class="n">fr</span><span class="o">=</span><span class="n">fr</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
            <span class="n">untracked</span><span class="o">=</span><span class="n">untracked</span><span class="p">,</span>
            <span class="n">eval_submodule_state</span><span class="o">=</span><span class="n">eval_submodule_state</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;clean&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="GitRepo.diffstatus"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.diffstatus">[docs]</a>    <span class="k">def</span> <span class="nf">diffstatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                   <span class="n">eval_submodule_state</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">eval_file_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like diff(), but reports the status of &#39;clean&#39; content too.</span>

<span class="sd">        It supports an additional submodule evaluation state &#39;global&#39;.</span>
<span class="sd">        If given, it will return a single &#39;modified&#39;</span>
<span class="sd">        (vs. &#39;clean&#39;) state label for the entire repository, as soon as</span>
<span class="sd">        it can.</span>

<span class="sd">        The eval_file_type parameter is ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">eval_file_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;GitRepo.diffstatus(eval_file_type=) no longer supported&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_cache_key</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="k">if</span> <span class="n">paths</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> \
                <span class="n">ref</span><span class="p">,</span> <span class="n">untracked</span>

        <span class="k">if</span> <span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">paths</span><span class="p">:</span>
            <span class="c1"># at this point we must normalize paths to the form that</span>
            <span class="c1"># Git would report them, to easy matching later on</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">p</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">()</span> <span class="k">else</span> <span class="n">p</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span>
            <span class="p">]</span>

        <span class="c1"># TODO report more info from get_content_info() calls in return</span>
        <span class="c1"># value, those are cheap and possibly useful to a consumer</span>
        <span class="c1"># we need (at most) three calls to git</span>
        <span class="k">if</span> <span class="n">to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># everything we know about the worktree, including os.stat</span>
            <span class="c1"># for each file</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">_get_cache_key</span><span class="p">(</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_cache</span><span class="p">:</span>
                <span class="n">to_state</span> <span class="o">=</span> <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_info</span><span class="p">(</span>
                    <span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">untracked</span><span class="o">=</span><span class="n">untracked</span><span class="p">)</span>
                <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_state</span>
            <span class="c1"># we want Git to tell us what it considers modified and avoid</span>
            <span class="c1"># reimplementing logic ourselves</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">_get_cache_key</span><span class="p">(</span><span class="s1">&#39;mod&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_cache</span><span class="p">:</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># from Git 2.31.0 onwards ls-files has --deduplicate</span>
                <span class="c1"># by for backward compatibility keep doing deduplication here</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_git_items_</span><span class="p">(</span>
                        <span class="c1"># we must also look for deleted files, for the logic</span>
                        <span class="c1"># below to work. Only from Git 2.31.0 would they be</span>
                        <span class="c1"># included with `-m` alone</span>
                        <span class="p">[</span><span class="s1">&#39;ls-files&#39;</span><span class="p">,</span> <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">],</span>
                        <span class="c1"># low-level code cannot handle pathobjs</span>
                        <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span> <span class="k">if</span> <span class="n">paths</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">modified</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">_get_cache_key</span><span class="p">(</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_cache</span><span class="p">:</span>
                <span class="n">to_state</span> <span class="o">=</span> <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_info</span><span class="p">(</span><span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
                <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_state</span>
            <span class="c1"># we do not need worktree modification detection in this case</span>
            <span class="n">modified</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># origin state</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_cache_key</span><span class="p">(</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_cache</span><span class="p">:</span>
            <span class="n">from_state</span> <span class="o">=</span> <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fr</span><span class="p">:</span>
                <span class="n">from_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_info</span><span class="p">(</span><span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">fr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no ref means from nothing</span>
                <span class="n">from_state</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_state</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">to_state_r</span> <span class="ow">in</span> <span class="n">to_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diffstatus_get_state_props</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span>
                <span class="n">from_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">to_state_r</span><span class="p">,</span>
                <span class="c1"># are we comparing against a recorded commit or the worktree</span>
                <span class="n">to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="c1"># if we have worktree modification info, report if</span>
                <span class="c1"># path is reported as modified in it</span>
                <span class="n">modified</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">modified</span><span class="p">,</span>
                <span class="n">eval_submodule_state</span><span class="p">)</span>
            <span class="c1"># potential early exit in &quot;global&quot; eval mode</span>
            <span class="k">if</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span> <span class="ow">and</span> \
                    <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># any modification means globally &#39;modified&#39;</span>
                <span class="k">return</span> <span class="s1">&#39;modified&#39;</span>
            <span class="n">status</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>

        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">from_state_r</span> <span class="ow">in</span> <span class="n">from_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_state</span><span class="p">:</span>
                <span class="c1"># we new this, but now it is gone and Git is not complaining</span>
                <span class="c1"># about it being missing -&gt; properly deleted and deletion</span>
                <span class="c1"># stages</span>
                <span class="n">status</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">state</span><span class="o">=</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">from_state_r</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="c1"># report the shasum to distinguish from a plainly vanished</span>
                    <span class="c1"># file</span>
                    <span class="n">gitshasum</span><span class="o">=</span><span class="n">from_state_r</span><span class="p">[</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;modified&#39;</span>

        <span class="k">if</span> <span class="n">to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="c1"># if we have `to` we are specifically comparing against</span>
            <span class="c1"># a recorded state, and this function only attempts</span>
            <span class="c1"># to label the state of a subdataset, not investigate</span>
            <span class="c1"># specifically what the changes in subdatasets are</span>
            <span class="c1"># this is done by a high-level command like rev-diff</span>
            <span class="c1"># so the comparison within this repo and the present</span>
            <span class="c1"># `state` label are all we need, and they are done already</span>
            <span class="k">if</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;clean&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">status</span>

        <span class="c1"># loop over all subdatasets and look for additional modifications</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="n">st</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span>
                <span class="c1"># no business here</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">GitRepo</span><span class="o">.</span><span class="n">is_valid_repo</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="c1"># submodule is not present, no chance for a conflict</span>
                <span class="n">st</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;clean&#39;</span>
                <span class="k">continue</span>
            <span class="c1"># we have to recurse into the dataset and get its status</span>
            <span class="n">subrepo</span> <span class="o">=</span> <span class="n">repo_from_path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="c1"># get the HEAD commit, or the one of the corresponding branch</span>
            <span class="c1"># only that one counts re super-sub relationship</span>
            <span class="c1"># save() syncs the corresponding branch each time</span>
            <span class="n">subrepo_commit</span> <span class="o">=</span> <span class="n">subrepo</span><span class="o">.</span><span class="n">get_hexsha</span><span class="p">(</span><span class="n">subrepo</span><span class="o">.</span><span class="n">get_corresponding_branch</span><span class="p">())</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subrepo_commit</span>
            <span class="c1"># subdataset records must be labeled clean up to this point</span>
            <span class="c1"># test if current commit in subdataset deviates from what is</span>
            <span class="c1"># recorded in the dataset</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;modified&#39;</span> \
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;prev_gitshasum&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">subrepo_commit</span> \
                <span class="k">else</span> <span class="s1">&#39;clean&#39;</span>
            <span class="k">if</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span> <span class="ow">and</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;modified&#39;</span>
            <span class="k">if</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;commit&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># the recorded commit did not change, so we need to make</span>
            <span class="c1"># a more expensive traversal</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subrepo</span><span class="o">.</span><span class="n">diffstatus</span><span class="p">(</span>
                <span class="c1"># we can use &#39;HEAD&#39; because we know that the commit</span>
                <span class="c1"># did not change. using &#39;HEAD&#39; will facilitate</span>
                <span class="c1"># caching the result</span>
                <span class="n">fr</span><span class="o">=</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span>
                <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">untracked</span><span class="o">=</span><span class="n">untracked</span><span class="p">,</span>
                <span class="n">eval_submodule_state</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
                <span class="n">_cache</span><span class="o">=</span><span class="n">_cache</span><span class="p">)</span> <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;clean&#39;</span> <span class="k">else</span> <span class="s1">&#39;modified&#39;</span>
            <span class="k">if</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span> <span class="ow">and</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;modified&#39;</span>

        <span class="k">if</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;clean&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">status</span></div>

    <span class="k">def</span> <span class="nf">_diffstatus_get_state_props</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span><span class="p">,</span>
                                    <span class="n">against_commit</span><span class="p">,</span>
                                    <span class="n">modified_in_worktree</span><span class="p">,</span>
                                    <span class="n">eval_submodule_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to determine diff properties for a single path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : Path</span>
<span class="sd">        from_state : dict</span>
<span class="sd">        to_state : dict</span>
<span class="sd">        against_commit : bool</span>
<span class="sd">          Flag whether `to_state` reflects a commit or the worktree.</span>
<span class="sd">        modified_in_worktree : bool</span>
<span class="sd">          Flag whether a worktree modification is reported. This is ignored</span>
<span class="sd">          when `against_commit` is True.</span>
<span class="sd">        eval_submodule_state : {&#39;commit&#39;, &#39;no&#39;, ...}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">against_commit</span><span class="p">:</span>
            <span class="c1"># we can ignore any worktree modification reported when</span>
            <span class="c1"># comparing against a commit</span>
            <span class="n">modified_in_worktree</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">props</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">to_state</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

        <span class="n">to_sha</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">[</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">]</span>
        <span class="n">from_sha</span> <span class="o">=</span> <span class="n">from_state</span><span class="p">[</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">from_state</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># determine the state of `f` from from_state and to_state records, if</span>
        <span class="c1"># it can be determined conclusively from it. If not, it will</span>
        <span class="c1"># stay None for now</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_state</span><span class="p">:</span>
            <span class="c1"># this is new, or rather not known to the previous state</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;added&#39;</span> <span class="k">if</span> <span class="n">to_sha</span> <span class="k">else</span> <span class="s1">&#39;untracked&#39;</span>
        <span class="k">elif</span> <span class="n">to_sha</span> <span class="o">==</span> <span class="n">from_sha</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">modified_in_worktree</span><span class="p">:</span>
            <span class="c1"># something that is seemingly unmodified, based on the info</span>
            <span class="c1"># gathered so far</span>
            <span class="k">if</span> <span class="n">to_state</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">against_commit</span> <span class="ow">or</span> <span class="n">eval_submodule_state</span> <span class="o">==</span> <span class="s1">&#39;commit&#39;</span><span class="p">:</span>
                    <span class="c1"># we compare against a recorded state, just based on</span>
                    <span class="c1"># the shas we can be confident, otherwise the state</span>
                    <span class="c1"># of a subdataset isn&#39;t fully known yet, because</span>
                    <span class="c1"># `modified_in_worktree` will only reflect changes</span>
                    <span class="c1"># in the commit of a subdataset without looking into</span>
                    <span class="c1"># it for uncommitted changes. Such tests are done</span>
                    <span class="c1"># later and based on further conditionals for</span>
                    <span class="c1"># performance reasons</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;clean&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no change in git record, and no change on disk</span>
                <span class="c1"># at this point we know that the reported object ids</span>
                <span class="c1"># for this file are identical in the to and from</span>
                <span class="c1"># records.  If to is None, we&#39;re comparing to the</span>
                <span class="c1"># working tree and a deleted file will still have an</span>
                <span class="c1"># identical id, so we need to check whether the file is</span>
                <span class="c1"># gone before declaring it clean. This working tree</span>
                <span class="c1"># check is irrelevant and wrong if to is a ref.</span>
                <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;clean&#39;</span> \
                    <span class="k">if</span> <span class="n">against_commit</span> <span class="ow">or</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">())</span> \
                    <span class="k">else</span> <span class="s1">&#39;deleted&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># change in git record, or on disk</span>
            <span class="c1"># for subdatasets leave the &#39;modified&#39; judgement to the caller</span>
            <span class="c1"># for supporting corner cases, such as adjusted branch</span>
            <span class="c1"># which require inspection of a subdataset</span>
            <span class="c1"># TODO we could have a new file that is already staged</span>
            <span class="c1"># but had subsequent modifications done to it that are</span>
            <span class="c1"># unstaged. Such file would presently show up as &#39;added&#39;</span>
            <span class="c1"># ATM I think this is OK, but worth stating...</span>
            <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;modified&#39;</span>
                     <span class="k">if</span> <span class="n">against_commit</span> <span class="ow">or</span> <span class="n">to_state</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;dataset&#39;</span>
                     <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;deleted&#39;</span>
            <span class="c1"># TODO record before and after state for diff-like use</span>
            <span class="c1"># cases</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span> <span class="s1">&#39;added&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># assign present gitsha to any record</span>
            <span class="c1"># state==None can only happen for subdatasets that</span>
            <span class="c1"># already existed, so also assign a sha for them</span>
            <span class="n">props</span><span class="p">[</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_sha</span>
            <span class="k">if</span> <span class="s1">&#39;bytesize&#39;</span> <span class="ow">in</span> <span class="n">to_state</span><span class="p">:</span>
                <span class="c1"># if we got this cheap, report it</span>
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;clean&#39;</span> <span class="ow">and</span> <span class="s1">&#39;bytesize&#39;</span> <span class="ow">in</span> <span class="n">from_state</span><span class="p">:</span>
                <span class="c1"># no change, we can take this old size info</span>
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_state</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># assign previous gitsha to any record</span>
            <span class="c1"># state==None can only happen for subdatasets that</span>
            <span class="c1"># already existed, so also assign a sha for them</span>
            <span class="n">props</span><span class="p">[</span><span class="s1">&#39;prev_gitshasum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_sha</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="c1"># only report a state if we could determine any</span>
            <span class="c1"># outside code tests for existence of the property</span>
            <span class="c1"># and not (always) for the value</span>
            <span class="n">props</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">props</span>

    <span class="k">def</span> <span class="nf">_save_pre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">_status</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># helper to get an actionable status report</span>
        <span class="k">if</span> <span class="n">paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">paths</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_status</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;untracked&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;untracked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">(</span>
                <span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
                <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span>
                   <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;untracked&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_submodule_state&#39;</span><span class="p">)})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we want to be able to add items down the line</span>
            <span class="c1"># make sure to detach from prev. owner</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">_status</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;clean&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span>

<div class="viewcode-block" id="GitRepo.get_staged_paths"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.get_staged_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_staged_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of any stage repository path(s)</span>

<span class="sd">        This is a rather fast call, as it will not depend on what is going on</span>
<span class="sd">        in the worktree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call_git_items_</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="s1">&#39;--name-only&#39;</span><span class="p">,</span> <span class="s1">&#39;--staged&#39;</span><span class="p">],</span>
                <span class="n">expect_stderr</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">CapturedException</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">_save_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">partial_commit</span><span class="p">,</span> <span class="n">amend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># helper to commit changes reported in status</span>

        <span class="c1"># TODO remove pathobj stringification when commit() can</span>
        <span class="c1"># handle it</span>
        <span class="n">to_commit</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span> \
                    <span class="k">if</span> <span class="n">partial_commit</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">partial_commit</span> <span class="ow">or</span> <span class="n">to_commit</span> <span class="ow">or</span> <span class="n">allow_empty</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">amend</span> <span class="ow">and</span> <span class="n">message</span><span class="p">):</span>
            <span class="c1"># we directly call GitRepo.commit() to avoid a whole slew</span>
            <span class="c1"># if direct-mode safeguards and workarounds in the AnnexRepo</span>
            <span class="c1"># implementation (which also run an additional dry-run commit</span>
            <span class="n">GitRepo</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">files</span><span class="o">=</span><span class="n">to_commit</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="n">to_options</span><span class="p">(</span><span class="n">amend</span><span class="o">=</span><span class="n">amend</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="n">allow_empty</span><span class="p">),</span>
                <span class="c1"># do not raise on empty commit</span>
                <span class="c1"># it could be that the `add` in this save-cycle has already</span>
                <span class="c1"># brought back a &#39;modified&#39; file into a clean state</span>
                <span class="n">careless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="GitRepo.save"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save dataset content.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : str or None</span>
<span class="sd">          A message to accompany the changeset in the log. If None,</span>
<span class="sd">          a default message is used.</span>
<span class="sd">        paths : list or None</span>
<span class="sd">          Any content with path matching any of the paths given in this</span>
<span class="sd">          list will be saved. Matching will be performed against the</span>
<span class="sd">          dataset status (GitRepo.status()), or a custom status provided</span>
<span class="sd">          via `_status`. If no paths are provided, ALL non-clean paths</span>
<span class="sd">          present in the repo status or `_status` will be saved.</span>
<span class="sd">        _status : dict or None</span>
<span class="sd">          If None, Repo.status() will be queried for the given `ds`. If</span>
<span class="sd">          a dict is given, its content will be used as a constraint.</span>
<span class="sd">          For example, to save only modified content, but no untracked</span>
<span class="sd">          content, set `paths` to None and provide a `_status` that has</span>
<span class="sd">          no entries for untracked content.</span>
<span class="sd">        **kwargs :</span>
<span class="sd">          Additional arguments that are passed to underlying Repo methods.</span>
<span class="sd">          Supported:</span>

<span class="sd">          - git : bool (passed to Repo.add()</span>
<span class="sd">          - eval_submodule_state : {&#39;full&#39;, &#39;commit&#39;, &#39;no&#39;}</span>
<span class="sd">            passed to Repo.status()</span>
<span class="sd">          - untracked : {&#39;no&#39;, &#39;normal&#39;, &#39;all&#39;} - passed to Repo.status()</span>
<span class="sd">          - amend : bool (passed to GitRepo.commit)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                <span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
                <span class="n">_status</span><span class="o">=</span><span class="n">_status</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GitRepo.save_"><a class="viewcode-back" href="../../../generated/datalad.support.gitrepo.html#datalad.support.gitrepo.GitRepo.save_">[docs]</a>    <span class="k">def</span> <span class="nf">save_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like `save()` but working as a generator.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">datalad.interface.results</span> <span class="kn">import</span> <span class="n">get_status_dict</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pre</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">_status</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">amend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amend&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">message</span> <span class="ow">and</span> <span class="n">amend</span><span class="p">):</span>
            <span class="c1"># all clean, nothing todo</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Nothing to save in </span><span class="si">%r</span><span class="s1">, exiting early&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># three things are to be done:</span>
        <span class="c1"># - remove (deleted if not already staged)</span>
        <span class="c1"># - add (modified/untracked)</span>
        <span class="c1"># - commit (with all paths that have been touched, to bypass</span>
        <span class="c1">#   potential pre-staged bits)</span>

        <span class="n">need_partial_commit</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_staged_paths</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="c1"># remove first, because removal of a subds would cause a</span>
        <span class="c1"># modification of .gitmodules to be added to the todo list</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># TODO remove pathobj stringification when delete() can</span>
            <span class="c1"># handle it</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span> <span class="ow">and</span>
            <span class="c1"># staged deletions have a gitshasum reported for them</span>
            <span class="c1"># those should not be processed as git rm will error</span>
            <span class="c1"># due to them being properly gone already</span>
            <span class="ow">not</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gitshasum&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="n">vanished_subds</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;dataset&#39;</span> <span class="ow">and</span>
            <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
                    <span class="n">to_remove</span><span class="p">,</span>
                    <span class="c1"># we would always see individual files</span>
                    <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="c1"># TODO normalize result</span>
                <span class="k">yield</span> <span class="n">get_status_dict</span><span class="p">(</span>
                    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                    <span class="n">refds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">,</span>
                    <span class="c1"># TODO make remove() report the type</span>
                    <span class="c1"># for now it claims to report on files only</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="n">ut</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">r</span><span class="p">)),</span>
                    <span class="c1"># make remove() report on failures too</span>
                    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="n">lgr</span><span class="p">)</span>

        <span class="c1"># TODO this additional query should not be, base on status as given</span>
        <span class="c1"># if anyhow possible, however, when paths are given, status may</span>
        <span class="c1"># not contain all required information. In case of path=None AND</span>
        <span class="c1"># _status=None, we should be able to avoid this, because</span>
        <span class="c1"># status should have the full info already</span>
        <span class="c1"># looks for contained repositories</span>
        <span class="n">submodule_change</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">untracked_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;untracked&#39;</span> <span class="ow">and</span>
                          <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span><span class="p">]</span>
        <span class="n">to_add_submodules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">untracked_dirs</span><span class="p">:</span>
            <span class="n">to_add_submodules</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sm</span> <span class="k">for</span> <span class="n">sm</span><span class="p">,</span> <span class="n">sm_props</span> <span class="ow">in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_content_info</span><span class="p">(</span>
                    <span class="n">untracked_dirs</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="c1"># request exhaustive list, so that everything that is</span>
                    <span class="c1"># still reported as a directory must be its own repository</span>
                    <span class="n">untracked</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sm_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span><span class="p">]</span>
            <span class="n">to_add_submodules</span> <span class="o">=</span> <span class="n">_prune_deeper_repos</span><span class="p">(</span><span class="n">to_add_submodules</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">to_add_submodules</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_add_submodules</span><span class="p">(</span><span class="n">to_add_submodules</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ok&#39;</span><span class="p">:</span>
                        <span class="n">submodule_change</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">yield</span> <span class="n">r</span>
        <span class="n">to_stage_submodules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">f</span><span class="p">:</span> <span class="n">props</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;modified&#39;</span><span class="p">,</span> <span class="s1">&#39;untracked&#39;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;dataset&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">to_stage_submodules</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> submodule path(s) to stage in </span><span class="si">%r</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">to_stage_submodules</span><span class="p">),</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">to_stage_submodules</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_stage_submodules</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_add_submodules</span><span class="p">(</span><span class="n">to_stage_submodules</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ok&#39;</span><span class="p">:</span>
                    <span class="n">submodule_change</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">yield</span> <span class="n">r</span>

        <span class="k">if</span> <span class="n">submodule_change</span> <span class="ow">or</span> <span class="n">vanished_subds</span><span class="p">:</span>
            <span class="c1"># the config has changed too</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
            <span class="c1"># need to include .gitmodules in what needs saving</span>
            <span class="n">status</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.gitmodules&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;modified&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;annexstatus&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="c1"># we cannot simply hook into the coming add-call</span>
                <span class="c1"># as this would go to annex, so make a dedicted git-add</span>
                <span class="c1"># call to ensure .gitmodules is not annexed</span>
                <span class="c1"># in any normal DataLad dataset .gitattributes will</span>
                <span class="c1"># prevent this, but in a plain repo it won&#39;t</span>
                <span class="c1"># https://github.com/datalad/datalad/issues/3306</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">GitRepo</span><span class="o">.</span><span class="n">_save_add</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="p">{</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;.gitmodules&#39;</span><span class="p">):</span> <span class="kc">None</span><span class="p">}):</span>
                    <span class="k">yield</span> <span class="n">r</span>
        <span class="n">to_add</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># TODO remove pathobj stringification when add() can</span>
            <span class="c1"># handle it</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">)):</span> <span class="n">props</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;modified&#39;</span><span class="p">,</span> <span class="s1">&#39;untracked&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">to_add_submodules</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_stage_submodules</span><span class="p">))}</span>
        <span class="k">if</span> <span class="n">to_add</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> path(s) to add to </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">to_add</span><span class="p">),</span> <span class="bp">self</span><span class="p">,</span> <span class="n">to_add</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_add</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_add</span><span class="p">(</span>
                    <span class="n">to_add</span><span class="p">,</span>
                    <span class="n">git_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span>
                       <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;git&#39;</span><span class="p">,)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;annexstatus&#39;</span><span class="p">)</span>
                                <span class="k">else</span> <span class="nb">tuple</span><span class="p">())}):</span>
                <span class="k">yield</span> <span class="n">r</span>

        <span class="c1"># Note, that allow_empty is always ok when we amend. Required when we</span>
        <span class="c1"># amend an empty commit while the amendment is empty, too (though</span>
        <span class="c1"># possibly different message). If an empty commit was okay before, it&#39;s</span>
        <span class="c1"># okay now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_post</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">need_partial_commit</span><span class="p">,</span> <span class="n">amend</span><span class="o">=</span><span class="n">amend</span><span class="p">,</span>
                        <span class="n">allow_empty</span><span class="o">=</span><span class="n">amend</span><span class="p">)</span></div>
        <span class="c1"># TODO yield result for commit, prev helper checked hexsha pre</span>
        <span class="c1"># and post...</span>

    <span class="k">def</span> <span class="nf">_save_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">git_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple helper to add files in save()&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">datalad.interface.results</span> <span class="kn">import</span> <span class="n">get_status_dict</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># without --verbose git 2.9.3  add does not return anything</span>
            <span class="n">add_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_git</span><span class="p">(</span>
                <span class="c1"># Set annex.largefiles to prevent storing files in</span>
                <span class="c1"># annex with a v6+ annex repo.</span>
                <span class="p">[</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;annex.largefiles=nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">ensure_list</span><span class="p">(</span><span class="n">git_opts</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;--verbose&#39;</span><span class="p">],</span>
                <span class="n">files</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="p">)</span>
            <span class="c1"># get all the entries</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_git_get_output</span><span class="p">(</span><span class="o">*</span><span class="n">add_out</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">get_status_dict</span><span class="p">(</span>
                    <span class="n">action</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">),</span>
                    <span class="n">refds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="n">ut</span><span class="o">.</span><span class="n">PurePosixPath</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ok&#39;</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="c1"># while there is no git-annex underneath here, we</span>
                    <span class="c1"># tend to fake its behavior, so we can also support</span>
                    <span class="c1"># this type of messaging</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;error-messages&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;error-messages&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="n">lgr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;add: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_save_add_submodules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add new submodules, or updates records of existing ones</span>

<span class="sd">        This method does not use `git submodule add`, but aims to be more</span>
<span class="sd">        efficient by limiting the scope to mere in-place registration of</span>
<span class="sd">        multiple already present repositories.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        paths : list(Path)</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        dict</span>
<span class="sd">          Result records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">datalad.interface.results</span> <span class="kn">import</span> <span class="n">get_status_dict</span>

        <span class="c1"># first gather info from all datasets in read-only fashion, and then</span>
        <span class="c1"># update index, .gitmodules and .git/config at once</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">rpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">subm</span> <span class="o">=</span> <span class="n">repo_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c1"># if there is a corresponding branch, we want to record it&#39;s state.</span>
            <span class="c1"># we rely on the corresponding branch being synced already.</span>
            <span class="c1"># `save` should do that each time it runs.</span>
            <span class="n">subm_commit</span> <span class="o">=</span> <span class="n">subm</span><span class="o">.</span><span class="n">get_hexsha</span><span class="p">(</span><span class="n">subm</span><span class="o">.</span><span class="n">get_corresponding_branch</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">subm_commit</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">get_status_dict</span><span class="p">(</span>
                    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;add_submodule&#39;</span><span class="p">,</span>
                    <span class="n">ds</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;cannot add subdataset </span><span class="si">%s</span><span class="s1"> with no commits&#39;</span><span class="p">,</span> <span class="n">subm</span><span class="p">),</span>
                    <span class="n">logger</span><span class="o">=</span><span class="n">lgr</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># make an attempt to configure a submodule source URL based on the</span>
            <span class="c1"># discovered remote configuration</span>
            <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="n">subm</span><span class="o">.</span><span class="n">get_tracking_branch</span><span class="p">()</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">subm</span><span class="o">.</span><span class="n">get_remote_url</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span> <span class="k">if</span> <span class="n">remote</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;./</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rpath</span><span class="p">)</span>
            <span class="n">subm_id</span> <span class="o">=</span> <span class="n">subm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datalad.dataset.id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                     <span class="c1"># if we have additional information on this path, pass it on.</span>
                     <span class="c1"># if not, treat it as an untracked directory</span>
                     <span class="n">paths</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                     <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;untracked&#39;</span><span class="p">),</span>
                     <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">rpath</span><span class="o">=</span><span class="n">rpath</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">subm_commit</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">subm_id</span><span class="p">,</span>
                     <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">))</span>

        <span class="c1"># bypass any convenience or safe-manipulator for speed reasons</span>
        <span class="c1"># use case: saving many new subdatasets in a single run</span>
        <span class="k">with</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;.gitmodules&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gmf</span><span class="p">,</span> \
             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span> <span class="o">/</span> <span class="s1">&#39;.git&#39;</span> <span class="o">/</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gcf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                <span class="c1"># we update the subproject commit unconditionally</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">call_git</span><span class="p">([</span>
                    <span class="s1">&#39;update-index&#39;</span><span class="p">,</span> <span class="s1">&#39;--add&#39;</span><span class="p">,</span> <span class="s1">&#39;--replace&#39;</span><span class="p">,</span> <span class="s1">&#39;--cacheinfo&#39;</span><span class="p">,</span> <span class="s1">&#39;160000&#39;</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;rpath&#39;</span><span class="p">]</span>
                <span class="p">])</span>
                <span class="c1"># only write the .gitmodules/.config changes when this is not yet</span>
                <span class="c1"># a subdataset</span>
                <span class="c1"># TODO: we could update the URL, and branch info at this point,</span>
                <span class="c1"># even for previously registered subdatasets</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span>
                    <span class="n">gmprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;rpath&#39;</span><span class="p">],</span> <span class="n">url</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
                        <span class="n">gmprops</span><span class="p">[</span><span class="s1">&#39;datalad-id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="n">write_config_section</span><span class="p">(</span>
                        <span class="n">gmf</span><span class="p">,</span> <span class="s1">&#39;submodule&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;rpath&#39;</span><span class="p">],</span> <span class="n">gmprops</span><span class="p">)</span>
                    <span class="n">write_config_section</span><span class="p">(</span>
                        <span class="n">gcf</span><span class="p">,</span> <span class="s1">&#39;submodule&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;rpath&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]))</span>

                <span class="c1"># This mirrors the result structure yielded for</span>
                <span class="c1"># to_stage_submodules below.</span>
                <span class="k">yield</span> <span class="n">get_status_dict</span><span class="p">(</span>
                    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span>
                    <span class="n">refds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pathobj</span><span class="p">,</span>
                    <span class="c1"># should become type=&#39;dataset&#39;</span>
                    <span class="c1"># https://github.com/datalad/datalad/pull/4793#discussion_r464515331</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
                    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="n">lgr</span><span class="p">)</span></div>


<span class="c1"># used in in the get command and GitRepo.add_submodule(), the</span>
<span class="c1"># latter is not used outside the tests</span>
<span class="k">def</span> <span class="nf">_fixup_submodule_dotgit_setup</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">relativepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of our current of .git in a subdataset</span>

<span class="sd">    Each subdataset/module has its own .git directory where a standalone</span>
<span class="sd">    repository would have it. No gitdir files, no symlinks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># move .git to superrepo&#39;s .git/modules, remove .git, create</span>
    <span class="c1"># .git-file</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">relativepath</span><span class="p">)</span>
    <span class="n">subds_dotgit</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span><span class="p">)</span>

    <span class="n">repo</span> <span class="o">=</span> <span class="n">GitRepo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">dot_git</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">repo</span><span class="o">.</span><span class="n">pathobj</span><span class="p">:</span>
        <span class="c1"># this is what we want</span>
        <span class="k">return</span>

    <span class="c1"># first we want to remove any conflicting worktree setup</span>
    <span class="c1"># done by git to find the checkout at the mountpoint of the</span>
    <span class="c1"># submodule, if we keep that, any git command will fail</span>
    <span class="c1"># after we move .git</span>
    <span class="c1"># Ben: Shouldn&#39;t we re-setup a possible worktree afterwards?</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="s1">&#39;core.worktree&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
    <span class="c1"># what we have here is some kind of reference, remove and</span>
    <span class="c1"># replace by the target</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subds_dotgit</span><span class="p">)</span>
    <span class="c1"># make absolute</span>
    <span class="n">src_dotgit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">dot_git</span><span class="p">)</span>
    <span class="c1"># move .git</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">rename</span><span class="p">,</span> <span class="n">listdir</span><span class="p">,</span> <span class="n">rmdir</span>
    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">subds_dotgit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dot_git_entry</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">src_dotgit</span><span class="p">):</span>
        <span class="n">rename</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">src_dotgit</span><span class="p">,</span> <span class="n">dot_git_entry</span><span class="p">),</span>
               <span class="n">opj</span><span class="p">(</span><span class="n">subds_dotgit</span><span class="p">,</span> <span class="n">dot_git_entry</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">listdir</span><span class="p">(</span><span class="n">src_dotgit</span><span class="p">)</span>
    <span class="n">rmdir</span><span class="p">(</span><span class="n">src_dotgit</span><span class="p">)</span>


<span class="c1"># try retro-fitting GitRepo with deprecated functionality</span>
<span class="c1"># must be done last in this file</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">datalad_deprecated.gitrepo</span> <span class="kn">import</span> <span class="n">DeprecatedGitRepoMethods</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">DeprecatedGitRepoMethods</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
            <span class="c1"># ignore Python internals</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">GitRepo</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Not retro-fitted GitRepo with deprecated </span><span class="si">%s</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;name-space conflict&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="c1"># do not override existing symbols</span>
            <span class="k">continue</span>
        <span class="c1"># assign deprecated symbol to GitRepo</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">GitRepo</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">DeprecatedGitRepoMethods</span><span class="p">,</span> <span class="n">symbol</span><span class="p">))</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Retro-fitted GitRepo with deprecated </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">ce</span> <span class="o">=</span> <span class="n">CapturedException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;Not retro-fitting GitRepo with deprecated symbols, &#39;</span>
        <span class="s1">&#39;datalad-deprecated package not found&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, DataLad team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>